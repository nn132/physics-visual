<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地测试 - 数据格式验证</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🧪 前后端数据格式测试</h1>
    
    <div class="test-section">
        <h2>测试 1: 当前 Worker 返回格式（未部署新版本）</h2>
        <button onclick="testOldFormat()">测试旧格式</button>
        <div id="result1"></div>
    </div>

    <div class="test-section">
        <h2>测试 2: 修复后的 Worker 返回格式（新版本）</h2>
        <button onclick="testNewFormat()">测试新格式</button>
        <div id="result2"></div>
    </div>

    <div class="test-section">
        <h2>测试 3: 实际调用 Worker API</h2>
        <input type="text" id="testInput" placeholder="输入测试题目" value="一个物体从静止开始自由下落5秒" style="width: 100%; padding: 8px; margin-bottom: 10px;">
        <button onclick="testRealAPI()">调用真实 API</button>
        <div id="result3"></div>
    </div>

    <script>
        const BACKEND_PATH = 'https://physics-visual-worker.yywf08125.workers.dev/api/parse-problem';

        // 模拟旧格式返回（当前线上版本）
        function testOldFormat() {
            const oldResponse = {
                ok: true,
                raw: "MOCK",
                parsed: {
                    type: "uniform",
                    params: { time: 2, g: 10, v0: 0 },
                    reasoning: "Defaulted to free-fall mock."
                }
            };

            const result1 = document.getElementById('result1');
            result1.innerHTML = '<h3>旧格式数据：</h3><pre>' + JSON.stringify(oldResponse, null, 2) + '</pre>';
            
            // 测试前端处理
            if (oldResponse.success) {
                result1.innerHTML += '<div class="success">✓ 前端会识别为成功</div>';
            } else {
                result1.innerHTML += '<div class="error">✗ 前端会识别为失败（因为没有 success 字段）</div>';
                result1.innerHTML += '<p><strong>问题：</strong>前端期望 result.success 为 true</p>';
            }
        }

        // 模拟新格式返回（修复后版本）
        function testNewFormat() {
            const newResponse = {
                success: true,
                type: "uniform",
                params: { v0: 0, a: 10, time: 5 },
                reasoning: "默认为自由落体（匀变速直线运动）。"
            };

            const result2 = document.getElementById('result2');
            result2.innerHTML = '<h3>新格式数据：</h3><pre>' + JSON.stringify(newResponse, null, 2) + '</pre>';
            
            // 测试前端处理
            if (newResponse.success) {
                result2.innerHTML += '<div class="success">✓ 前端会识别为成功</div>';
                result2.innerHTML += '<p><strong>类型：</strong>' + newResponse.type + '</p>';
                result2.innerHTML += '<p><strong>参数：</strong>' + JSON.stringify(newResponse.params) + '</p>';
                result2.innerHTML += '<p><strong>说明：</strong>' + newResponse.reasoning + '</p>';
            } else {
                result2.innerHTML += '<div class="error">✗ 前端会识别为失败</div>';
            }
        }

        // 测试真实 API
        async function testRealAPI() {
            const result3 = document.getElementById('result3');
            const testInput = document.getElementById('testInput').value;
            
            result3.innerHTML = '<p>正在调用 API...</p>';
            
            try {
                const response = await fetch(BACKEND_PATH, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: testInput })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                result3.innerHTML = '<h3>实际 API 返回：</h3><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                // 检查格式
                if (data.success !== undefined) {
                    result3.innerHTML += '<div class="success">✓ 使用新格式（有 success 字段）</div>';
                    if (data.success) {
                        result3.innerHTML += '<p><strong>状态：</strong>解析成功</p>';
                        result3.innerHTML += '<p><strong>类型：</strong>' + data.type + '</p>';
                        result3.innerHTML += '<p><strong>参数：</strong>' + JSON.stringify(data.params) + '</p>';
                    }
                } else if (data.ok !== undefined) {
                    result3.innerHTML += '<div class="error">✗ 使用旧格式（有 ok 字段）</div>';
                    result3.innerHTML += '<p><strong>问题：</strong>Worker 还未部署新版本，需要运行 <code>wrangler deploy</code></p>';
                    result3.innerHTML += '<p><strong>原因：</strong>前端代码检查 result.success，但 API 返回 result.ok</p>';
                }
                
            } catch (error) {
                result3.innerHTML += '<div class="error">✗ API 调用失败</div>';
                result3.innerHTML += '<p><strong>错误：</strong>' + error.message + '</p>';
            }
        }

        // 页面加载时自动运行测试
        window.onload = function() {
            testOldFormat();
            testNewFormat();
        };
    </script>
</body>
</html>
