<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaTeX æ¸²æŸ“æµ‹è¯• - AIåŠ©æ‰‹ä¼˜åŒ–</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <link rel="stylesheet" href="ai-assistant.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f7fa;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #2d3748;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 8px;
    }
    .test-case {
      margin: 12px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .test-label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 6px;
    }
    .test-result {
      padding: 12px;
      border-radius: 8px;
      background: white;
      min-height: 40px;
      line-height: 1.6;
    }
    .info-box {
      background: #edf2f7;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #667eea;
    }
    .success {
      background: #f0fff4;
      border-left-color: #48bb78;
    }
    .warning {
      background: #fffaf0;
      border-left-color: #ed8936;
    }
    code {
      background: #2d3748;
      color: #e2e8f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center; color: #2d3748; margin-bottom: 30px;">
    ğŸ§ª LaTeX å…¬å¼æ¸²æŸ“æµ‹è¯• - AIåŠ©æ‰‹ä¼˜åŒ–ç‰ˆ
  </h1>

  <div class="info-box">
    <h3 style="margin-top: 0;">âœ¨ ä¼˜åŒ–å†…å®¹</h3>
    <ul style="margin: 8px 0; padding-left: 20px;">
      <li><strong>æµå¼æ¸²æŸ“é˜²æŠ–</strong>ï¼šé¿å…å…¬å¼ä¸å®Œæ•´æ—¶é¢‘ç¹æ¸²æŸ“ï¼ˆ100msé˜²æŠ–ï¼‰</li>
      <li><strong>å…¬å¼å®Œæ•´æ€§æ£€æŸ¥</strong>ï¼šæ£€æµ‹æ‹¬å·åŒ¹é…ã€æœªå®Œæˆå‘½ä»¤ï¼Œæµå¼æ—¶è·³è¿‡ä¸å®Œæ•´å…¬å¼</li>
      <li><strong>é”™è¯¯å¤„ç†å¢å¼º</strong>ï¼šæ¸²æŸ“å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½æç¤ºï¼Œè€Œéç©ºç™½</li>
      <li><strong>å ä½ç¬¦æ›¿æ¢ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ split().join() ä»£æ›¿æ­£åˆ™ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜</li>
      <li><strong>é‡‘é¢è¿‡æ»¤</strong>ï¼šé¿å…å°† $100 è¿™æ ·çš„é‡‘é¢è¯¯è¯†åˆ«ä¸ºå…¬å¼</li>
      <li><strong>Markdownæ”¹è¿›</strong>ï¼šæ›´å®‰å…¨çš„åˆ—è¡¨å’Œæ¢è¡Œå¤„ç†ï¼Œé¿å…ç ´åå ä½ç¬¦</li>
    </ul>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ“ æµ‹è¯•ç”¨ä¾‹ 1ï¼šåŸºç¡€ç‰©ç†å…¬å¼</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>ç‰›é¡¿ç¬¬äºŒå®šå¾‹ï¼š$F = ma$ï¼ŒåŠ¨èƒ½å…¬å¼ï¼š$E_k = \frac{1}{2}mv^2$</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test1"></div>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ”¬ æµ‹è¯•ç”¨ä¾‹ 2ï¼šå—çº§å…¬å¼</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>èƒ½é‡å®ˆæ’å®šå¾‹ï¼š$$E = mc^2$$</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test2"></div>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">âš›ï¸ æµ‹è¯•ç”¨ä¾‹ 3ï¼šå¤æ‚å…¬å¼ï¼ˆåˆ†å¼ã€æ ¹å·ã€ä¸Šä¸‹æ ‡ï¼‰</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>äºŒæ¬¡å…¬å¼ï¼š$$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test3"></div>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ’° æµ‹è¯•ç”¨ä¾‹ 4ï¼šé‡‘é¢è¿‡æ»¤ï¼ˆä¸åº”è¢«è¯†åˆ«ä¸ºå…¬å¼ï¼‰</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>è¿™æœ¬ä¹¦ä»·æ ¼æ˜¯ $100ï¼Œå¦ä¸€æœ¬æ˜¯ $50.99</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test4"></div>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ“ æµ‹è¯•ç”¨ä¾‹ 5ï¼šMarkdown + LaTeXæ··åˆ</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>## ç‰©ç†å…¬å¼
**åŠ›çš„å®šä¹‰**ï¼š$F = ma$
- åŠ é€Ÿåº¦ $a$
- è´¨é‡ $m$

å…¬å¼æ¨å¯¼ï¼š
$$v^2 = v_0^2 + 2as$$</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test5"></div>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">âš ï¸ æµ‹è¯•ç”¨ä¾‹ 6ï¼šé”™è¯¯å¤„ç†ï¼ˆæ•…æ„çš„é”™è¯¯å…¬å¼ï¼‰</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>é”™è¯¯å…¬å¼ï¼š$\frac{1}{2$ ï¼ˆç¼ºå°‘é—­åˆæ‹¬å·ï¼‰</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test6"></div>
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ¯ æµ‹è¯•ç”¨ä¾‹ 7ï¼šå¤šè¡Œå…¬å¼</div>
    <div class="test-case">
      <div class="test-label">è¾“å…¥æ–‡æœ¬ï¼š</div>
      <code>$$
\begin{aligned}
E &= mc^2 \\
p &= mv \\
F &= ma
\end{aligned}
$$</code>
      <div class="test-label" style="margin-top: 12px;">æ¸²æŸ“ç»“æœï¼š</div>
      <div class="test-result" id="test7"></div>
    </div>
  </div>

  <div class="info-box success" style="margin-top: 30px;">
    <h3 style="margin-top: 0;">âœ… ä½¿ç”¨æ–¹æ³•</h3>
    <p>åœ¨ AI åŠ©æ‰‹åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š</p>
    <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow-x: auto;">
const { assistant, ui } = initAIAssistant('your-api-key', {
  debug: true  // å¯ç”¨è°ƒè¯•æ—¥å¿—
});</pre>
  </div>

  <script src="ai-assistant.js"></script>
  <script>
    // æ¨¡æ‹Ÿ AIAssistantUI çš„æ¸²æŸ“æ–¹æ³•
    class TestRenderer {
      renderContent(element, content, isFinal = true) {
        let processed = content;
        const latexBlocks = [];
        const latexInline = [];
        
        // å—çº§å…¬å¼
        processed = processed.replace(/\$\$[\s\S]*?\$\$/g, (match) => {
          const formula = match.slice(2, -2).trim();
          if (!formula) return match;
          
          if (!isFinal && !this.isCompleteLatex(formula)) {
            return match;
          }
          
          try {
            const rendered = katex.renderToString(formula, { 
              throwOnError: false,
              displayMode: true,
              strict: false,
              trust: true
            });
            const placeholder = `___LATEX_BLOCK_${latexBlocks.length}___`;
            latexBlocks.push(rendered);
            return placeholder;
          } catch (e) {
            console.warn('LaTeXå—çº§å…¬å¼æ¸²æŸ“å¤±è´¥:', formula, e);
            return `<span class="latex-error" title="å…¬å¼æ¸²æŸ“å¤±è´¥: ${e.message}">${this.escapeHtml(match)}</span>`;
          }
        });

        // è¡Œå†…å…¬å¼
        processed = processed.replace(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g, (match, formula) => {
          if (!formula.trim()) return match;
          if (/^\s*\d+(\.\d+)?\s*$/.test(formula)) return match;
          if (!isFinal && !this.isCompleteLatex(formula)) return match;
          
          try {
            const rendered = katex.renderToString(formula.trim(), { 
              throwOnError: false,
              displayMode: false,
              strict: false,
              trust: true
            });
            const placeholder = `___LATEX_INLINE_${latexInline.length}___`;
            latexInline.push(rendered);
            return placeholder;
          } catch (e) {
            console.warn('LaTeXè¡Œå†…å…¬å¼æ¸²æŸ“å¤±è´¥:', formula, e);
            return `<span class="latex-error" title="å…¬å¼æ¸²æŸ“å¤±è´¥: ${e.message}">${this.escapeHtml(match)}</span>`;
          }
        });

        // Markdown
        processed = this.parseMarkdown(processed);

        // æ¢å¤å…¬å¼
        latexBlocks.forEach((latex, i) => {
          processed = processed.split(`___LATEX_BLOCK_${i}___`).join(latex);
        });
        latexInline.forEach((latex, i) => {
          processed = processed.split(`___LATEX_INLINE_${i}___`).join(latex);
        });

        element.innerHTML = processed;
      }

      isCompleteLatex(formula) {
        const openBraces = (formula.match(/\{/g) || []).length;
        const closeBraces = (formula.match(/\}/g) || []).length;
        const openParens = (formula.match(/\(/g) || []).length;
        const closeParens = (formula.match(/\)/g) || []).length;
        const openBrackets = (formula.match(/\[/g) || []).length;
        const closeBrackets = (formula.match(/\]/g) || []).length;
        
        if (openBraces !== closeBraces || openParens !== closeParens || openBrackets !== closeBrackets) {
          return false;
        }
        if (formula.trim().endsWith('\\')) return false;
        return true;
      }

      parseMarkdown(text) {
        let html = text;
        const codeBlocks = [];
        html = html.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
          const placeholder = `___CODE_BLOCK_${codeBlocks.length}___`;
          codeBlocks.push(`<pre><code class="language-${lang || 'text'}">${this.escapeHtml(code.trim())}</code></pre>`);
          return placeholder;
        });

        const inlineCodes = [];
        html = html.replace(/`([^`]+?)`/g, (match, code) => {
          const placeholder = `___INLINE_CODE_${inlineCodes.length}___`;
          inlineCodes.push(`<code>${this.escapeHtml(code)}</code>`);
          return placeholder;
        });

        html = html.replace(/\*\*([^\*\n]+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/(?<!\*)\*([^\*\n]+?)\*(?!\*)/g, '<em>$1</em>');
        html = html.replace(/^#### (.+)$/gm, '<h5>$1</h5>');
        html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
        html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

        html = html.replace(/^[\-\*] (.+)$/gm, (match, content) => {
          if (content.includes('___')) return match;
          return '<li>' + content + '</li>';
        });
        html = html.replace(/(<li>.*?<\/li>\n?)+/g, (match) => '<ul>' + match + '</ul>');

        html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*?<\/li>\n?)+/g, (match) => {
          if (match.startsWith('<ul>')) return match;
          return '<ol>' + match + '</ol>';
        });

        codeBlocks.forEach((code, i) => {
          html = html.split(`___CODE_BLOCK_${i}___`).join(code);
        });
        inlineCodes.forEach((code, i) => {
          html = html.split(`___INLINE_CODE_${i}___`).join(code);
        });

        html = html.replace(/\n\n+/g, '<br><br>');
        html = html.replace(/([^>])\n(?!<)/g, '$1<br>');

        return html;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // è¿è¡Œæµ‹è¯•
    const renderer = new TestRenderer();
    
    const tests = [
      { id: 'test1', content: 'ç‰›é¡¿ç¬¬äºŒå®šå¾‹ï¼š$F = ma$ï¼ŒåŠ¨èƒ½å…¬å¼ï¼š$E_k = \\frac{1}{2}mv^2$' },
      { id: 'test2', content: 'èƒ½é‡å®ˆæ’å®šå¾‹ï¼š$$E = mc^2$$' },
      { id: 'test3', content: 'äºŒæ¬¡å…¬å¼ï¼š$$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$' },
      { id: 'test4', content: 'è¿™æœ¬ä¹¦ä»·æ ¼æ˜¯ $100ï¼Œå¦ä¸€æœ¬æ˜¯ $50.99' },
      { id: 'test5', content: `## ç‰©ç†å…¬å¼
**åŠ›çš„å®šä¹‰**ï¼š$F = ma$
- åŠ é€Ÿåº¦ $a$
- è´¨é‡ $m$

å…¬å¼æ¨å¯¼ï¼š
$$v^2 = v_0^2 + 2as$$` },
      { id: 'test6', content: 'é”™è¯¯å…¬å¼ï¼š$\\frac{1}{2$ ï¼ˆç¼ºå°‘é—­åˆæ‹¬å·ï¼‰' },
      { id: 'test7', content: `$$
\\begin{aligned}
E &= mc^2 \\\\
p &= mv \\\\
F &= ma
\\end{aligned}
$$` }
    ];

    tests.forEach(test => {
      const element = document.getElementById(test.id);
      renderer.renderContent(element, test.content, true);
    });

    console.log('âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å·²åŠ è½½');
  </script>
</body>
</html>
