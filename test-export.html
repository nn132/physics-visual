<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>导出功能测试</title>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
  <h1>导出功能独立测试</h1>
  
  <canvas id="test-canvas" width="400" height="300" style="border:1px solid black"></canvas>
  
  <div style="margin-top: 20px;">
    <button id="test-export-mp4" style="padding: 10px 20px; background: blue; color: white; border: none; cursor: pointer;">
      测试导出 WebM
    </button>
    
    <button id="test-export-gif" style="padding: 10px 20px; background: green; color: white; border: none; cursor: pointer; margin-left: 10px;">
      测试导出 GIF
    </button>
  </div>
  
  <div id="status" style="margin-top: 20px; padding: 10px; background: #f0f0f0;"></div>
  
  <script>
    console.log('✅ 测试页面加载完成');
    
    const canvas = document.getElementById('test-canvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    
    // 绘制测试图案
    function drawTest() {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = '#ff6b00';
      ctx.beginPath();
      ctx.arc(200, 150, 50, 0, 2 * Math.PI);
      ctx.fill();
      
      ctx.fillStyle = '#000000';
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('测试动画', 200, 250);
    }
    
    drawTest();
    
    // 测试 WebM 导出
    document.getElementById('test-export-mp4').addEventListener('click', async () => {
      console.log('🎬 开始测试 WebM 导出');
      statusDiv.textContent = '开始录制 WebM...';
      
      try {
        if (!canvas.captureStream) {
          throw new Error('浏览器不支持 captureStream');
        }
        
        const stream = canvas.captureStream(30);
        const mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'video/webm'
        });
        
        const chunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            chunks.push(e.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `test-${Date.now()}.webm`;
          a.click();
          URL.revokeObjectURL(url);
          
          statusDiv.textContent = '✅ WebM 导出成功！';
          console.log('✅ WebM 导出完成');
        };
        
        mediaRecorder.start();
        statusDiv.textContent = '⏺️ 录制中...';
        
        // 简单动画
        let x = 50;
        const interval = setInterval(() => {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          ctx.fillStyle = '#ff6b00';
          ctx.beginPath();
          ctx.arc(x, 150, 30, 0, 2 * Math.PI);
          ctx.fill();
          
          x += 5;
          if (x > 350) x = 50;
        }, 50);
        
        // 3秒后停止
        setTimeout(() => {
          clearInterval(interval);
          mediaRecorder.stop();
          drawTest();
        }, 3000);
        
      } catch (error) {
        console.error('❌ WebM 导出失败:', error);
        statusDiv.textContent = '❌ 失败: ' + error.message;
      }
    });
    
    // 测试 GIF 导出
    document.getElementById('test-export-gif').addEventListener('click', async () => {
      console.log('🎨 开始测试 GIF 导出');
      statusDiv.textContent = '开始生成 GIF...';
      
      try {
        if (typeof GIF === 'undefined') {
          throw new Error('GIF 库未加载');
        }
        
        const gif = new GIF({
          workers: 2,
          quality: 10,
          width: canvas.width,
          height: canvas.height,
          workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
        });
        
        statusDiv.textContent = '📸 捕获帧...';
        
        // 捕获30帧
        let x = 50;
        for (let i = 0; i < 30; i++) {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          ctx.fillStyle = '#ff6b00';
          ctx.beginPath();
          ctx.arc(x, 150, 30, 0, 2 * Math.PI);
          ctx.fill();
          
          gif.addFrame(canvas, { copy: true, delay: 100 });
          x += 10;
          if (x > 350) x = 50;
        }
        
        statusDiv.textContent = '🔄 渲染 GIF...';
        
        gif.on('finished', (blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `test-${Date.now()}.gif`;
          a.click();
          URL.revokeObjectURL(url);
          
          statusDiv.textContent = '✅ GIF 导出成功！';
          console.log('✅ GIF 导出完成');
          drawTest();
        });
        
        gif.on('error', (error) => {
          console.error('❌ GIF 渲染失败:', error);
          statusDiv.textContent = '❌ GIF 失败: ' + error.message;
        });
        
        gif.render();
        
      } catch (error) {
        console.error('❌ GIF 导出失败:', error);
        statusDiv.textContent = '❌ 失败: ' + error.message;
      }
    });
    
    console.log('✅ 所有按钮事件已绑定');
  </script>
</body>
</html>
