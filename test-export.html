<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
  <h1>å¯¼å‡ºåŠŸèƒ½ç‹¬ç«‹æµ‹è¯•</h1>
  
  <canvas id="test-canvas" width="400" height="300" style="border:1px solid black"></canvas>
  
  <div style="margin-top: 20px;">
    <button id="test-export-mp4" style="padding: 10px 20px; background: blue; color: white; border: none; cursor: pointer;">
      æµ‹è¯•å¯¼å‡º WebM
    </button>
    
    <button id="test-export-gif" style="padding: 10px 20px; background: green; color: white; border: none; cursor: pointer; margin-left: 10px;">
      æµ‹è¯•å¯¼å‡º GIF
    </button>
  </div>
  
  <div id="status" style="margin-top: 20px; padding: 10px; background: #f0f0f0;"></div>
  
  <script>
    console.log('âœ… æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
    
    const canvas = document.getElementById('test-canvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    
    // ç»˜åˆ¶æµ‹è¯•å›¾æ¡ˆ
    function drawTest() {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = '#ff6b00';
      ctx.beginPath();
      ctx.arc(200, 150, 50, 0, 2 * Math.PI);
      ctx.fill();
      
      ctx.fillStyle = '#000000';
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('æµ‹è¯•åŠ¨ç”»', 200, 250);
    }
    
    drawTest();
    
    // æµ‹è¯• WebM å¯¼å‡º
    document.getElementById('test-export-mp4').addEventListener('click', async () => {
      console.log('ğŸ¬ å¼€å§‹æµ‹è¯• WebM å¯¼å‡º');
      statusDiv.textContent = 'å¼€å§‹å½•åˆ¶ WebM...';
      
      try {
        if (!canvas.captureStream) {
          throw new Error('æµè§ˆå™¨ä¸æ”¯æŒ captureStream');
        }
        
        const stream = canvas.captureStream(30);
        const mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'video/webm'
        });
        
        const chunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            chunks.push(e.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `test-${Date.now()}.webm`;
          a.click();
          URL.revokeObjectURL(url);
          
          statusDiv.textContent = 'âœ… WebM å¯¼å‡ºæˆåŠŸï¼';
          console.log('âœ… WebM å¯¼å‡ºå®Œæˆ');
        };
        
        mediaRecorder.start();
        statusDiv.textContent = 'âºï¸ å½•åˆ¶ä¸­...';
        
        // ç®€å•åŠ¨ç”»
        let x = 50;
        const interval = setInterval(() => {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          ctx.fillStyle = '#ff6b00';
          ctx.beginPath();
          ctx.arc(x, 150, 30, 0, 2 * Math.PI);
          ctx.fill();
          
          x += 5;
          if (x > 350) x = 50;
        }, 50);
        
        // 3ç§’ååœæ­¢
        setTimeout(() => {
          clearInterval(interval);
          mediaRecorder.stop();
          drawTest();
        }, 3000);
        
      } catch (error) {
        console.error('âŒ WebM å¯¼å‡ºå¤±è´¥:', error);
        statusDiv.textContent = 'âŒ å¤±è´¥: ' + error.message;
      }
    });
    
    // æµ‹è¯• GIF å¯¼å‡º
    document.getElementById('test-export-gif').addEventListener('click', async () => {
      console.log('ğŸ¨ å¼€å§‹æµ‹è¯• GIF å¯¼å‡º');
      statusDiv.textContent = 'å¼€å§‹ç”Ÿæˆ GIF...';
      
      try {
        if (typeof GIF === 'undefined') {
          throw new Error('GIF åº“æœªåŠ è½½');
        }
        
        const gif = new GIF({
          workers: 2,
          quality: 10,
          width: canvas.width,
          height: canvas.height,
          workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
        });
        
        statusDiv.textContent = 'ğŸ“¸ æ•è·å¸§...';
        
        // æ•è·30å¸§
        let x = 50;
        for (let i = 0; i < 30; i++) {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          ctx.fillStyle = '#ff6b00';
          ctx.beginPath();
          ctx.arc(x, 150, 30, 0, 2 * Math.PI);
          ctx.fill();
          
          gif.addFrame(canvas, { copy: true, delay: 100 });
          x += 10;
          if (x > 350) x = 50;
        }
        
        statusDiv.textContent = 'ğŸ”„ æ¸²æŸ“ GIF...';
        
        gif.on('finished', (blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `test-${Date.now()}.gif`;
          a.click();
          URL.revokeObjectURL(url);
          
          statusDiv.textContent = 'âœ… GIF å¯¼å‡ºæˆåŠŸï¼';
          console.log('âœ… GIF å¯¼å‡ºå®Œæˆ');
          drawTest();
        });
        
        gif.on('error', (error) => {
          console.error('âŒ GIF æ¸²æŸ“å¤±è´¥:', error);
          statusDiv.textContent = 'âŒ GIF å¤±è´¥: ' + error.message;
        });
        
        gif.render();
        
      } catch (error) {
        console.error('âŒ GIF å¯¼å‡ºå¤±è´¥:', error);
        statusDiv.textContent = 'âŒ å¤±è´¥: ' + error.message;
      }
    });
    
    console.log('âœ… æ‰€æœ‰æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
  </script>
</body>
</html>
