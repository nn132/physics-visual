<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>物理教学一体化平台</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- Mammoth.js for client-side .docx parsing -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js"></script>
  <!-- gifshot.js for GIF export (更适合浏览器环境) -->
  <script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/dist/gifshot.min.js"></script>
  <!-- html2canvas for PDF export with Chinese support -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- KaTeX for LaTeX math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <!-- AI助手样式 -->
  <link rel="stylesheet" href="ai-assistant.css">
  <!-- 学习报告样式 v2.0 -->
  <link rel="stylesheet" href="learning-report-v2.css">
  
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            accent: '#FF7D00',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .physics-animation {
        transition-timing-function: cubic-bezier(0.17, 0.67, 0.83, 0.67);
      }
      
      /* 全屏模式样式 */
      #animation-container.fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        border-radius: 0 !important;
        min-height: 100vh !important;
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
      }
      
      /* 全屏时Canvas样式（无论在哪个父元素下） */
      body.fullscreen-active #physics-canvas {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        display: block !important;
        z-index: 10000 !important;
        opacity: 1 !important;
        visibility: visible !important;
        pointer-events: auto !important;
        background-color: white !important;
      }
      
      /* 全屏时只隐藏特定元素，不影响数据 */
      body.fullscreen-active > header,
      body.fullscreen-active > section,
      body.fullscreen-active > footer,
      body.fullscreen-active > nav {
        display: none !important;
      }
      
      /* 全屏退出按钮 */
      .fullscreen-exit-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10002;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      
      .fullscreen-exit-btn:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }
      
      .fullscreen-exit-btn:active {
        transform: translateY(0);
      }
      
      /* 全屏控制面板 */
      .fullscreen-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10002;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px 30px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .fullscreen-controls button {
        transition: all 0.2s ease;
      }
      
      .fullscreen-controls button:hover {
        transform: translateY(-2px);
      }
      
      /* 全屏数据显示优化 */
      body.fullscreen-active .data-display {
        position: fixed !important;
        top: 20px !important;
        left: 20px !important;
        z-index: 10002 !important;
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px) !important;
        padding: 20px !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
        font-size: 18px !important;
      }
    }
  </style>
  <!-- 手机端额外样式：只新增，不修改现有桌面样式 -->
  <style>
    /* 题型分类卡片样式 - 确保所有卡片在折叠状态下保持相同高度 */
    #question-types .grid > div {
      display: flex;
      flex-direction: column;
    }
    
    /* 保持桌面端完全不变；以下规则只在窄屏（手机）生效 */
    @media (max-width: 768px) {
      /* 导航：确保品牌、按钮在一行且菜单更紧凑 */
      #navbar .container { 
        padding-left: 0.5rem; 
        padding-right: 0.5rem; 
      }
      #navbar .font-bold { 
        font-size: 0.85rem; 
        line-height: 1.2;
      }
      #navbar .text-2xl { font-size: 1.1rem; }
      #navbar .flex.items-center { gap: 0.25rem; }

      /* 导航栏按钮缩小 */
      #navbar .bg-primary,
      #navbar .report-button {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8rem !important;
        white-space: nowrap;
      }

      /* 学习报告下拉按钮 */
      .report-button {
        min-width: auto !important;
      }
      
      .report-badge {
        font-size: 8px !important;
        padding: 1px 4px !important;
      }

      /* 下拉菜单优化 */
      .report-dropdown-menu {
        right: 0;
        left: auto;
        min-width: 260px;
      }

      .report-dropdown-item {
        padding: 10px 12px !important;
      }

      .report-dropdown-title {
        font-size: 0.9rem !important;
      }

      .report-dropdown-desc {
        font-size: 0.75rem !important;
      }

      /* 英雄区：文字和按钮更紧凑，避免换行 */
      section.bg-gradient-to-br h1 { 
        font-size: 1.5rem !important; 
        line-height: 1.3 !important;
        margin-bottom: 1rem !important;
      }
      section.bg-gradient-to-br p { font-size: 0.95rem; }
      section.bg-gradient-to-br .flex { flex-direction: column; }
      section.bg-gradient-to-br .flex a { 
        width: 100%; 
        padding: 0.75rem 1.25rem !important;
        font-size: 0.95rem !important;
      }
      section.bg-gradient-to-br { padding-top: 2.5rem !important; padding-bottom: 2.5rem !important; }

      /* 功能卡和列表：单列显示，内边距微调 */
      .grid.md\:grid-cols-3, .grid.md\:grid-cols-4 { 
        grid-template-columns: 1fr !important; 
        gap: 0.875rem !important;
      }
      .p-6 { padding: 0.875rem !important; }
      .p-8 { padding: 1rem !important; }

      /* 主内容区域：移除过大的内边距 */
      section.py-20 { padding-top: 2rem !important; padding-bottom: 2rem !important; }
      section.py-16 { padding-top: 1.75rem !important; padding-bottom: 1.75rem !important; }

      /* 标题：减小字号 */
      h2.text-4xl, h2.text-5xl { font-size: 1.5rem !important; line-height: 1.3; }
      h3.text-2xl { font-size: 1.15rem !important; }
      h3.text-lg { font-size: 0.95rem !important; }

      /* 三栏布局改为单列 */
      .grid.md\:grid-cols-3.divide-y { 
        grid-template-columns: 1fr !important;
      }

      /* 动画容器：高度自适应，使用相对单位，确保不会超出小屏幕 */
      #animation-container { 
        height: 35vh !important; 
        min-height: 220px !important;
        max-height: 350px !important;
      }
      #animated-object { width: 22px !important; height: 22px !important; }
      #animated-object-2 { width: 22px !important; height: 22px !important; }

      /* 控制面板：行内元素换行并撑满宽度 */
      .mt-4.flex.flex-wrap { 
        gap: 0.5rem; 
        flex-direction: column;
      }
      .mt-4 .ml-auto { margin-left: 0 !important; width: 100%; }
      .flex.gap-2, .flex.gap-3, .flex.gap-4 {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }

      /* 按钮：撑满宽度，增大点击区域 */
      button, .btn, a.group {
        width: 100% !important;
        min-height: 42px !important;
        padding: 0.625rem 0.875rem !important;
        font-size: 0.9rem !important;
      }

      /* 文本块、表单元素：增大点击目标，避免过窄 */
      input[type="number"], 
      input[type="text"],
      textarea, 
      select, 
      button { 
        font-size: 16px !important; /* 防止iOS自动缩放 */
        padding: 0.625rem !important;
        width: 100% !important;
      }
      textarea.h-32 { height: 7rem !important; }
      
      /* Label文字：确保可读 */
      label { font-size: 0.9rem !important; }

      /* 文件上传区域 */
      .border-2.border-dashed { 
        padding: 1.25rem 0.875rem !important;
        font-size: 0.85rem !important;
      }

      /* 参数输入框组：堆叠显示 */
      #dynamic-params > div {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      #dynamic-params label {
        margin-bottom: 0.5rem !important;
        width: 100% !important;
      }
      #dynamic-params input {
        width: 100% !important;
      }

      /* 图表容器 */
      canvas {
        max-height: 220px !important;
      }

      /* 卡片网格：单列 */
      .max-w-6xl { max-width: 100% !important; }
      .max-w-7xl { max-width: 100% !important; }
      .max-w-4xl { max-width: 100% !important; }

      /* 圆角：减小以适应小屏 */
      .rounded-2xl { border-radius: 0.875rem !important; }

      /* 功能图标 */
      .w-16.h-16 { 
        width: 2.75rem !important; 
        height: 2.75rem !important; 
      }

      /* 页脚：网格改为单列 */
      footer .grid.md\:grid-cols-4 { 
        grid-template-columns: 1fr !important; 
        gap: 1.25rem !important;
      }
      footer { padding: 1.75rem 0.875rem !important; }

      /* 容器内边距统一减小 */
      .container { padding-left: 0.875rem !important; padding-right: 0.875rem !important; }

      /* 移除过大的margin */
      .mb-16 { margin-bottom: 1.75rem !important; }
      .mb-10 { margin-bottom: 1.25rem !important; }
      .mb-6 { margin-bottom: 0.875rem !important; }

      /* 隐藏桌面端元素 */
      .hidden.md\:flex { display: none !important; }

      /* 调整动画控制按钮组 */
      .animation-controls {
        flex-direction: column !important;
        width: 100% !important;
      }
      .animation-controls button {
        width: 100% !important;
      }

      /* 知识点卡片优化 */
      .knowledge-card {
        padding: 0.875rem !important;
      }

      /* 模态框优化 */
      .modal-content {
        width: 95vw !important;
        max-width: 95vw !important;
        margin: 0.75rem !important;
        padding: 0.875rem !important;
      }
    }

    /* 超小屏幕（小于480px） */
    @media (max-width: 480px) {
      /* 进一步缩小文字 */
      html { font-size: 14px; }
      
      /* 导航栏进一步优化 */
      #navbar .font-bold { 
        font-size: 0.8rem; 
      }
      #navbar .text-2xl { 
        font-size: 1rem; 
        margin-right: 0.25rem;
      }

      /* 按钮更小 */
      #navbar .bg-primary,
      #navbar .report-button {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.75rem !important;
      }

      h1 { font-size: 1.35rem !important; }
      h2 { font-size: 1.25rem !important; }
      h3 { font-size: 1rem !important; }

      /* 进一步减小内边距 */
      .p-6, .p-8 { padding: 0.625rem !important; }
      section { padding: 1.25rem 0.5rem !important; }

      /* 按钮文字 */
      button, .btn { font-size: 0.85rem !important; }

      /* 动画容器 */
      #animation-container { 
        height: 30vh !important;
        min-height: 180px !important;
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans text-dark min-h-screen flex flex-col">
  <!-- 导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- 品牌标识 -->
        <div class="flex items-center">
          <div class="flex-shrink-0 text-primary">
            <i class="fa fa-cubes text-2xl mr-2"></i>
            <span class="font-bold text-xl">物理教学一体化平台</span>
          </div>
        </div>
        
        <!-- 导航链接 - 桌面端 -->
        <nav class="hidden md:flex space-x-8">
          <a href="#visualization" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors">运动可视化</a>
          <a href="#knowledge" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors">知识点库</a>
          <a href="#question-types" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors">题型分类</a>
          <a href="#help" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors">使用帮助</a>
        </nav>
        
        <!-- 用户区域 -->
        <div class="flex items-center gap-3">
          <!-- 数据报告下拉菜单 -->
          <div class="report-dropdown-container">
            <button id="report-dropdown-btn" class="report-toggle-btn">
              <i class="fa fa-bar-chart"></i>
              <span class="hidden sm:inline">数据报告</span>
              <span class="report-badge">NEW</span>
              <i class="fa fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
            </button>
            
            <!-- 下拉菜单 -->
            <div id="report-dropdown-menu" class="report-dropdown-menu hidden">
              <button id="show-student-report" class="report-dropdown-item">
                <i class="fa fa-user"></i>
                <div class="report-dropdown-text">
                  <div class="report-dropdown-title">学习报告</div>
                  <div class="report-dropdown-desc">查看个人学习数据分析</div>
                </div>
              </button>
              <button id="show-teacher-report" class="report-dropdown-item">
                <i class="fa fa-graduation-cap"></i>
                <div class="report-dropdown-text">
                  <div class="report-dropdown-title">教师精准备课指导</div>
                  <div class="report-dropdown-desc">班级统计与教学建议</div>
                </div>
              </button>
            </div>
          </div>
          
          <a href="dengluyemian001/index.html" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors inline-block">
            登录
          </a>
          <!-- 移动端菜单按钮 -->
          <button type="button" class="md:hidden text-gray-700 hover:text-primary" id="mobile-menu-button">
            <i class="fa fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 移动端菜单 -->
    <div class="md:hidden hidden bg-white shadow-lg absolute w-full" id="mobile-menu">
      <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
        <a href="#visualization" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-primary hover:bg-gray-50">运动可视化</a>
        <a href="#knowledge" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-primary hover:bg-gray-50">知识点库</a>
        <a href="#question-types" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-primary hover:bg-gray-50">题型分类</a>
        <a href="#help" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-primary hover:bg-gray-50">使用帮助</a>
      </div>
    </div>
  </header>

  <style>
    /* 高亮目标区域的过渡效果（用于点击功能卡后的视觉提示） */
    .feature-target-highlight {
      background-color: rgba(187, 227, 255, 0.45); /* 浅蓝色高亮 */
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.08);
      transition: background-color 0.45s ease, box-shadow 0.45s ease;
      border-radius: 12px;
    }

    /* 功能卡键盘焦点样式（提升可访问性） */
    .feature-card:focus {
      outline: none;
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.15);
      transform: translateY(-2px);
    }
  </style>

  <main class="flex-grow">
    <!-- 英雄区域 -->
    <section class="bg-gradient-to-br from-blue-600 via-blue-500 to-purple-600 text-white py-16 md:py-24 relative overflow-hidden">
      <!-- 背景装饰 -->
      <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTM2IDE2djhjMCAxLjEtLjkgMi0yIDJoLThjLTEuMSAwLTItLjktMi0ydi04YzAtMS4xLjktMiAyLTJoOGMxLjEgMCAyIC45IDIgMnoiLz48L2c+PC9nPjwvc3ZnPg==')] opacity-30"></div>
      
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        <div class="max-w-4xl mx-auto text-center">
          <h1 class="text-5xl md:text-7xl font-black mb-10 leading-[1.1] tracking-tight">
            让物理学习变得<br/>直观简单
          </h1>
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
            <a href="#visualization" class="group bg-white text-blue-600 hover:bg-blue-50 px-8 py-4 rounded-xl font-bold text-lg text-center transition-all duration-300 hover:shadow-2xl hover:scale-105 hover:-translate-y-1 shadow-lg">
              <i class="fa fa-rocket mr-2 group-hover:translate-x-1 transition-transform duration-300"></i>开始使用
            </a>
            <a href="#features" class="group bg-white/10 backdrop-blur-md border-2 border-white/40 text-white hover:bg-white/20 hover:border-white/60 px-8 py-4 rounded-xl font-bold text-lg text-center transition-all duration-300 hover:shadow-xl hover:scale-105">
              <i class="fa fa-play-circle mr-2 group-hover:scale-110 inline-block transition-transform duration-300"></i>查看演示
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- 功能特点 -->
    <section id="features" class="py-20 bg-white relative">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-bold text-gray-900">强大功能，助力物理学习</h2>
        </div>
        
        <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
          <!-- 功能1 -->
          <div class="group bg-gradient-to-br from-blue-50 to-white rounded-2xl p-8 shadow-sm hover:shadow-xl transition-all duration-300 border border-blue-100 feature-card cursor-pointer" role="button" tabindex="0" aria-label="前往运动过程可视化" data-target="#visualization">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-lg">
              <i class="fa fa-line-chart text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">运动过程可视化</h3>
            <p class="text-gray-600 leading-relaxed">导入物理题目，自动生成3D或2D运动轨迹，直观展示物体运动过程，标注关键位置和状态。</p>
          </div>
          
          <!-- 功能2 -->
          <div class="group bg-gradient-to-br from-purple-50 to-white rounded-2xl p-8 shadow-sm hover:shadow-xl transition-all duration-300 border border-purple-100 feature-card cursor-pointer" role="button" tabindex="0" aria-label="前往知识点集成" data-target="#knowledge">
            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-lg">
              <i class="fa fa-book text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">知识点集成</h3>
            <p class="text-gray-600 leading-relaxed">整合高中物理全部知识点，配有详细解析和例题，方便随时查阅，巩固基础。</p>
          </div>
          
          <!-- 功能3 -->
          <div class="group bg-gradient-to-br from-pink-50 to-white rounded-2xl p-8 shadow-sm hover:shadow-xl transition-all duration-300 border border-pink-100 feature-card cursor-pointer" role="button" tabindex="0" aria-label="前往题型分类整理" data-target="#question-types">
            <div class="w-16 h-16 bg-gradient-to-br from-pink-500 to-pink-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform shadow-lg">
              <i class="fa fa-tags text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">题型分类整理</h3>
            <p class="text-gray-600 leading-relaxed">按知识点和难度分类整理典型题型，帮助学生掌握各类问题的解题思路和方法。</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 运动可视化区域 -->
    <section id="visualization" class="py-20 bg-gradient-to-b from-gray-50 to-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-bold text-gray-900">物理运动可视化</h2>
        </div>
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 max-w-7xl mx-auto">
    <div class="grid md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-200">
            <!-- 左侧：题目输入区 -->
            <div class="p-6 flex flex-col">
              <h3 class="text-lg font-semibold mb-4">输入物理题目</h3>
              
              <!-- 题目类型 -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">题目类型</label>
                <select id="question-type-select" class="w-full p-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="uniform">匀变速直线运动</option>
                  <option value="projectile">平抛/抛体运动</option>
                  <option value="circular">圆周运动</option>
                  <option value="astrodynamics">天体运动</option>
                  <option value="collision">碰撞与动量守恒</option>
                  <option value="magnetic">带电粒子/电磁学运动</option>
                </select>
              </div>
              
              <!-- 题目描述 -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">题目描述</label>
                <textarea id="problem-description" class="w-full p-3 border-2 border-blue-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" rows="6" placeholder="输入题目或点击下方导入..."></textarea>
                
                <!-- 可视化提示词模块：替代旧的上传/解析流程 -->
                <div class="mt-3 grid gap-3">
                  <label class="text-sm font-medium text-gray-700">可视化提示词 (更细化的视觉控制)</label>
                  <textarea id="visual-prompt" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：抛体运动，初速度10m/s，角度45°；风格：卡通；高亮顶点与速度向量；轨迹显示为点线"></textarea>

                  <div class="grid grid-cols-2 gap-2">
                    <select id="visual-theme" class="w-full p-2 border border-gray-300 rounded-md">
                      <option value="realistic">真实风格</option>
                      <option value="cartoon" selected>卡通风格</option>
                      <option value="minimal">极简风格</option>
                    </select>
                    <select id="visual-detail" class="w-full p-2 border border-gray-300 rounded-md">
                      <option value="low">低细节</option>
                      <option value="medium" selected>中等细节</option>
                      <option value="high">高细节</option>
                    </select>
                  </div>

                  <div class="flex items-center gap-3">
                    <label class="inline-flex items-center"><input id="visual-highlight-apex" type="checkbox" class="mr-2"> 高亮顶点/极值</label>
                    <label class="inline-flex items-center"><input id="visual-show-velocity" type="checkbox" class="mr-2" checked> 显示速度向量</label>
                    <label class="inline-flex items-center"><input id="visual-use-trail" type="checkbox" class="mr-2" checked> 使用轨迹</label>
                  </div>

                  <div class="grid grid-cols-2 gap-3">
                    <button id="parse-description" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg transition-colors flex items-center justify-center gap-2">应用提示</button>
                    <button id="reset-visual-prompt" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg">清除提示</button>
                  </div>
                </div>
              </div>
              
              <!-- 高级导入（折叠）: 保留原有图片/Word导入但默认折叠，减少界面干扰 -->
              <details class="mb-4" id="advanced-import">
                <summary class="cursor-pointer text-sm text-gray-600">高级导入：图片 / Word 文档（折叠）</summary>
                <div class="mt-3">
                  <div class="grid grid-cols-2 gap-2 mb-2">
                    <button id="upload-image-btn" type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">上传图片</button>
                    <button id="upload-docx-btn" type="button" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">导入 Word (.docx)</button>
                  </div>
                  <!-- 隐藏的文件输入（保留原有处理逻辑） -->
                  <input id="upload-image" type="file" accept="image/*" class="hidden">
                  <input id="upload-docx" type="file" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="hidden">
                </div>
              </details>

              <!-- 图片上传显示区域 -->
              <div id="image-upload-area" class="mb-4 hidden">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-sm font-medium">
                      <i class="fa fa-image text-blue-600"></i>
                      <span>图片已上传</span>
                    </div>
                    <button id="remove-image" class="text-red-600 hover:text-red-700 text-sm">
                      <i class="fa fa-times"></i> 删除
                    </button>
                  </div>
                  <div id="ocr-result" class="text-sm text-gray-700 bg-white p-3 rounded border border-gray-200 max-h-32 overflow-y-auto">
                    识别中...
                  </div>
                  <button id="apply-ocr" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2">
                    <i class="fa fa-eye"></i>
                    <span>识别并填充</span>
                  </button>
                </div>
              </div>
              
              <!-- 参数设置 -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">参数设置</label>
                <!-- 动态参数区域（不同题型显示不同字段） -->
                <div id="dynamic-params"></div>
              </div>
              
              <!-- 生成可视化按钮 -->
              <button id="generate-animation" class="w-full bg-gradient-to-r from-blue-600 via-purple-600 to-orange-500 hover:from-blue-700 hover:via-purple-700 hover:to-orange-600 text-white py-3 px-6 rounded-lg text-lg font-medium flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg">
                <i class="fa fa-play-circle"></i>
                <span>生成可视化</span>
              </button>
            </div>
            
            <!-- 右侧：可视化展示区 -->
            <div class="md:col-span-2 p-6 bg-gray-50 flex flex-col" style="min-height: 700px;">
              <h3 class="text-lg font-semibold mb-4">运动过程演示</h3>
              
              <!-- 动画画布 - Canvas场景绘制 -->
              <div id="animation-container" class="bg-white rounded-lg border-2 border-gray-900 relative overflow-hidden" style="height: 500px;">
                <!-- Canvas用于物理场景绘制 -->
                <canvas id="physics-canvas" class="absolute inset-0 w-full h-full"></canvas>
                
                <!-- 实时数据显示（覆盖在Canvas上） -->
                <div class="data-display absolute top-4 left-4 bg-white/90 backdrop-blur-sm rounded-lg p-3 border border-gray-300 shadow-sm z-10">
                  <div class="text-xs space-y-1 font-mono">
                    <div><span class="text-gray-600">时间:</span> <span id="animation-time" class="font-bold">0.00 s</span></div>
                    <div><span class="text-gray-600">速度:</span> <span id="animation-velocity" class="font-bold">0.00 m/s</span></div>
                    <div><span class="text-gray-600">位置:</span> <span id="animation-position" class="font-bold">0.00 m</span></div>
                  </div>
                </div>
              </div>
              
              <!-- 控制面板 -->
              <div class="mt-4 flex flex-wrap gap-4 items-center">
                <!-- 播放控制 -->
                <button id="play-animation" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-all">
                  <i class="fa fa-play"></i>
                  <span>播放</span>
                </button>
                <button id="pause-animation" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg hidden flex items-center gap-2 shadow-sm transition-all">
                  <i class="fa fa-pause"></i>
                  <span>暂停</span>
                </button>
                <button id="reset-animation" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-all">
                  <i class="fa fa-refresh"></i>
                  <span>重置</span>
                </button>
                
                <div class="flex items-center ml-4">
                  <label class="text-sm text-gray-600 mr-2">播放速度:</label>
                  <input type="range" min="0.1" max="2" step="0.1" value="1" class="w-32" id="animation-speed">
                  <span id="speed-display" class="ml-2 text-sm font-mono bg-gray-100 px-2 py-1 rounded">1.0x</span>
                </div>
                
                <!-- 全屏按钮 -->
                <button id="fullscreen-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-all" title="全屏显示">
                  <i class="fa fa-expand"></i>
                  <span>全屏</span>
                </button>
                
                <!-- 导出按钮 -->
                <div class="relative ml-auto">
                  <button id="export-menu-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-all">
                    <i class="fa fa-download"></i>
                    <span>导出动画</span>
                  </button>
                  <div id="export-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-20">
                    <button id="export-mp4" class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2 rounded-t-lg">
                      <i class="fa fa-file-video-o text-blue-600"></i>
                      <span>导出为 MP4</span>
                    </button>
                    <button id="export-gif" class="w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-2 rounded-b-lg">
                      <i class="fa fa-file-image-o text-orange-600"></i>
                      <span>导出为 GIF</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- 精准可视化图表：位置/速度随时间 -->
              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-md p-3 border border-gray-100">
                  <h4 class="text-sm font-medium mb-2">位移 s(t)（m）</h4>
                  <canvas id="chart-position" width="400" height="200"></canvas>
                </div>
                <div class="bg-white rounded-md p-3 border border-gray-100">
                  <h4 class="text-sm font-medium mb-2">速度 v(t)（m/s）</h4>
                  <canvas id="chart-velocity" width="400" height="200"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 知识点库 -->
    <section id="knowledge" class="py-20 bg-gradient-to-b from-gray-50 to-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-bold text-gray-900">物理知识点库</h2>
        </div>
        
        <div class="grid lg:grid-cols-12 gap-8 max-w-7xl mx-auto">
          <!-- 知识点分类导航 -->
          <div class="lg:col-span-3">
            <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24 border border-gray-100 min-h-[400px]">
              <h3 class="text-lg font-bold mb-4 pb-3 border-b-2 border-purple-500 flex items-center gap-2">
                <i class="fa fa-book text-purple-500"></i>
                知识点分类
              </h3>
              <ul id="knowledge-nav" class="space-y-2">
                <!-- 动态渲染 -->
              </ul>
            </div>
          </div>
          
          <!-- 知识点内容 -->
          <div class="lg:col-span-9">
            <div id="knowledge-content">
              <!-- 动态渲染 -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 题型分类 -->
    <section id="question-types" class="py-20 bg-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-bold text-gray-900">物理题型分类</h2>
        </div>
        
        <div class="grid lg:grid-cols-12 gap-8 max-w-7xl mx-auto">
          <!-- 题型分类导航 -->
          <div class="lg:col-span-3">
            <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24 border border-gray-100 min-h-[400px]">
              <h3 class="text-lg font-bold mb-4 pb-3 border-b-2 border-pink-500 flex items-center gap-2">
                <i class="fa fa-list-alt text-pink-500"></i>
                题型分类
              </h3>
              <ul id="question-types-nav" class="space-y-2">
                <!-- 动态渲染 -->
              </ul>
            </div>
          </div>
          
          <!-- 题型内容 -->
          <div class="lg:col-span-9">
            <div id="question-types-content">
              <!-- 动态渲染 -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 使用帮助 -->
    <section id="help" class="py-20 bg-gradient-to-b from-gray-50 to-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-bold text-gray-900">使用帮助</h2>
        </div>
        
        <div class="max-w-4xl mx-auto">
          <div class="space-y-3">
            <!-- 问题1 -->
            <div class="faq-item bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-all hover:shadow-md">
              <button class="faq-question w-full flex justify-between items-center p-6 text-left focus:outline-none group">
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0">
                    <i class="fa fa-question-circle text-blue-600"></i>
                  </div>
                  <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors">如何导入物理题目并生成可视化？</h3>
                </div>
                <i class="fa fa-chevron-down text-blue-500 text-sm transition-transform faq-icon"></i>
              </button>
              <div class="faq-answer max-h-0 overflow-hidden transition-all duration-300">
                <div class="px-6 pb-6 text-gray-600 leading-relaxed">
                  <p class="mb-4 font-medium text-gray-700">您可以通过两种方式生成物理运动可视化：</p>
                  <ol class="list-decimal pl-5 space-y-3 mb-4">
                    <li class="pl-2">在<span class="font-semibold text-gray-800">"运动可视化"</span>页面的题目输入区，选择题目类型并填写题目描述和关键参数，点击"生成可视化"按钮</li>
                    <li class="pl-2">直接上传包含物理题目的<span class="font-semibold text-gray-800">图片</span>，系统会自动识别题目内容并提取关键参数生成可视化</li>
                  </ol>
                  <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                    <p class="text-sm"><i class="fa fa-lightbulb text-blue-600 mr-2"></i>生成后，您可以通过播放、暂停、重置按钮控制动画，并可调整动画速度和显示选项。</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 问题2 -->
            <div class="faq-item bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-all hover:shadow-md">
              <button class="faq-question w-full flex justify-between items-center p-6 text-left focus:outline-none group">
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center flex-shrink-0">
                    <i class="fa fa-list-alt text-purple-600"></i>
                  </div>
                  <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors">平台支持哪些类型的物理题目可视化？</h3>
                </div>
                <i class="fa fa-chevron-down text-gray-400 text-sm transition-transform faq-icon"></i>
              </button>
              <div class="faq-answer max-h-0 overflow-hidden transition-all duration-300">
                <div class="px-6 pb-6 text-gray-600 leading-relaxed">
                  <p class="mb-4 font-medium text-gray-700">平台目前支持以下6种类型的物理运动可视化：</p>
                  <div class="grid md:grid-cols-2 gap-3 mb-4">
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                      <i class="fa fa-check-circle text-green-500 mt-1"></i>
                      <div>
                        <div class="font-semibold text-gray-800">匀变速直线运动</div>
                        <div class="text-sm text-gray-500">刹车、自由落体等</div>
                      </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                      <i class="fa fa-check-circle text-green-500 mt-1"></i>
                      <div>
                        <div class="font-semibold text-gray-800">平抛/抛体运动</div>
                        <div class="text-sm text-gray-500">斜抛、平抛等</div>
                      </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                      <i class="fa fa-check-circle text-green-500 mt-1"></i>
                      <div>
                        <div class="font-semibold text-gray-800">圆周运动</div>
                        <div class="text-sm text-gray-500">匀速圆周、变速圆周</div>
                      </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                      <i class="fa fa-check-circle text-green-500 mt-1"></i>
                      <div>
                        <div class="font-semibold text-gray-800">天体运动</div>
                        <div class="text-sm text-gray-500">卫星、行星轨道</div>
                      </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                      <i class="fa fa-check-circle text-green-500 mt-1"></i>
                      <div>
                        <div class="font-semibold text-gray-800">碰撞与动量守恒</div>
                        <div class="text-sm text-gray-500">弹性碰撞、完全非弹性</div>
                      </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                      <i class="fa fa-check-circle text-green-500 mt-1"></i>
                      <div>
                        <div class="font-semibold text-gray-800">带电粒子/电磁学</div>
                        <div class="text-sm text-gray-500">电场、磁场中运动</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 问题3 -->
            <div class="faq-item bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-all hover:shadow-md">
              <button class="faq-question w-full flex justify-between items-center p-6 text-left focus:outline-none group">
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center flex-shrink-0">
                    <i class="fa fa-search text-green-600"></i>
                  </div>
                  <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors">如何查找特定的知识点和题型？</h3>
                </div>
                <i class="fa fa-chevron-down text-gray-400 text-sm transition-transform faq-icon"></i>
              </button>
              <div class="faq-answer max-h-0 overflow-hidden transition-all duration-300">
                <div class="px-6 pb-6 text-gray-600 leading-relaxed">
                  <p class="mb-4 font-medium text-gray-700">平台提供了两种便捷的查找方式：</p>
                  <div class="space-y-4">
                    <div class="flex gap-4">
                      <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0">1</div>
                      <div>
                        <div class="font-semibold text-gray-800 mb-2">知识点库查找</div>
                        <p class="text-sm">访问<span class="font-semibold">"知识点库"</span>板块，选择物理分支（力学、电磁学等），点击左侧分类展开子菜单，即可查看详细的知识点内容、公式和例题。</p>
                      </div>
                    </div>
                    <div class="flex gap-4">
                      <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold flex-shrink-0">2</div>
                      <div>
                        <div class="font-semibold text-gray-800 mb-2">题型分类查找</div>
                        <p class="text-sm">访问<span class="font-semibold">"题型分类"</span>板块，选择学科分支，点击展开后可以看到简单题、中档题、难题三个难度等级，点击查看该难度的示例题目和关键词。</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 问题4 -->
            <div class="faq-item bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-all hover:shadow-md">
              <button class="faq-question w-full flex justify-between items-center p-6 text-left focus:outline-none group">
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-10 h-10 rounded-lg bg-yellow-50 flex items-center justify-center flex-shrink-0">
                    <i class="fa fa-download text-yellow-600"></i>
                  </div>
                  <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors">能否保存和导出可视化动画？</h3>
                </div>
                <i class="fa fa-chevron-down text-gray-400 text-sm transition-transform faq-icon"></i>
              </button>
              <div class="faq-answer max-h-0 overflow-hidden transition-all duration-300">
                <div class="px-6 pb-6 text-gray-600 leading-relaxed">
                  <p class="mb-4">平台提供了多种保存和分享方式：</p>
                  <ul class="space-y-3">
                    <li class="flex items-start gap-3">
                      <i class="fa fa-bookmark text-blue-500 mt-1"></i>
                      <div>
                        <span class="font-semibold text-gray-800">收藏功能：</span>登录后可以将喜欢的可视化动画收藏到个人中心，方便随时查看
                      </div>
                    </li>
                    <li class="flex items-start gap-3">
                      <i class="fa fa-image text-blue-500 mt-1"></i>
                      <div>
                        <span class="font-semibold text-gray-800">截图保存：</span>点击截图按钮可以保存当前帧为PNG图片
                      </div>
                    </li>
                    <li class="flex items-start gap-3">
                      <i class="fa fa-share-alt text-blue-500 mt-1"></i>
                      <div>
                        <span class="font-semibold text-gray-800">分享链接：</span>生成专属链接，可以分享给同学或老师
                      </div>
                    </li>
                  </ul>
                  <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg mt-4">
                    <p class="text-sm"><i class="fa fa-info-circle text-yellow-600 mr-2"></i>注：视频导出功能即将上线，敬请期待！</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 问题5 -->
            <div class="faq-item bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-all hover:shadow-md">
              <button class="faq-question w-full flex justify-between items-center p-6 text-left focus:outline-none group">
                <div class="flex items-center gap-4 flex-1">
                  <div class="w-10 h-10 rounded-lg bg-pink-50 flex items-center justify-center flex-shrink-0">
                    <i class="fa fa-sliders text-pink-600"></i>
                  </div>
                  <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors">平台是否支持自定义物理参数？</h3>
                </div>
                <i class="fa fa-chevron-down text-gray-400 text-sm transition-transform faq-icon"></i>
              </button>
              <div class="faq-answer max-h-0 overflow-hidden transition-all duration-300">
                <div class="px-6 pb-6 text-gray-600 leading-relaxed">
                  <p class="mb-4">当然支持！平台提供了灵活的参数自定义功能：</p>
                  <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
                      <div class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        <i class="fa fa-cog text-blue-600"></i>运动参数
                      </div>
                      <ul class="text-sm space-y-1 text-gray-600">
                        <li>• 初速度、加速度</li>
                        <li>• 角度、时间</li>
                        <li>• 质量、重力加速度</li>
                      </ul>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
                      <div class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                        <i class="fa fa-palette text-purple-600"></i>视觉参数
                      </div>
                      <ul class="text-sm space-y-1 text-gray-600">
                        <li>• 物体颜色、形状</li>
                        <li>• 轨迹显示样式</li>
                        <li>• 背景和场景设置</li>
                      </ul>
                    </div>
                  </div>
                  <p class="text-sm">只需在"运动可视化"页面的<span class="font-semibold text-gray-800">动态参数</span>区域填写或调整相应参数即可。</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 联系客服卡片 -->
          <div class="mt-12 text-center bg-gradient-to-r from-blue-50 via-purple-50 to-pink-50 rounded-2xl p-10 border border-blue-100 shadow-sm">
            <div class="text-5xl mb-4">💬</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">还有其他问题？</h3>
            <p class="text-gray-600 mb-6">我们的团队随时为您提供帮助</p>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
              <button class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-3 rounded-xl font-semibold transition-all hover:shadow-lg hover:scale-105">
                <i class="fa fa-envelope mr-2"></i>联系客服
              </button>
              <button class="bg-white hover:bg-gray-50 text-gray-700 border-2 border-gray-200 px-8 py-3 rounded-xl font-semibold transition-all hover:shadow-md">
                <i class="fa fa-comments mr-2"></i>在线反馈
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <script>
      // FAQ 折叠/展开功能
      document.addEventListener('DOMContentLoaded', function() {
        const faqItems = document.querySelectorAll('.faq-item');
        
        faqItems.forEach(item => {
          const question = item.querySelector('.faq-question');
          const answer = item.querySelector('.faq-answer');
          const icon = item.querySelector('.faq-icon');
          
          question.addEventListener('click', () => {
            const isOpen = answer.style.maxHeight && answer.style.maxHeight !== '0px';
            
            // 关闭所有其他项
            faqItems.forEach(otherItem => {
              if (otherItem !== item) {
                const otherAnswer = otherItem.querySelector('.faq-answer');
                const otherIcon = otherItem.querySelector('.faq-icon');
                otherAnswer.style.maxHeight = '0px';
                otherIcon.style.transform = 'rotate(0deg)';
              }
            });
            
            // 切换当前项
            if (isOpen) {
              answer.style.maxHeight = '0px';
              icon.style.transform = 'rotate(0deg)';
            } else {
              answer.style.maxHeight = answer.scrollHeight + 'px';
              icon.style.transform = 'rotate(180deg)';
            }
          });
        });
        
        // 默认全部关闭
        // 用户点击后才展开
      });
    </script>
  </main>

  <!-- 页脚 -->
  <footer class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white pt-20 pb-12">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid md:grid-cols-4 gap-12 mb-16">
        <!-- 平台介绍 -->
        <div>
          <div class="flex items-center mb-6">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mr-3 shadow-lg">
              <i class="fa fa-cubes text-2xl"></i>
            </div>
            <span class="font-bold text-xl">物理教学平台</span>
          </div>
          <p class="text-gray-400 leading-relaxed mb-6">让高中物理学习变得直观简单，助力学生理解抽象概念，提高学习效率。</p>
          <div class="flex flex-col space-y-3 text-sm text-gray-400">
            <div class="flex items-center">
              <i class="fa fa-check-circle text-green-400 mr-2"></i>
              <span>支持多种运动类型</span>
            </div>
            <div class="flex items-center">
              <i class="fa fa-check-circle text-green-400 mr-2"></i>
              <span>AI智能题目解析</span>
            </div>
            <div class="flex items-center">
              <i class="fa fa-check-circle text-green-400 mr-2"></i>
              <span>实时动画演示</span>
            </div>
          </div>
        </div>
        
        <!-- 功能导航 -->
        <div>
          <h3 class="font-bold mb-6 text-lg flex items-center">
            <i class="fa fa-compass text-blue-400 mr-2"></i>
            功能导航
          </h3>
          <ul class="space-y-3 text-gray-400">
            <li><a href="#visualization" class="hover:text-white hover:translate-x-1 inline-block transition-all group"><i class="fa fa-angle-right mr-2 group-hover:text-blue-400"></i>运动可视化</a></li>
            <li><a href="#knowledge" class="hover:text-white hover:translate-x-1 inline-block transition-all group"><i class="fa fa-angle-right mr-2 group-hover:text-blue-400"></i>知识点库</a></li>
            <li><a href="#question-types" class="hover:text-white hover:translate-x-1 inline-block transition-all group"><i class="fa fa-angle-right mr-2 group-hover:text-blue-400"></i>题型分类</a></li>
          </ul>
        </div>
        
        <!-- 帮助支持 -->
        <div>
          <h3 class="font-bold mb-6 text-lg flex items-center">
            <i class="fa fa-life-ring text-purple-400 mr-2"></i>
            帮助支持
          </h3>
          <ul class="space-y-3 text-gray-400">
            <li><a href="#help" class="hover:text-white hover:translate-x-1 inline-block transition-all group"><i class="fa fa-angle-right mr-2 group-hover:text-purple-400"></i>使用帮助</a></li>
            <li><a href="#help" class="hover:text-white hover:translate-x-1 inline-block transition-all group"><i class="fa fa-angle-right mr-2 group-hover:text-purple-400"></i>常见问题</a></li>
          </ul>
        </div>
        
        <!-- 关注我们 -->
        <div>
          <h3 class="font-bold mb-6 text-lg flex items-center">
            <i class="fa fa-heart text-pink-400 mr-2"></i>
            关注我们
          </h3>
          <div class="flex space-x-3 mb-6">
            <a href="#" class="w-12 h-12 rounded-xl bg-gray-700/50 backdrop-blur-sm flex items-center justify-center hover:bg-gradient-to-br hover:from-green-500 hover:to-green-600 transition-all hover:scale-110 hover:shadow-lg group" title="微信公众号">
              <i class="fa fa-weixin text-xl group-hover:animate-bounce"></i>
            </a>
            <a href="#" class="w-12 h-12 rounded-xl bg-gray-700/50 backdrop-blur-sm flex items-center justify-center hover:bg-gradient-to-br hover:from-red-500 hover:to-orange-500 transition-all hover:scale-110 hover:shadow-lg group" title="新浪微博">
              <i class="fa fa-weibo text-xl group-hover:animate-bounce"></i>
            </a>
            <a href="#" class="w-12 h-12 rounded-xl bg-gray-700/50 backdrop-blur-sm flex items-center justify-center hover:bg-gradient-to-br hover:from-blue-500 hover:to-blue-600 transition-all hover:scale-110 hover:shadow-lg group" title="QQ交流群">
              <i class="fa fa-qq text-xl group-hover:animate-bounce"></i>
            </a>
            <a href="#" class="w-12 h-12 rounded-xl bg-gray-700/50 backdrop-blur-sm flex items-center justify-center hover:bg-gradient-to-br hover:from-gray-600 hover:to-gray-700 transition-all hover:scale-110 hover:shadow-lg group" title="GitHub">
              <i class="fa fa-github text-xl group-hover:animate-bounce"></i>
            </a>
          </div>
          <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-4 border border-gray-700/50">
            <p class="text-gray-400 text-sm leading-relaxed mb-2">
              <i class="fa fa-qrcode text-blue-400 mr-2"></i>扫码关注公众号
            </p>
            <p class="text-gray-500 text-xs">获取更多学习资源和考试技巧</p>
          </div>
        </div>
      </div>
      
      <!-- 底部链接栏 -->
      <div class="border-t border-gray-700/50 pt-8">
        <div class="flex flex-wrap justify-center items-center gap-6 text-sm text-gray-500 mb-6">
          <a href="#" class="hover:text-white transition-colors">隐私政策</a>
          <span class="text-gray-700">|</span>
          <a href="#" class="hover:text-white transition-colors">用户协议</a>
          <span class="text-gray-700">|</span>
          <a href="#" class="hover:text-white transition-colors">开发文档</a>
          <span class="text-gray-700">|</span>
          <a href="#" class="hover:text-white transition-colors">API接口</a>
          <span class="text-gray-700">|</span>
          <a href="#" class="hover:text-white transition-colors">合作伙伴</a>
        </div>
        <p class="text-center text-gray-600 text-sm">让物理学习变得简单有趣 · Made with <i class="fa fa-heart text-red-500 mx-1 animate-pulse"></i> for students</p>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    /*
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                           JavaScript 主代码模块                             ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║  本文件包含所有前端逻辑，按照以下顺序组织：                                   ║
    ║                                                                            ║
    ║  1️⃣  全局变量与常量定义                                                     ║
    ║  2️⃣  辅助工具函数 (roundRect, drawWheel, shadeColor等)                      ║
    ║  3️⃣  Canvas初始化与渲染引擎                                                 ║
    ║  4️⃣  物理运动绘制函数 (drawHorizontalMotion, drawCircularMotion等)          ║
    ║  5️⃣  动画控制系统 (startAnimation, stopAnimation等)                         ║
    ║  6️⃣  参数管理 (getParams, fillFormFromAI等)                                 ║
    ║  7️⃣  AI解析模块 (parseDescriptionWithAI, 本地fallback)                      ║
    ║  8️⃣  题目导入功能 (图片上传, Word文档解析)                                   ║
    ║  9️⃣  导出功能 (GIF, MP4, CSV, JSON)                                         ║
    ║  🔟  UI事件监听器初始化                                                      ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
    */

    // ============================================================================
    // 📦 1. 全局变量与常量定义
    // ============================================================================
    
    // Canvas 相关全局变量
    let canvas, ctx;                    // Canvas元素和2D绘图上下文
    let animationFrameId = null;        // requestAnimationFrame 的ID，用于取消动画
    let currentTime = 0;                // 当前动画时间（秒）
    let isPlaying = false;              // 动画是否正在播放
    let playSpeed = 1;                  // 播放速度倍率
  let sceneParams = null;             // 当前场景的物理参数对象
  let sceneVisualSettings = {};       // 可视化提示词设置（风格/细节/高亮选项）

    // 根据 sceneParams.visual 或 sceneVisualSettings 生成绘图样式配置
    function getVisualConfig() {
      const v = (sceneParams && sceneParams.visual) ? sceneParams.visual : (sceneVisualSettings || {});
      const theme = v.theme || 'cartoon';
      const detail = v.detail || 'medium';
      const highlightApex = !!v.highlightApex;
      const showVelocity = v.showVelocity === undefined ? true : !!v.showVelocity;
      const useTrail = v.useTrail === undefined ? true : !!v.useTrail;

      // 基于主题选择配色
      const palettes = {
        cartoon: { ball: '#ff6b00', accent: '#0066ff', trail: '#ffd8b5' },
        realistic: { ball: '#2b6cb0', accent: '#0ea5a6', trail: '#cbd5e1' },
        minimal: { ball: '#111827', accent: '#6b7280', trail: '#e5e7eb' }
      };

      const p = palettes[theme] || palettes.cartoon;

      // 细节影响线宽与字体大小
      const detailCfg = { low: { lw: 1, rMult: 0.9 }, medium: { lw: 1.5, rMult: 1 }, high: { lw: 2.5, rMult: 1.3 } };
      const dc = detailCfg[detail] || detailCfg.medium;

      return {
        theme, detail, highlightApex, showVelocity, useTrail,
        ballColor: p.ball, arrowColor: p.accent, trailColor: p.trail,
        lineWidth: dc.lw, radiusMultiplier: dc.rMult
      };
    }
    
    // DOM 元素引用（避免重复查询）
    let animationContainer;             // Canvas容器元素
    let questionTypeSelect, generateButton, playBtn, pauseBtn; // 控制元素引用
    
    // ============================================================================
    // 📚 物理知识点库与题型分类系统
    // ============================================================================
    
    /**
     * 物理知识点库结构
     * 
     * 层级结构：
     * - 一级分类：力学、电磁学、热学、光学、近代物理
     * - 二级知识点：具体的物理概念
     * - 每个知识点包含：
     *   - id: 唯一标识符
     *   - name: 知识点名称
     *   - category: 所属分类
     *   - difficulty: 难度等级 (1-5)
     *   - formulas: 相关公式
     *   - description: 简要说明
     *   - relatedTypes: 关联的题型类型
     *   - examples: 典型例题
     */
    const KNOWLEDGE_BASE = {
      // 📐 力学
      mechanics: {
        name: '力学',
        icon: '📐',
        color: '#3b82f6',
        topics: {
          kinematics: {
            id: 'kinematics',
            name: '运动学',
            difficulty: 2,
            formulas: [
              'v = v₀ + at',
              's = v₀t + ½at²',
              'v² - v₀² = 2as',
              'v̄ = (v₀ + v)/2'
            ],
            description: '研究物体运动的描述，包括位移、速度、加速度等运动学量',
            relatedTypes: ['uniform', 'projectile'],
            keywords: ['位移', '速度', '加速度', '匀变速', '自由落体'],
            examples: [
              {
                title: '汽车刹车问题',
                description: '一辆汽车以20m/s的速度行驶，突然刹车，加速度大小为5m/s²，求刹车距离。',
                params: { v0: 20, a: -5, time: 4 },
                type: 'uniform',
                visual: {
                  objectType: 'car',
                  objectColor: '#ef4444',
                  backgroundColor: '#f3f4f6',
                  groundColor: '#374151',
                  showTrajectory: true,
                  showBrakeMarks: true,
                  theme: 'realistic'
                }
              }
            ]
          },
          interaction: {
            id: 'interaction',
            name: '相互作用',
            difficulty: 2,
            formulas: [
              'F = ma',
              'f = μN',
              'F = kx（胡克定律）',
              'F合 = √(F₁² + F₂²)（正交分解）'
            ],
            description: '研究力的性质、力的合成与分解、重力、弹力、摩擦力等',
            relatedTypes: ['uniform'],
            keywords: ['重力', '弹力', '摩擦力', '合力', '分解'],
            examples: [
              {
                title: '斜面上的物体',
                description: '质量5kg的物体在30°斜面上静止，求摩擦力和支持力。',
                params: { m: 5, angle: 30, mu: 0.3 },
                type: 'uniform',
                visual: {
                  objectType: 'box',
                  objectColor: '#f59e0b',
                  backgroundColor: '#fef3c7',
                  groundColor: '#92400e',
                  showTrajectory: false,
                  showForces: true,
                  theme: 'physics'
                }
              }
            ]
          },
          newtonLaws: {
            id: 'newtonLaws',
            name: '牛顿运动定律',
            difficulty: 3,
            formulas: [
              'F = ma',
              'F₁₂ = -F₂₁',
              'a = F/m'
            ],
            description: '牛顿三大运动定律及其应用，包括惯性、加速度、作用力与反作用力',
            relatedTypes: ['uniform'],
            keywords: ['惯性', '加速度', '作用力', '反作用力', '牛顿第二定律'],
            examples: [
              {
                title: '火车加速启动',
                description: '火车从静止开始匀加速启动，加速度为2m/s²，求5秒后的速度和位移。',
                params: { v0: 0, a: 2, time: 5 },
                type: 'uniform',
                visual: {
                  objectType: 'train',
                  objectColor: '#3b82f6',
                  backgroundColor: '#dbeafe',
                  groundColor: '#1e3a8a',
                  showTrajectory: true,
                  showSpeedLines: true,
                  theme: 'realistic'
                }
              }
            ]
          },
          gravityAndSpace: {
            id: 'gravityAndSpace',
            name: '万有引力与航天',
            difficulty: 4,
            formulas: [
              'F = GMm/r²',
              'v = √(GM/r)',
              'T = 2π√(r³/GM)',
              'g = GM/R²'
            ],
            description: '万有引力定律、天体运动、人造卫星、宇宙速度',
            relatedTypes: ['astrodynamics', 'circular'],
            keywords: ['万有引力', '卫星', '轨道', '宇宙速度', '开普勒'],
            examples: [
              {
                title: '地球卫星轨道',
                description: '计算距地面400km高度的卫星运行周期和速度。',
                params: { M: 5.97e24, r: 6.77e6 },
                type: 'circular',
                visual: {
                  objectType: 'satellite',
                  objectColor: '#cbd5e1',
                  backgroundColor: '#0f172a',
                  planetColor: '#3b82f6',
                  orbitColor: '#94a3b8',
                  showTrajectory: true,
                  showOrbitPath: true,
                  showStars: true,
                  theme: 'space'
                }
              }
            ]
          },
          workAndEnergy: {
            id: 'workAndEnergy',
            name: '功和能',
            difficulty: 3,
            formulas: [
              'W = Fs·cosθ',
              'Ek = ½mv²',
              'Ep = mgh',
              'W合 = ΔEk（动能定理）'
            ],
            description: '功、功率、动能、势能、机械能守恒定律',
            relatedTypes: ['uniform', 'projectile'],
            keywords: ['功', '功率', '动能', '势能', '机械能守恒'],
            examples: [
              {
                title: '平抛运动能量',
                description: '小球从10m高的平台水平抛出，初速度8m/s，求落地时的速度。',
                params: { speed: 8, angle: 0, height: 10 },
                type: 'projectile',
                visual: {
                  objectType: 'ball',
                  objectColor: '#8b5cf6',
                  backgroundColor: '#ede9fe',
                  groundColor: '#6d28d9',
                  showTrajectory: true,
                  trajectoryStyle: 'solid',
                  showPlatform: true,
                  platformHeight: 10,
                  theme: 'minimalist'
                }
              }
            ]
          },
          momentum: {
            id: 'momentum',
            name: '动量',
            difficulty: 4,
            formulas: [
              'p = mv',
              'm₁v₁ + m₂v₂ = m₁v₁\' + m₂v₂\'',
              'I = Ft = Δp（动量定理）',
              'F₁₂ = -F₂₁（动量守恒）'
            ],
            description: '动量、动量定理、动量守恒定律、碰撞问题',
            relatedTypes: ['collision'],
            keywords: ['动量', '冲量', '碰撞', '动量守恒', '完全弹性'],
            examples: [
              {
                title: '弹性碰撞',
                description: '质量为2kg的小球以5m/s撞击质量为1kg的静止小球，发生弹性碰撞。',
                params: { m1: 2, v1: 5, m2: 1, v2: 0 },
                type: 'collision',
                visual: {
                  objectType: 'billiard',
                  object1Color: '#dc2626',
                  object2Color: '#fbbf24',
                  backgroundColor: '#065f46',
                  groundColor: '#047857',
                  showTrajectory: true,
                  showCollisionEffect: true,
                  theme: 'billiards'
                }
              }
            ]
          },
          vibrationAndWave: {
            id: 'vibrationAndWave',
            name: '机械振动与波',
            difficulty: 4,
            formulas: [
              'x = Asin(ωt + φ)',
              'T = 2π/ω',
              'v = λf',
              'f = 1/T'
            ],
            description: '简谐运动、单摆、弹簧振子、机械波的传播',
            relatedTypes: ['circular'],
            keywords: ['简谐运动', '振幅', '周期', '频率', '波长'],
            examples: [
              {
                title: '单摆运动',
                description: '摆长为1m的单摆做简谐运动，求其周期。',
                params: { length: 1, g: 10 },
                type: 'circular',
                visual: {
                  objectType: 'pendulum',
                  objectColor: '#06b6d4',
                  backgroundColor: '#e0f2fe',
                  centerColor: '#0284c7',
                  showTrajectory: true,
                  showRadius: true,
                  theme: 'physics'
                }
              }
            ]
          }
        }
      },
      
      // ⚡ 电磁学
      electromagnetism: {
        name: '电磁学',
        icon: '⚡',
        color: '#8b5cf6',
        topics: {
          electrostaticField: {
            id: 'electrostaticField',
            name: '静电场',
            difficulty: 3,
            formulas: [
              'F = kq₁q₂/r²（库仑定律）',
              'E = F/q（电场强度）',
              'U = W/q（电势差）',
              'C = Q/U（电容）'
            ],
            description: '电荷、电场强度、电势、电势差、电容等静电场基本概念',
            relatedTypes: ['electrostatic'],
            keywords: ['电荷', '电场', '电势', '电容', '库仑定律'],
            examples: [
              {
                title: '点电荷电场',
                description: '两个点电荷q₁=+2×10⁻⁶C和q₂=-3×10⁻⁶C相距0.1m，求它们之间的作用力。',
                params: { q1: 2e-6, q2: -3e-6, r: 0.1 },
                type: 'uniform',
                visual: {
                  objectType: 'charge',
                  objectColor: '#ef4444',
                  backgroundColor: '#fef2f2',
                  groundColor: '#7f1d1d',
                  showTrajectory: false,
                  showFieldLines: true,
                  theme: 'electric'
                }
              }
            ]
          },
          constantCurrent: {
            id: 'constantCurrent',
            name: '恒定电流',
            difficulty: 2,
            formulas: [
              'I = Q/t',
              'U = IR（欧姆定律）',
              'P = UI = I²R = U²/R',
              'Q = I²Rt（焦耳定律）'
            ],
            description: '电流、电阻、欧姆定律、电功率、焦耳定律',
            relatedTypes: ['circuit'],
            keywords: ['电流', '电阻', '欧姆定律', '电功率', '串并联'],
            examples: [
              {
                title: '电路计算',
                description: '一个20Ω的电阻接在12V电源上，求通过的电流和消耗的功率。',
                params: { R: 20, U: 12 },
                type: 'uniform',
                visual: {
                  objectType: 'circuit',
                  objectColor: '#3b82f6',
                  backgroundColor: '#eff6ff',
                  groundColor: '#1e3a8a',
                  showTrajectory: false,
                  showCurrent: true,
                  theme: 'circuit'
                }
              }
            ]
          },
          magneticField: {
            id: 'magneticField',
            name: '磁场',
            difficulty: 4,
            formulas: [
              'F = BIL（安培力）',
              'F = qvB（洛伦兹力）',
              'r = mv/(qB)',
              'T = 2πm/(qB)'
            ],
            description: '磁感应强度、安培力、洛伦兹力、带电粒子在磁场中的运动',
            relatedTypes: ['magnetic'],
            keywords: ['磁场', '安培力', '洛伦兹力', '偏转', '回旋'],
            examples: [
              {
                title: '电子在磁场中运动',
                description: '电子以1×10⁶m/s速度垂直进入0.5T的匀强磁场，求运动半径。',
                params: { q: 1.6e-19, v: 1e6, B: 0.5 },
                type: 'magnetic',
                visual: {
                  objectType: 'electron',
                  objectColor: '#3b82f6',
                  backgroundColor: '#1e1b4b',
                  magneticFieldColor: '#a78bfa',
                  showTrajectory: true,
                  showMagneticLines: true,
                  showForceVector: true,
                  theme: 'electromagnetic'
                }
              }
            ]
          },
          electromagneticInduction: {
            id: 'electromagneticInduction',
            name: '电磁感应',
            difficulty: 4,
            formulas: [
              'E = BLv（导体棒切割磁感线）',
              'E = nΔΦ/Δt（法拉第电磁感应定律）',
              'Φ = BS（磁通量）'
            ],
            description: '电磁感应现象、法拉第电磁感应定律、楞次定律',
            relatedTypes: ['induction'],
            keywords: ['电磁感应', '磁通量', '感应电动势', '楞次定律'],
            examples: [
              {
                title: '导体棒切割磁感线',
                description: '长0.5m的导体棒在B=0.8T的磁场中以v=10m/s速度垂直切割磁感线，求感应电动势。',
                params: { B: 0.8, L: 0.5, v: 10 },
                type: 'uniform',
                visual: {
                  objectType: 'rod',
                  objectColor: '#06b6d4',
                  backgroundColor: '#ecfeff',
                  groundColor: '#164e63',
                  showTrajectory: true,
                  showMagneticField: true,
                  theme: 'induction'
                }
              }
            ]
          },
          alternatingCurrent: {
            id: 'alternatingCurrent',
            name: '交变电流',
            difficulty: 3,
            formulas: [
              'u = U_m·sinωt',
              'i = I_m·sin(ωt±φ)',
              'U = U_m/√2（有效值）',
              'P = UIcosφ（交流功率）'
            ],
            description: '交变电流的产生、描述、有效值、变压器、远距离输电',
            relatedTypes: ['ac'],
            keywords: ['交流电', '有效值', '变压器', '频率', '相位'],
            examples: [
              {
                title: '交流电有效值',
                description: '正弦交流电的峰值电压为311V，求其有效值和周期（f=50Hz）。',
                params: { Um: 311, f: 50 },
                type: 'circular',
                visual: {
                  objectType: 'wave',
                  objectColor: '#8b5cf6',
                  backgroundColor: '#faf5ff',
                  groundColor: '#581c87',
                  showTrajectory: true,
                  showWaveform: true,
                  theme: 'ac'
                }
              }
            ]
          },
          electromagneticWave: {
            id: 'electromagneticWave',
            name: '电磁场与电磁波',
            difficulty: 4,
            formulas: [
              'c = λf',
              'E = hν（光子能量）',
              'c = 3×10⁸ m/s'
            ],
            description: '电磁场理论、电磁波的产生和传播、电磁波谱',
            relatedTypes: ['wave'],
            keywords: ['电磁波', '麦克斯韦', '波速', '频率', '波长'],
            examples: [
              {
                title: '电磁波波长计算',
                description: '频率为100MHz的电磁波，求其波长。',
                params: { f: 100e6, c: 3e8 },
                type: 'projectile',
                visual: {
                  objectType: 'wave',
                  objectColor: '#ec4899',
                  backgroundColor: '#fdf2f8',
                  groundColor: '#831843',
                  showTrajectory: true,
                  showWavePattern: true,
                  theme: 'electromagnetic'
                }
              }
            ]
          }
        }
      },
      
      // 🔥 热力学
      thermodynamics: {
        name: '热力学',
        icon: '🔥',
        color: '#f59e0b',
        topics: {
          molecularKineticTheory: {
            id: 'molecularKineticTheory',
            name: '分子动理论',
            difficulty: 3,
            formulas: [
              'Ek = (3/2)kT（分子平均动能）',
              'PV = nRT（理想气体状态方程）',
              'P = (1/3)ρv̄²（气体压强微观解释）'
            ],
            description: '物质的微观结构、分子热运动、分子力、分子动能与温度的关系',
            relatedTypes: ['thermal'],
            keywords: ['分子运动', '布朗运动', '扩散', '内能', '温度'],
            examples: [
              {
                title: '理想气体状态变化',
                description: '一定质量的理想气体，压强为1atm，体积为2L，温度为300K，若等温膨胀到4L，求压强变化。',
                params: { P1: 1, V1: 2, T1: 300, V2: 4 },
                type: 'uniform',
                visual: {
                  objectType: 'gas',
                  objectColor: '#06b6d4',
                  backgroundColor: '#ecfeff',
                  groundColor: '#155e75',
                  showTrajectory: false,
                  showMolecules: true,
                  theme: 'thermal'
                }
              }
            ]
          },
          thermodynamicLaws: {
            id: 'thermodynamicLaws',
            name: '热力学第一、二定律',
            difficulty: 4,
            formulas: [
              'ΔU = Q + W（热力学第一定律）',
              'Q = cmΔT（比热容）',
              'W = PΔV（等压过程功）',
              'η = 1 - T₂/T₁（卡诺循环效率）'
            ],
            description: '能量守恒与转化、热力学过程、热机效率、热力学第二定律',
            relatedTypes: ['thermal'],
            keywords: ['内能', '热量', '做功', '能量守恒', '熵'],
            examples: [
              {
                title: '气体等容过程',
                description: '一定质量的理想气体做等容变化，吸收热量500J，求内能变化。',
                params: { Q: 500, W: 0 },
                type: 'uniform',
                visual: {
                  objectType: 'container',
                  objectColor: '#f59e0b',
                  backgroundColor: '#fff7ed',
                  groundColor: '#92400e',
                  showTrajectory: false,
                  showHeat: true,
                  theme: 'thermal'
                }
              }
            ]
          },
          statesOfMatter: {
            id: 'statesOfMatter',
            name: '固体、液体与物态变化',
            difficulty: 3,
            formulas: [
              'ΔL = αL₀ΔT（热膨胀）',
              'Q = mL（熔化或凝固）',
              'Q = mL（汽化或液化）',
              'F = σL（表面张力）'
            ],
            description: '晶体与非晶体、固体的微观结构、液体的表面张力、物态变化与潜热',
            relatedTypes: ['thermal'],
            keywords: ['晶体', '熔化', '凝固', '汽化', '表面张力'],
            examples: [
              {
                title: '金属棒热膨胀',
                description: '长度为1m的铁棒，温度从20°C升高到120°C，求伸长量（α=1.2×10⁻⁵/°C）。',
                params: { L0: 1, alpha: 1.2e-5, deltaT: 100 },
                type: 'uniform',
                visual: {
                  objectType: 'bar',
                  objectColor: '#94a3b8',
                  backgroundColor: '#fef3c7',
                  groundColor: '#9a3412',
                  showTrajectory: false,
                  showExpansion: true,
                  theme: 'thermal'
                }
              }
            ]
          }
        }
      },
      
      // 💡 光学
      optics: {
        name: '光学',
        icon: '💡',
        color: '#eab308',
        topics: {
          geometricOptics: {
            id: 'geometricOptics',
            name: '几何光学',
            difficulty: 2,
            formulas: [
              'i = r（反射定律）',
              'n₁sinθ₁ = n₂sinθ₂（折射定律）',
              '1/f = 1/u + 1/v（透镜公式）',
              'sinC = 1/n（全反射临界角）'
            ],
            description: '光的直线传播、反射、折射、全反射、透镜成像',
            relatedTypes: ['optics'],
            keywords: ['反射', '折射', '透镜', '折射率', '全反射', '成像'],
            examples: [
              {
                title: '光的折射',
                description: '光从空气（n=1.0）射入水中（n=1.33），入射角30°，求折射角。',
                params: { n1: 1.0, n2: 1.33, theta1: 30 },
                type: 'projectile',
                visual: {
                  objectType: 'light',
                  objectColor: '#fef08a',
                  backgroundColor: '#eff6ff',
                  groundColor: '#1e40af',
                  showTrajectory: true,
                  trajectoryStyle: 'solid',
                  theme: 'optics'
                }
              }
            ]
          },
          physicalOptics: {
            id: 'physicalOptics',
            name: '物理光学',
            difficulty: 4,
            formulas: [
              'Δx = λL/d（双缝干涉）',
              'dsinθ = kλ（光栅衍射）',
              '2nd = kλ（薄膜干涉）',
              'I = I₀cos²(Δφ/2)（干涉强度）'
            ],
            description: '光的干涉、衍射、偏振现象，证明光的波动性',
            relatedTypes: ['wave'],
            keywords: ['干涉', '衍射', '偏振', '双缝实验', '薄膜'],
            examples: [
              {
                title: '双缝干涉',
                description: '波长600nm的单色光通过间距0.2mm的双缝，屏幕距离1m，求相邻明纹间距。',
                params: { lambda: 600e-9, d: 0.2e-3, L: 1 },
                type: 'projectile',
                visual: {
                  objectType: 'wave',
                  objectColor: '#fbbf24',
                  backgroundColor: '#fffbeb',
                  groundColor: '#78350f',
                  showTrajectory: true,
                  showInterference: true,
                  theme: 'wave'
                }
              }
            ]
          },
          waveparticleDuality: {
            id: 'waveparticleDuality',
            name: '波粒二象性',
            difficulty: 5,
            formulas: [
              'E = hν（光子能量）',
              'p = h/λ（光子动量）',
              'λ = h/p（德布罗意波长）',
              'Ek = hν - W₀（光电效应）'
            ],
            description: '光电效应、康普顿效应、德布罗意波，光和物质的波粒二象性',
            relatedTypes: ['quantum'],
            keywords: ['光电效应', '光子', '德布罗意波', '波粒二象性', '量子'],
            examples: [
              {
                title: '光电效应',
                description: '波长为400nm的光照射金属表面，金属的逸出功为2.5eV，求光电子的最大动能。',
                params: { wavelength: 400e-9, workFunction: 2.5 },
                type: 'uniform',
                visual: {
                  objectType: 'photon',
                  objectColor: '#a855f7',
                  backgroundColor: '#faf5ff',
                  groundColor: '#581c87',
                  showTrajectory: true,
                  showPhotons: true,
                  theme: 'quantum'
                }
              }
            ]
          }
        }
      },
      
      // ⚛️ 原子物理学
      atomicPhysics: {
        name: '原子物理学',
        icon: '⚛️',
        color: '#10b981',
        topics: {
          atomicStructure: {
            id: 'atomicStructure',
            name: '原子结构',
            difficulty: 4,
            formulas: [
              'E = hν（光子能量）',
              'En = -13.6/n² eV（氢原子能级）',
              'hν = Em - En（跃迁辐射）',
              'λ = h/p（德布罗意波长）'
            ],
            description: '原子的核式结构、玻尔理论、氢原子光谱、能级跃迁',
            relatedTypes: ['atomic'],
            keywords: ['原子模型', '能级', '光谱', '跃迁', '玻尔理论'],
            examples: [
              {
                title: '氢原子能级跃迁',
                description: '氢原子从n=3能级跃迁到n=2能级，求辐射光子的能量和波长。',
                params: { n1: 3, n2: 2 },
                type: 'uniform',
                visual: {
                  objectType: 'atom',
                  objectColor: '#10b981',
                  backgroundColor: '#f0fdf4',
                  groundColor: '#065f46',
                  showTrajectory: false,
                  showEnergyLevels: true,
                  theme: 'quantum'
                }
              }
            ]
          },
          nucleus: {
            id: 'nucleus',
            name: '原子核',
            difficulty: 4,
            formulas: [
              'A = N + Z（质量数）',
              'ΔN = N₀(1/2)^(t/T)（半衰期）',
              '²³⁸U → ²³⁴Th + ⁴He（α衰变）',
              '¹⁴C → ¹⁴N + e⁻（β衰变）'
            ],
            description: '原子核的组成、放射性、衰变规律、半衰期',
            relatedTypes: ['nuclear'],
            keywords: ['原子核', '同位素', '放射性', '衰变', '半衰期'],
            examples: [
              {
                title: '放射性衰变',
                description: '某放射性元素的半衰期为10天，初始质量为100g，求20天后剩余质量。',
                params: { N0: 100, T: 10, t: 20 },
                type: 'uniform',
                visual: {
                  objectType: 'nucleus',
                  objectColor: '#ef4444',
                  backgroundColor: '#fef2f2',
                  groundColor: '#7f1d1d',
                  showTrajectory: false,
                  showDecay: true,
                  theme: 'nuclear'
                }
              }
            ]
          },
          nuclearEnergy: {
            id: 'nuclearEnergy',
            name: '核能',
            difficulty: 5,
            formulas: [
              'E = mc²（质能方程）',
              'ΔE = Δm·c²（核反应能量）',
              '²H + ³H → ⁴He + n（核聚变）',
              '²³⁵U + n → 裂变产物（核裂变）'
            ],
            description: '质能方程、核裂变、核聚变、结合能',
            relatedTypes: ['nuclear'],
            keywords: ['核能', '裂变', '聚变', '质能方程', '结合能'],
            examples: [
              {
                title: '核聚变能量计算',
                description: '氘氚聚变反应中，质量亏损为0.019u，求释放的能量（1u = 931.5MeV/c²）。',
                params: { dm: 0.019, c2: 931.5 },
                type: 'uniform',
                visual: {
                  objectType: 'fusion',
                  objectColor: '#f59e0b',
                  backgroundColor: '#fffbeb',
                  groundColor: '#78350f',
                  showTrajectory: false,
                  showEnergy: true,
                  theme: 'nuclear'
                }
              }
            ]
          },
          modernPhysics: {
            id: 'modernPhysics',
            name: '近代物理基础',
            difficulty: 5,
            formulas: [
              'Ek = hν - W₀（光电效应）',
              'λ = h/mv（德布罗意波）',
              'ΔE·Δt ≥ ℏ/2（不确定性原理）',
              'E² = (pc)² + (mc²)²（相对论能量）'
            ],
            description: '光电效应、康普顿效应、波粒二象性、相对论初步、量子理论',
            relatedTypes: ['quantum', 'relativity'],
            keywords: ['光电效应', '波粒二象性', '量子论', '相对论', '不确定性'],
            examples: [
              {
                title: '光电效应',
                description: '波长为400nm的光照射金属表面，金属的逸出功为2.5eV，求光电子的最大动能。',
                params: { wavelength: 400e-9, workFunction: 2.5 },
                type: 'uniform',
                visual: {
                  objectType: 'electron',
                  objectColor: '#3b82f6',
                  backgroundColor: '#1e1b4b',
                  groundColor: '#c7d2fe',
                  showTrajectory: true,
                  showPhotons: true,
                  theme: 'quantum'
                }
              }
            ]
          }
        }
      }
    };
    
    /**
     * 题型分类系统
     * 
     * 按照5大物理分支,每个分支包含3个难度等级
     */
    const QUESTION_TAXONOMY = {
      mechanics: {
        name: '力学',
        icon: '📐',
        color: 'from-blue-500 to-cyan-500',
        difficulties: {
          easy: {
            name: '简单题',
            level: 1,
            description: '基础力学问题,涉及匀速、匀变速直线运动',
            examples: ['汽车刹车距离', '自由落体', '滑块运动'],
            keywords: ['匀速', '匀变速', '加速度', '位移', '速度']
          },
          medium: {
            name: '中档题',
            level: 2,
            description: '抛体运动、圆周运动、动力学综合问题',
            examples: ['平抛运动', '圆周运动', '传送带', '弹簧振子'],
            keywords: ['抛体', '圆周', '向心力', '功能关系']
          },
          hard: {
            name: '难题',
            level: 3,
            description: '碰撞、天体运动、动量守恒综合应用',
            examples: ['完全弹性碰撞', '双星系统', '火箭变质量', '万有引力'],
            keywords: ['碰撞', '动量守恒', '卫星变轨', '开普勒']
          }
        }
      },
      electromagnetism: {
        name: '电磁学',
        icon: '⚡',
        color: 'from-yellow-500 to-orange-500',
        difficulties: {
          easy: {
            name: '简单题',
            level: 1,
            description: '基本电场、磁场问题',
            examples: ['点电荷电场强度', '匀强磁场中的带电粒子', '欧姆定律'],
            keywords: ['电场强度', '磁感应强度', '电阻', '电流']
          },
          medium: {
            name: '中档题',
            level: 2,
            description: '电磁感应、交变电流问题',
            examples: ['法拉第电磁感应', '变压器', 'LC振荡电路'],
            keywords: ['电磁感应', '感应电动势', '变压器', '交流电']
          },
          hard: {
            name: '难题',
            level: 3,
            description: '复合场、电磁感应综合问题',
            examples: ['速度选择器', '质谱仪', '电磁炮', '霍尔效应'],
            keywords: ['复合场', '洛伦兹力', '电磁波', '麦克斯韦方程']
          }
        }
      },
      thermodynamics: {
        name: '热力学',
        icon: '🔥',
        color: 'from-red-500 to-pink-500',
        difficulties: {
          easy: {
            name: '简单题',
            level: 1,
            description: '理想气体状态方程、内能基础问题',
            examples: ['等温过程', '等容过程', '等压过程', '理想气体'],
            keywords: ['状态方程', '内能', '温度', '压强', '体积']
          },
          medium: {
            name: '中档题',
            level: 2,
            description: '热力学第一定律、循环过程',
            examples: ['绝热过程', '卡诺循环', '热机效率'],
            keywords: ['热力学第一定律', '做功', '吸热', '放热', '循环']
          },
          hard: {
            name: '难题',
            level: 3,
            description: '熵、热力学第二定律、统计物理',
            examples: ['熵增原理', '可逆过程', '玻尔兹曼分布'],
            keywords: ['熵', '热力学第二定律', '可逆', '不可逆', '统计']
          }
        }
      },
      optics: {
        name: '光学',
        icon: '💡',
        color: 'from-purple-500 to-indigo-500',
        difficulties: {
          easy: {
            name: '简单题',
            level: 1,
            description: '几何光学基础,反射与折射',
            examples: ['平面镜成像', '凸透镜成像', '折射定律'],
            keywords: ['反射', '折射', '全反射', '透镜', '折射率']
          },
          medium: {
            name: '中档题',
            level: 2,
            description: '光的干涉、衍射、偏振',
            examples: ['双缝干涉', '薄膜干涉', '单缝衍射', '偏振光'],
            keywords: ['干涉', '衍射', '偏振', '相干', '光程差']
          },
          hard: {
            name: '难题',
            level: 3,
            description: '波粒二象性、光电效应综合',
            examples: ['光电效应', '康普顿散射', '德布罗意波'],
            keywords: ['光子', '光电效应', '康普顿', '波粒二象性']
          }
        }
      },
      atomicPhysics: {
        name: '原子物理学',
        icon: '⚛️',
        color: 'from-green-500 to-teal-500',
        difficulties: {
          easy: {
            name: '简单题',
            level: 1,
            description: '原子结构、能级跃迁基础',
            examples: ['氢原子光谱', '能级图', '电子跃迁'],
            keywords: ['原子', '能级', '光谱', '量子数', '轨道']
          },
          medium: {
            name: '中档题',
            level: 2,
            description: '原子核反应、放射性衰变',
            examples: ['α衰变', 'β衰变', 'γ辐射', '半衰期'],
            keywords: ['原子核', '衰变', '放射性', '半衰期', '核反应']
          },
          hard: {
            name: '难题',
            level: 3,
            description: '核能计算、质能方程、粒子物理',
            examples: ['核裂变', '核聚变', '质能转换', '粒子对撞'],
            keywords: ['核能', '质能方程', '裂变', '聚变', '粒子']
          }
        }
      }
    };
    
    /**
     * 根据题目描述自动识别相关知识点
     * @param {string} description - 题目描述文本
     * @returns {Array} 匹配的知识点ID列表
     */
    function detectKnowledgePoints(description) {
      const matched = [];
      const text = description.toLowerCase();
      
      for (const [categoryKey, category] of Object.entries(KNOWLEDGE_BASE)) {
        for (const [topicKey, topic] of Object.entries(category.topics)) {
          // 检查关键词是否出现在题目中
          if (topic.keywords.some(keyword => text.includes(keyword.toLowerCase()))) {
            matched.push(topic.id);
          }
        }
      }
      
      return matched;
    }
    
    /**
     * 获取知识点详情
     * @param {string} knowledgeId - 知识点ID
     * @returns {Object|null} 知识点对象
     */
    function getKnowledgePoint(knowledgeId) {
      for (const category of Object.values(KNOWLEDGE_BASE)) {
        if (category.topics[knowledgeId]) {
          return {
            ...category.topics[knowledgeId],
            categoryName: category.name,
            categoryIcon: category.icon,
            categoryColor: category.color
          };
        }
      }
      return null;
    }
    
    /**
     * 按分类、难度、场景筛选题型
     * @param {Object} filters - 筛选条件 {category, difficulty, scenario}
     * @returns {Array} 符合条件的题型列表
     */
    /**
     * 筛选题型(已废弃,新结构使用下拉菜单直接选择)
     * 保留此函数以防其他地方有引用
     */
    function filterQuestionTypes(filters = {}) {
      const results = [];
      
      for (const [categoryKey, category] of Object.entries(QUESTION_TAXONOMY)) {
        for (const [diffKey, difficulty] of Object.entries(category.difficulties)) {
          let match = true;
          
          // 按分类筛选
          if (filters.category && categoryKey !== filters.category) {
            match = false;
          }
          
          // 按难度等级筛选
          if (filters.level && difficulty.level !== filters.level) {
            match = false;
          }
          
          if (match) {
            results.push({
              categoryKey,
              diffKey,
              categoryName: category.name,
              categoryIcon: category.icon,
              ...difficulty
            });
          }
        }
      }
      
      return results;
    }
    
    // 初始化Canvas
    function initCanvas() {
      canvas = document.getElementById('physics-canvas');
      if (!canvas) {
        console.error('找不到physics-canvas元素');
        return;
      }
      
      ctx = canvas.getContext('2d');
      
      // 初始化容器引用
      if (!animationContainer) {
        animationContainer = document.getElementById('animation-container');
      }
      
      // 设置Canvas尺寸
      const container = document.getElementById('animation-container');
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
      
      console.log('✓ Canvas已初始化:', canvas.width, 'x', canvas.height);
      
      // 绘制初始提示
      drawWelcomeScreen();
    }
    
    // 绘制欢迎屏幕
    function drawWelcomeScreen() {
      if (!ctx) return;
      
      const w = canvas.width;
      const h = canvas.height;
      
      // 白色背景
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, w, h);
      
      // 提示文字
      ctx.fillStyle = '#666666';
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('👆 导入题目并点击"生成可视化"', w / 2, h / 2 - 20);
      ctx.font = '16px Arial';
      ctx.fillText('即可在此查看完整的物理场景动画', w / 2, h / 2 + 20);
      
      ctx.textAlign = 'left';
    }
    
    // 页面加载时初始化
    window.addEventListener('load', () => {
      setTimeout(initCanvas, 100);
    });
    
    // 窗口大小改变时重新调整Canvas
    window.addEventListener('resize', () => {
      if (canvas && canvas.parentElement) {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        if (sceneParams) {
          drawScene();
        } else {
          drawWelcomeScreen();
        }
      }
    });
    
    // ============================================================================
    // 🎨 3. Canvas渲染引擎 - 主调度函数
    // ============================================================================
    
    /**
     * 绘制物理场景的主函数
     * 
     * 功能说明：
     * - 根据 sceneParams.type 分发到不同的绘制函数
     * - 支持的题型：uniform(匀变速)、projectile(抛体)、circular(圆周)、collision(碰撞)
     * - 如果场景来自AI，会在画布顶部显示"✨ AI 精确场景"标记
     * 
     * @requires sceneParams - 全局场景参数对象，必须包含 type 字段
     * @requires ctx - Canvas 2D上下文，必须已初始化
     */
    /**
     * 应用视觉主题到Canvas
     * 根据 sceneParams.visual 设置背景颜色、物体颜色等
     */
    function applyVisualTheme() {
      if (!ctx || !canvas || !sceneParams) return;
      
      const visual = sceneParams.visual || {};
      const w = canvas.width;
      const h = canvas.height;
      
      // 设置背景颜色（默认白色）
      ctx.fillStyle = visual.backgroundColor || '#ffffff';
      ctx.fillRect(0, 0, w, h);
      
      // 如果有地面颜色，绘制地面（下方1/4区域）
      if (visual.groundColor) {
        ctx.fillStyle = visual.groundColor;
        ctx.fillRect(0, h * 0.75, w, h * 0.25);
      }
      
      // 如果是太空主题，绘制星星
      if (visual.showStars && visual.theme === 'space') {
        ctx.fillStyle = '#ffffff';
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * w;
          const y = Math.random() * h;
          const size = Math.random() * 2;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      // 返回主要物体颜色供绘制函数使用
      return {
        objectColor: visual.objectColor || '#3b82f6',
        trajectoryColor: visual.trajectoryColor || 'rgba(59, 130, 246, 0.3)',
        showTrajectory: visual.showTrajectory !== false,
        theme: visual.theme || 'default'
      };
    }
    
    function drawScene() {
      console.log('🎨 drawScene() 被调用');
      console.log('   ctx:', !!ctx);
      console.log('   sceneParams:', !!sceneParams);
      console.log('   canvas.width:', canvas?.width);
      console.log('   canvas.height:', canvas?.height);

      // 前置检查：确保Canvas和参数已准备好
      if (!ctx || !sceneParams) {
        console.warn('⚠️ drawScene() 提前返回：ctx 或 sceneParams 不存在');
        return;
      }

      const w = canvas.width;
      const h = canvas.height;
      console.log('   准备绘制，尺寸:', w, 'x', h);

      // 步骤1：应用视觉主题（清空画布+背景+装饰元素）
      const visualStyle = applyVisualTheme();
      console.log('   已应用视觉主题:', visualStyle);

      // 步骤2：设置默认绘图样式
      ctx.strokeStyle = visualStyle?.objectColor || '#000000';
      ctx.fillStyle = visualStyle?.objectColor || '#000000';
      ctx.lineWidth = 2;
      ctx.font = '14px Arial';

      // 步骤3：根据题型分发到对应的绘制函数
      switch(sceneParams.type) {
        case 'uniform':
          // 匀变速直线运动：根据方向选择水平或垂直渲染
          const direction = sceneParams.direction || window.MOTION_DIRECTION || 'vertical';
          console.log('🎨 匀变速运动方向:', direction);
          
          if (direction === 'horizontal') {
            drawHorizontalMotion(visualStyle);    // 传递视觉样式
          } else {
            drawVerticalMotion(visualStyle);
          }
          break;
          
        case 'projectile':
          drawProjectileMotion(visualStyle);      // 传递视觉样式
          break;
          
        case 'circular':
          drawCircularMotion(visualStyle);        // 传递视觉样式
          break;
          
        case 'collision':
          drawCollision(visualStyle);             // 传递视觉样式
          break;
          
        default:
          // 默认使用垂直运动
          drawVerticalMotion(visualStyle);
      }
    }    // 通知提示函数（需要在控制函数之前定义）
    function showNotification(message, type = 'info', duration = 2000) {
      const colors = {
        success: 'bg-green-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500',
        error: 'bg-red-500'
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg z-50`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, duration);
    }
    
    // ========== 初始化控制按钮 ==========
    // 确保DOM加载完成后再绑定按钮
    let buttonsInitialized = false;
    
    function initControlButtons() {
      if (buttonsInitialized) return;
      
      const playBtn = document.getElementById('play-animation');
      const pauseBtn = document.getElementById('pause-animation');
      const resetBtn = document.getElementById('reset-animation');
      const speedSlider = document.getElementById('animation-speed');
      const speedDisplay = document.getElementById('speed-display');
      
      console.log('🎮 初始化控制按钮:', {
        playBtn: !!playBtn,
        pauseBtn: !!pauseBtn,
        resetBtn: !!resetBtn,
        speedSlider: !!speedSlider
      });
      
      if (!playBtn || !pauseBtn || !resetBtn) {
        console.error('❌ 控制按钮未找到！将在500ms后重试...');
        setTimeout(initControlButtons, 500);
        return;
      }
      
      // 绑定控制按钮
      playBtn.addEventListener('click', () => {
        console.log('🖱️ 播放按钮被点击');
        startAnimation();
      });
      pauseBtn.addEventListener('click', () => {
        console.log('🖱️ 暂停按钮被点击');
        pauseAnimation();
      });
      resetBtn.addEventListener('click', () => {
        console.log('🖱️ 重置按钮被点击');
        resetAnimation();
      });
      speedSlider?.addEventListener('input', (e) => {
        playSpeed = parseFloat(e.target.value);
        if (speedDisplay) {
          speedDisplay.textContent = playSpeed.toFixed(1) + 'x';
        }
      });
      
      buttonsInitialized = true;
      console.log('✅ 控制按钮已绑定');
    }
    
    // ============================================================================
    // ▶️ 6. 动画控制模块 - 播放/暂停/重置/速度控制
    // ============================================================================
    
    /**
     * 开始播放动画
     * 
     * 功能说明：
     * - 检查场景是否已生成（sceneParams 不为空）
     * - 防止重复播放（如果已在播放则跳过）
     * - 切换播放/暂停按钮状态（普通模式+全屏模式）
     * - 启动 animate() 函数（requestAnimationFrame 循环）
     * 
     * 按钮更新：
     * - 普通模式：#play-animation 隐藏，#pause-animation 显示
     * - 全屏模式：#fs-play 隐藏，#fs-pause 显示
     * 
     * @requires sceneParams - 场景参数必须已设置
     */
    function startAnimation() {
      if (!sceneParams) {
        console.warn('⚠️ 请先生成可视化场景');
        showNotification('请先生成可视化场景', 'warning', 2000);
        return;
      }
      if (isPlaying) {
        console.log('⚠️ 动画已在播放中，跳过');
        return;
      }
      
      console.log('▶️ 开始播放动画');
      console.log('   设置前 isPlaying =', isPlaying);
      isPlaying = true;
      console.log('   设置后 isPlaying =', isPlaying);
      
      // 更新正常模式按钮
      const playBtn = document.getElementById('play-animation');
      const pauseBtn = document.getElementById('pause-animation');
      playBtn?.classList.add('hidden');
      pauseBtn?.classList.remove('hidden');
      
      // 更新全屏模式按钮
      const fsPlayBtn = document.getElementById('fs-play');
      const fsPauseBtn = document.getElementById('fs-pause');
      if (fsPlayBtn) fsPlayBtn.style.display = 'none';
      if (fsPauseBtn) fsPauseBtn.style.display = 'flex';
      
      console.log('   即将调用 animate()...');
      animate();
      console.log('   animate() 已调用');
    }
    
    /**
     * 暂停动画播放
     * 
     * 功能说明：
     * - 设置 isPlaying = false，停止动画循环
     * - 取消 requestAnimationFrame 请求
     * - 恢复播放/暂停按钮状态（普通+全屏）
     * 
     * 注意：
     * - 暂停不会重置时间，可以继续播放
     * - 使用 cancelAnimationFrame 确保性能
     */
    function pauseAnimation() {
      console.log('⏸️ 暂停动画');
      isPlaying = false;
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      // 更新正常模式按钮
      const playBtn = document.getElementById('play-animation');
      const pauseBtn = document.getElementById('pause-animation');
      playBtn?.classList.remove('hidden');
      pauseBtn?.classList.add('hidden');
      
      // 更新全屏模式按钮
      const fsPlayBtn = document.getElementById('fs-play');
      const fsPauseBtn = document.getElementById('fs-pause');
      if (fsPlayBtn) fsPlayBtn.style.display = 'flex';
      if (fsPauseBtn) fsPauseBtn.style.display = 'none';
    }
    
    /**
     * 重置动画到初始状态
     * 
     * 功能说明：
     * - 停止播放并重置时间为 0
     * - 清除反弹状态（抛体运动的弹跳计数等）
     * - 清空 s-t 和 v-t 图表数据
     * - 重绘初始帧（或显示欢迎屏幕）
     * 
     * 清除的状态：
     * - bounceCount, lastBounceTime, bounceVy - 反弹相关
     * - projectileBounces, currentBounceIndex - 抛体弹跳
     * - Chart.js 图表数据
     */
    function resetAnimation() {
      console.log('🔄 重置动画');
      pauseAnimation();
      currentTime = 0;
      
      // 清除反弹状态
      if (sceneParams) {
        delete sceneParams.bounceCount;
        delete sceneParams.lastBounceTime;
        delete sceneParams.bounceVy;
        delete sceneParams.bounceTime;
        delete sceneParams.bounces;
        delete sceneParams.projectileBounces;
        delete sceneParams.currentBounceIndex;
      }
      
      // 清空图表
      clearUniformCharts();
      
      if (sceneParams) {
        drawScene();
      } else {
        drawWelcomeScreen();
      }
    }
    
    function animate() {
      console.log('🎬 animate() 被调用, isPlaying =', isPlaying);
      
      if (!isPlaying) {
        console.log('⚠️ animate() 停止：isPlaying = false');
        return;
      }
      
      currentTime += 0.05 * playSpeed;
      console.log('   时间更新到:', currentTime.toFixed(2), 's');
      
      drawScene();
      
      // 更新图表数据（如果图表存在）
      if (sceneParams) {
        updateCharts();
      }
      
      animationFrameId = requestAnimationFrame(animate);
      console.log('   已请求下一帧');
    }
    
    // 页面加载完成后初始化按钮（脚本已在底部，DOM已加载）
    // 使用 setTimeout 确保DOM完全渲染
    setTimeout(() => {
      console.log('📄 初始化控制按钮...');
      initControlButtons();
      initFullscreenButton();
      initExportButtons();
    }, 100);
    
    // ========== 全屏功能 ==========
    let isFullscreen = false;
    let fullscreenInitialized = false;
    
    function initFullscreenButton() {
      if (fullscreenInitialized) return;
      
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      
      console.log('🖥️ 初始化全屏按钮:', !!fullscreenBtn);
      
      if (!fullscreenBtn) {
        console.error('❌ 全屏按钮未找到！将在500ms后重试...');
        setTimeout(initFullscreenButton, 500);
        return;
      }
      
      fullscreenBtn.addEventListener('click', () => {
        console.log('🖱️ 全屏按钮被点击, 当前状态:', isFullscreen);
        if (!isFullscreen) {
          enterFullscreen();
        } else {
          exitFullscreen();
        }
      });
      
      fullscreenInitialized = true;
      console.log('✅ 全屏按钮已绑定');
    }
    
    function enterFullscreen() {
      console.log('🖥️ === 开始进入全屏模式 ===');
      console.log('   当前状态: isPlaying =', isPlaying, ', currentTime =', currentTime);
      
      if (!animationContainer) {
        animationContainer = document.getElementById('animation-container');
      }
      
      if (!animationContainer) {
        console.error('❌ animationContainer 未找到');
        showNotification('无法进入全屏模式', 'error', 2000);
        return;
      }
      
      // 设置全屏状态
      isFullscreen = true;
      document.body.classList.add('fullscreen-active');
      animationContainer.classList.add('fullscreen');
      console.log('✅ 已添加fullscreen类');
      
      // 创建退出按钮
      const exitBtn = document.createElement('button');
      exitBtn.className = 'fullscreen-exit-btn';
      exitBtn.id = 'fullscreen-exit-btn';
      exitBtn.innerHTML = '<i class="fa fa-times-circle"></i> 退出全屏 (ESC)';
      exitBtn.onclick = exitFullscreen;
      document.body.appendChild(exitBtn);
      console.log('✅ 已创建退出按钮');
      
      // 创建全屏控制面板
      const controlsPanel = document.createElement('div');
      controlsPanel.className = 'fullscreen-controls';
      controlsPanel.id = 'fullscreen-controls';
      
      const currentSpeed = document.getElementById('animation-speed')?.value || 1;
      
      controlsPanel.innerHTML = `
        <button id="fs-play" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg items-center gap-2 shadow-lg transition-all" style="display: ${isPlaying ? 'none' : 'flex'};">
          <i class="fa fa-play"></i>
          <span class="font-semibold">播放</span>
        </button>
        <button id="fs-pause" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg items-center gap-2 shadow-lg transition-all" style="display: ${isPlaying ? 'flex' : 'none'};">
          <i class="fa fa-pause"></i>
          <span class="font-semibold">暂停</span>
        </button>
        <button id="fs-reset" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg transition-all">
          <i class="fa fa-refresh"></i>
          <span class="font-semibold">重置</span>
        </button>
        <div class="flex items-center ml-4 bg-white px-4 py-2 rounded-lg shadow-md">
          <label class="text-sm text-gray-600 mr-3 font-medium">速度:</label>
          <input type="range" min="0.1" max="2" step="0.1" value="${currentSpeed}" class="w-32" id="fs-speed">
          <span id="fs-speed-display" class="ml-3 text-sm font-mono bg-gray-100 px-3 py-1 rounded font-semibold">${parseFloat(currentSpeed).toFixed(1)}x</span>
        </div>
      `;
      document.body.appendChild(controlsPanel);
      console.log('✅ 已创建全屏控制面板，isPlaying =', isPlaying);
      
      // 绑定全屏控制按钮事件
      document.getElementById('fs-play')?.addEventListener('click', startAnimation);
      document.getElementById('fs-pause')?.addEventListener('click', pauseAnimation);
      document.getElementById('fs-reset')?.addEventListener('click', resetAnimation);
      
      const fsSpeed = document.getElementById('fs-speed');
      const fsSpeedDisplay = document.getElementById('fs-speed-display');
      if (fsSpeed && fsSpeedDisplay) {
        fsSpeed.addEventListener('input', (e) => {
          const speed = parseFloat(e.target.value);
          fsSpeedDisplay.textContent = speed.toFixed(1) + 'x';
          // 同步原始速度滑块
          const originalSpeed = document.getElementById('animation-speed');
          if (originalSpeed) {
            originalSpeed.value = speed;
            document.getElementById('speed-display').textContent = speed.toFixed(1) + 'x';
          }
        });
      }
      
      // 等待CSS完全生效后调整Canvas
      setTimeout(() => {
        console.log('⏱️ 开始调整Canvas...');
        
        // 获取Canvas元素
        canvas = document.getElementById('physics-canvas');
        if (!canvas) {
          console.error('❌ Canvas元素未找到！');
          return;
        }
        console.log('✅ Canvas元素已找到');
        console.log('   Canvas的父元素:', canvas.parentElement?.id);
        console.log('   Canvas在DOM中:', document.body.contains(canvas));
        
        // ！！！暴力解决：直接把Canvas移动到body下
        console.log('🔧 将Canvas移动到body下...');
        document.body.appendChild(canvas);
        console.log('✅ Canvas已移动到body');
        
        // 获取2D上下文
        ctx = canvas.getContext('2d');
        if (!ctx) {
          console.error('❌ 无法获取Canvas 2D上下文！');
          return;
        }
        console.log('✅ Canvas 2D上下文已获取');
        
        // 设置Canvas尺寸
        const w = window.innerWidth;
        const h = window.innerHeight;
        console.log('📐 窗口尺寸:', w, 'x', h);
        
        canvas.width = w;
        canvas.height = h;
        console.log('✅ Canvas尺寸已设置:', canvas.width, 'x', canvas.height);
        console.log('   Canvas.style:', canvas.style.width, canvas.style.height);
        console.log('   Canvas offset:', canvas.offsetWidth, 'x', canvas.offsetHeight);
        
        // ！！！强制设置Canvas的内联样式
        canvas.style.position = 'fixed';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        canvas.style.zIndex = '10000';
        canvas.style.display = 'block';
        canvas.style.backgroundColor = '#ffffff';  // 设置白色背景
        canvas.style.visibility = 'visible';
        canvas.style.opacity = '1';
        console.log('✅ 强制设置Canvas内联样式');
        
        // ！！！关键：Canvas尺寸改变后必须重新获取上下文
        ctx = canvas.getContext('2d');
        console.log('✅ 重新获取上下文');
        console.log('   ctx 存在:', !!ctx);
        console.log('   sceneParams 存在:', !!sceneParams);
        console.log('   当前动画播放状态 isPlaying:', isPlaying);
        
        // 清除Canvas背景
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 立即绘制场景或欢迎屏幕
        if (sceneParams) {
          console.log('🎬 准备绘制场景, sceneParams.type =', sceneParams.type);
          try {
            drawScene();
            console.log('✅ drawScene() 调用完成');
            
            // ！！！关键修复：如果动画正在播放，绘制一帧后需要继续动画循环
            if (isPlaying) {
              console.log('🎬 检测到动画正在播放，无需重启（animate循环会自动继续）');
              // animate() 循环会自动调用 drawScene()，不需要手动干预
            }
          } catch (error) {
            console.error('❌ drawScene() 执行出错:', error);
          }
        } else {
          console.log('👋 准备绘制欢迎屏幕...');
          try {
            drawWelcomeScreen();
            console.log('✅ drawWelcomeScreen() 调用完成');
          } catch (error) {
            console.error('❌ drawWelcomeScreen() 执行出错:', error);
          }
        }
        
        console.log('🖥️ === 全屏模式设置完成 ===');
        
      }, 250);
      
      // 更新按钮图标
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      if (fullscreenBtn) {
        fullscreenBtn.innerHTML = '<i class="fa fa-compress"></i><span>退出全屏</span>';
      }
      
      showNotification('已进入全屏模式，按 ESC 退出', 'info', 2000);
    }
    
    function exitFullscreen() {
      console.log('🖥️ === 开始退出全屏模式 ===');
      isFullscreen = false;
      document.body.classList.remove('fullscreen-active');
      
      if (!animationContainer) {
        animationContainer = document.getElementById('animation-container');
      }
      
      if (animationContainer) {
        animationContainer.classList.remove('fullscreen');
      }
      
      // 移除退出按钮和控制面板
      const exitBtn = document.getElementById('fullscreen-exit-btn');
      if (exitBtn) {
        exitBtn.remove();
        console.log('✅ 已移除退出按钮');
      }
      
      const controlsPanel = document.getElementById('fullscreen-controls');
      if (controlsPanel) {
        controlsPanel.remove();
        console.log('✅ 已移除全屏控制面板');
      }
      
      // ！！！关键：把Canvas移回animationContainer
      setTimeout(() => {
        if (canvas && animationContainer) {
          console.log('🔧 将Canvas移回容器...');
          
          // 移回容器
          animationContainer.appendChild(canvas);
          console.log('✅ Canvas已移回 #animation-container');
          
          // 清除内联样式（恢复CSS控制）
          canvas.style.position = '';
          canvas.style.top = '';
          canvas.style.left = '';
          canvas.style.width = '';
          canvas.style.height = '';
          canvas.style.zIndex = '';
          canvas.style.backgroundColor = '';
          console.log('✅ 已清除Canvas内联样式');
          
          // 重新设置Canvas尺寸
          const newWidth = animationContainer.clientWidth;
          const newHeight = animationContainer.clientHeight;
          console.log('📐 恢复Canvas尺寸:', newWidth, 'x', newHeight);
          
          canvas.width = newWidth;
          canvas.height = newHeight;
          
          // 重新获取上下文
          ctx = canvas.getContext('2d');
          console.log('✅ 重新获取Canvas上下文');
          
          // 重新绘制内容
          if (sceneParams) {
            console.log('🎬 重绘场景...');
            drawScene();
          } else {
            console.log('👋 显示欢迎屏幕...');
            drawWelcomeScreen();
          }
          
          console.log('🖥️ === 退出全屏完成 ===');
        }
      }, 150);
      
      // 更新按钮图标
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      if (fullscreenBtn) {
        fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i><span>全屏</span>';
      }
      
      showNotification('已退出全屏模式', 'info', 2000);
    }
    
    // ESC键退出全屏
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isFullscreen) {
        exitFullscreen();
      }
    });
    
    // ========== 导出功能 ==========
    let mediaRecorder;
    let recordedChunks = [];
    let exportButtonsInitialized = false;
    
    function initExportButtons() {
      if (exportButtonsInitialized) {
        console.log('导出按钮已经初始化过了，跳过');
        return;
      }
      
      console.log('=== 开始初始化导出按钮 ===');
      
      const exportMenuBtn = document.getElementById('export-menu-btn');
      const exportMenu = document.getElementById('export-menu');
      const exportMP4Btn = document.getElementById('export-mp4');
      const exportGIFBtn = document.getElementById('export-gif');
      
      console.log('导出按钮元素查找结果:', {
        exportMenuBtn: exportMenuBtn,
        exportMenu: exportMenu,
        exportMP4Btn: exportMP4Btn,
        exportGIFBtn: exportGIFBtn
      });
      
      if (!exportMenuBtn || !exportMenu) {
        console.error('!!! 导出按钮未找到，将在500ms后重试 !!!');
        setTimeout(initExportButtons, 500);
        return;
      }
      
      console.log('✓✓✓ 导出按钮找到了，开始绑定事件 ✓✓✓');
      
      // 初始化菜单为隐藏
      exportMenu.style.display = 'none';
      
      // 先注册document点击事件（必须在按钮事件之前）
      document.addEventListener('click', (e) => {
        // 检查点击是否在按钮或菜单外部
        if (!exportMenuBtn.contains(e.target) && !exportMenu.contains(e.target)) {
          exportMenu.style.display = 'none';
          console.log('点击外部，关闭菜单');
        }
      });
      
      // 阻止菜单内部点击冒泡
      exportMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('点击菜单内部');
      });
      
      // 切换导出菜单
      let isToggling = false;
      exportMenuBtn.addEventListener('click', (e) => {
        console.log('!!!!!!!! 导出按钮被点击了 !!!!!!!!');
        console.log('Event target:', e.target);
        console.log('Event currentTarget:', e.currentTarget);
        console.log('当前菜单display:', exportMenu.style.display);
        console.log('isToggling:', isToggling);
        
        // 防止重复触发
        if (isToggling) {
          console.log('正在切换中，忽略此次点击');
          e.stopPropagation();
          e.preventDefault();
          return false;
        }
        
        isToggling = true;
        e.stopPropagation();
        e.preventDefault();
        
        // 切换显示状态
        const currentDisplay = exportMenu.style.display;
        if (currentDisplay === 'none' || currentDisplay === '') {
          exportMenu.style.display = 'block';
          console.log('>>>>>> 菜单已设置为 block <<<<<<');
        } else {
          exportMenu.style.display = 'none';
          console.log('>>>>>> 菜单已设置为 none <<<<<<');
        }
        
        // 50ms后解除锁定
        setTimeout(() => {
          isToggling = false;
          console.log('切换锁定已解除');
        }, 50);
        
        return false;
      }, true);
      
      // 标记已初始化
      exportButtonsInitialized = true;
      console.log('✓✓✓ 导出按钮初始化完成 ✓✓✓');
      
      // 导出为 MP4
      exportMP4Btn?.addEventListener('click', async () => {
        exportMenu.style.display = 'none';
        
        if (!sceneParams) {
          showNotification('请先生成动画场景', 'warning', 2000);
          return;
        }
        
        // 显示录制提示
        showNotification('🎬 开始录制动画...', 'info', 3000);
        
        try {
          // 准备录制
          const stream = canvas.captureStream(30); // 30 FPS
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/webm;codecs=vp9',
            videoBitsPerSecond: 2500000
          });
          
          recordedChunks = [];
          
          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
              recordedChunks.push(e.data);
            }
          };
          
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `physics-animation-${Date.now()}.webm`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('✓ 视频已导出 (WebM格式)', 'success', 3000);
          };
          
          // 从头开始录制
          const wasPlaying = isPlaying;
          pauseAnimation();
          currentTime = 0;
          drawScene();
          
          mediaRecorder.start();
          
          // 自动播放并录制
          setTimeout(() => {
            startAnimation();
            
            // 录制完整动画周期 (根据运动类型估算时长)
            const duration = estimateAnimationDuration();
            setTimeout(() => {
              mediaRecorder.stop();
              if (!wasPlaying) pauseAnimation();
            }, duration);
          }, 500);
        } catch (error) {
          console.error('录制失败:', error);
          showNotification('录制失败: ' + error.message, 'error', 3000);
        }
      });
      
      // 导出为 GIF
      exportGIFBtn?.addEventListener('click', async () => {
        console.log('=== GIF导出按钮被点击 ===');
        exportMenu.style.display = 'none';

        if (!sceneParams) {
          console.warn('sceneParams不存在');
          showNotification('请先生成动画场景', 'warning', 2000);
          return;
        }

        // 检查 gifshot 库是否加载
        console.log('检查 gifshot 库:', typeof gifshot);
        if (typeof gifshot === 'undefined') {
          console.error('gifshot库未加载！');
          showNotification('GIF库未加载，请刷新页面重试', 'error', 3000);
          return;
        }

        showNotification('🎨 正在生成GIF...', 'info', 3000);

        try {
          const durationMs = estimateAnimationDuration();
          const targetFps = 10; // gifshot 推荐较低帧率
          const maxFrames = 100; // 限制帧数
          const estimatedFrames = Math.ceil((durationMs / 1000) * targetFps);
          const frameCount = Math.min(Math.max(10, estimatedFrames), maxFrames);
          const interval = 1.0 / targetFps; // 每帧间隔秒数

          console.log('GIF 参数:', { durationMs, targetFps, frameCount, interval });

          // 创建进度覆盖层
          let progressOverlay = document.getElementById('gif-progress-overlay');
          if (!progressOverlay) {
            progressOverlay = document.createElement('div');
            progressOverlay.id = 'gif-progress-overlay';
            progressOverlay.style.cssText = `
              position: fixed;
              left: 50%;
              top: 40%;
              transform: translate(-50%, -50%);
              z-index: 100000;
              background: rgba(0,0,0,0.85);
              color: white;
              padding: 20px 30px;
              border-radius: 12px;
              font-family: Arial, sans-serif;
              font-size: 16px;
            `;
            document.body.appendChild(progressOverlay);
          }

          const wasPlaying = isPlaying;
          pauseAnimation();
          const originalTime = currentTime;

          // 捕获所有帧为 base64 图片
          const images = [];
          progressOverlay.textContent = `捕获帧 0/${frameCount}...`;

          for (let i = 0; i < frameCount; i++) {
            // 设置当前时间
            currentTime = (i / Math.max(1, frameCount - 1)) * (durationMs / 1000);
            
            // 绘制当前帧
            drawScene();
            
            // 捕获为 base64
            const dataUrl = canvas.toDataURL('image/png');
            images.push(dataUrl);
            
            // 更新进度
            progressOverlay.textContent = `捕获帧 ${i + 1}/${frameCount}...`;
            
            // 让浏览器有机会更新 UI
            if (i % 5 === 0) {
              await new Promise(resolve => setTimeout(resolve, 0));
            }
          }

          console.log(`已捕获 ${images.length} 帧，开始生成 GIF...`);
          progressOverlay.textContent = '正在生成GIF...';

          // 使用 gifshot 生成 GIF
          gifshot.createGIF({
            images: images,
            gifWidth: canvas.width,
            gifHeight: canvas.height,
            interval: interval,
            numFrames: frameCount,
            frameDuration: 1,
            sampleInterval: 10,
            progressCallback: (captureProgress) => {
              const percent = Math.round(captureProgress * 100);
              console.log(`GIF 生成进度: ${percent}%`);
              if (progressOverlay) {
                progressOverlay.textContent = `生成中 ${percent}%`;
              }
            }
          }, (obj) => {
            if (progressOverlay) progressOverlay.remove();
            
            if (!obj.error) {
              console.log('GIF 生成成功！');
              // 下载 GIF
              const a = document.createElement('a');
              a.href = obj.image;
              a.download = `physics-animation-${Date.now()}.gif`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              showNotification('✓ GIF已导出', 'success', 3000);
            } else {
              console.error('GIF 生成失败:', obj.error);
              showNotification('GIF生成失败: ' + obj.error, 'error', 3000);
            }
            
            // 恢复状态
            currentTime = originalTime || 0;
            drawScene();
            if (wasPlaying) startAnimation();
          });

        } catch (error) {
          console.error('!!! GIF生成失败 !!!', error);
          showNotification('GIF生成失败: ' + (error && error.message ? error.message : error), 'error', 3000);
          
          // 清理并恢复
          const progressOverlay = document.getElementById('gif-progress-overlay');
          if (progressOverlay) progressOverlay.remove();
          currentTime = 0;
          drawScene();
        }
      });
      
      console.log('✅ 导出按钮已绑定');
    }    // 估算动画时长
    function estimateAnimationDuration() {
      if (!sceneParams) return 5000;
      
      const type = sceneParams.type;
      if (type === 'projectile') return 8000;
      if (type === 'circular') return 10000;
      if (type === 'collision') return 6000;
      return 5000; // 默认5秒
    }
    
    // ========== 场景绘制函数 ==========
    
    // 辅助函数：绘制地面
    function drawGround(y) {
      const w = canvas.width;
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 2;
      
      // 双线地面
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(w, y);
      ctx.stroke();
      
      ctx.beginPath();
      ctx.moveTo(0, y + 5);
      ctx.lineTo(w, y + 5);
      ctx.stroke();
      
      // 斜线阴影
      ctx.lineWidth = 1;
      for (let i = 0; i < w; i += 10) {
        ctx.beginPath();
        ctx.moveTo(i, y + 5);
        ctx.lineTo(i + 10, y + 15);
        ctx.stroke();
      }
      ctx.lineWidth = 2;
    }
    
    // 1. 垂直运动（自由落体/竖直上抛）
    function drawVerticalMotion() {
      const w = canvas.width;
      const h = canvas.height;
      const scale = isFullscreen ? Math.min(w, h) / 20 : 40; // 全屏时使用更大的比例
      const groundY = isFullscreen ? h * 0.85 : h - 60;
      
      drawGround(groundY);
      
      const g = 10;
      const v0 = sceneParams.v0 || 0;
      const h0 = sceneParams.height || 8;
      const t = currentTime;
      
      // 初始化反弹追踪器
      if (sceneParams.bounces === undefined) {
        sceneParams.bounces = [];
        sceneParams.currentBounceIndex = -1;
      }
      
      let y, v;
      
      // 计算当前所处的反弹阶段
      let effectiveT = t;
      let currentV0 = v0;
      let currentH0 = h0;
      
      // 遍历所有已发生的反弹，找到当前阶段
      for (let i = 0; i < sceneParams.bounces.length; i++) {
        const bounce = sceneParams.bounces[i];
        if (t >= bounce.time) {
          effectiveT = t - bounce.time;
          currentV0 = bounce.v0;
          currentH0 = 0; // 反弹后从地面开始
          sceneParams.currentBounceIndex = i;
        }
      }
      
      // 使用当前阶段的运动方程
      y = currentH0 + currentV0 * effectiveT - 0.5 * g * effectiveT * effectiveT;
      v = currentV0 - g * effectiveT;
      
      // 检测是否需要触发新的反弹
      if (y < 0 && v < 0) {
        const restitution = 0.7;
        const newV0 = Math.abs(v) * restitution;
        
        // 如果反弹速度太小或反弹次数太多，停止
        if (newV0 < 0.8 || sceneParams.bounces.length >= 5) {
          y = 0;
          v = 0;
          pauseAnimation();
        } else {
          // 记录新的反弹
          sceneParams.bounces.push({
            time: t,
            v0: newV0
          });
          // 立即使用新的反弹参数
          y = 0;
          v = newV0;
        }
      }
      
      // 更新显示
      document.getElementById('animation-time').textContent = t.toFixed(2) + ' s';
      document.getElementById('animation-velocity').textContent = Math.abs(v).toFixed(2) + ' m/s';
      document.getElementById('animation-position').textContent = y.toFixed(2) + ' m';
      
      const ballY = groundY - y * scale;
      
  // 绘制物体（使用视觉配置）
  const vcfg = getVisualConfig();
  const ballR = Math.round(12 * vcfg.radiusMultiplier);
  ctx.fillStyle = vcfg.ballColor;
  ctx.beginPath();
  ctx.arc(w / 2, ballY, ballR, 0, 2 * Math.PI);
  ctx.fill();
      
      // 高度标注线
      ctx.strokeStyle = '#666666';
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(w / 2 - 40, ballY);
      ctx.lineTo(w / 2 - 40, groundY);
      ctx.stroke();
      ctx.setLineDash([]);
      
      ctx.fillStyle = '#000000';
      ctx.fillText('h = ' + y.toFixed(2) + ' m', w / 2 - 100, ballY + 5);
      
      // 速度箭头（根据视觉设置决定是否显示）
      if (vcfg.showVelocity && Math.abs(v) > 0.5) {
        const arrowLen = Math.min(Math.abs(v) * 5, 100) * (vcfg.detail === 'high' ? 1.1 : 1);
        ctx.strokeStyle = vcfg.arrowColor;
        ctx.fillStyle = vcfg.arrowColor;
        
        const startY = ballY;
        const endY = ballY + (v < 0 ? -arrowLen : arrowLen);
        
        ctx.beginPath();
        ctx.moveTo(w / 2 + 30, startY);
        ctx.lineTo(w / 2 + 30, endY);
        ctx.lineWidth = vcfg.lineWidth;
        ctx.stroke();
        
        // 箭头头部
        ctx.beginPath();
        ctx.moveTo(w / 2 + 30, endY);
        ctx.lineTo(w / 2 + 25, endY - (v < 0 ? 8 : -8));
        ctx.lineTo(w / 2 + 35, endY - (v < 0 ? 8 : -8));
        ctx.closePath();
        ctx.fill();
        
        ctx.fillText('v = ' + v.toFixed(2) + ' m/s', w / 2 + 45, (startY + endY) / 2);
      }
      
      ctx.strokeStyle = '#000000';
      ctx.fillStyle = '#000000';
    }
    
    // ============================================================================
    // 🎨 4. 物理运动绘制函数 - 水平运动（汽车/滑块）
    // ============================================================================
    
    /**
     * 绘制水平匀变速直线运动
     * 
     * 应用场景：
     * - 汽车在公路上加速/减速/匀速行驶
     * - 滑块在水平面上的运动
     * - 火车、自行车等水平运动物体
     * 
     * 物理公式：
     * - 位移: x = v0*t + (1/2)*a*t²
     * - 速度: v = v0 + a*t
     * 
     * 渲染特性：
     * - 使用SVG汽车图像（getCarImage）
     * - 绘制公路（实线+虚线）
     * - 实时显示时间、速度、位置
     * - 支持全屏模式自适应
     * 
     * @requires sceneParams.v0 - 初速度(m/s)
     * @requires sceneParams.a  - 加速度(m/s²)
     * @requires currentTime    - 当前动画时间(s)
     */
    function drawHorizontalMotion() {
      const w = canvas.width;
      const h = canvas.height;
      const scale = isFullscreen ? Math.min(w, h) / 15 : 50;
      const roadY = isFullscreen ? h * 0.6 : h / 2;
      const startX = isFullscreen ? w * 0.15 : 100;
      
      // 绘制公路
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, roadY);
      ctx.lineTo(w, roadY);
      ctx.stroke();
      
      // 虚线
      ctx.setLineDash([15, 10]);
      ctx.strokeStyle = '#666666';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(0, roadY - 20);
      ctx.lineTo(w, roadY - 20);
      ctx.stroke();
      ctx.setLineDash([]);
      
      const a = sceneParams.a || 0;
      const v0 = sceneParams.v0 || 10;
      const t = currentTime;
      
      const x = v0 * t + 0.5 * a * t * t;
      const v = v0 + a * t;
      
      document.getElementById('animation-time').textContent = t.toFixed(2) + ' s';
      document.getElementById('animation-velocity').textContent = Math.abs(v).toFixed(2) + ' m/s';
      document.getElementById('animation-position').textContent = x.toFixed(2) + ' m';
      
      const carX = startX + x * scale;
      
      // ！！！修复：放宽停止边界
      const maxX = isFullscreen ? w * 0.9 : w - 30;
      if (carX > maxX || carX < -30 || (a < 0 && v <= 0)) {
        console.log('⏸️ 水平运动结束，自动暂停');
        pauseAnimation();
      }
      
  // 绘制汽车（使用视觉配置）
  const vcfg = getVisualConfig();
  const carW = 60, carH = 30;
  ctx.fillStyle = vcfg.ballColor;
  ctx.strokeStyle = '#000000';
  ctx.lineWidth = Math.max(1, vcfg.lineWidth);
  ctx.fillRect(carX - carW/2, roadY - carH - 20, carW, carH);
  ctx.strokeRect(carX - carW/2, roadY - carH - 20, carW, carH);
      
      // 轮子
      ctx.fillStyle = '#000000';
      ctx.beginPath();
      ctx.arc(carX - 15, roadY - 5, 8, 0, 2 * Math.PI);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(carX + 15, roadY - 5, 8, 0, 2 * Math.PI);
      ctx.fill();
      
      // 速度箭头
      if (Math.abs(v) > 0.1) {
        const arrowLen = Math.min(Math.abs(v) * 8, 120);
        ctx.strokeStyle = '#0066ff';
        ctx.fillStyle = '#0066ff';
        
        const arrowY = roadY - carH - 50;
        ctx.beginPath();
        ctx.moveTo(carX, arrowY);
        ctx.lineTo(carX + (v > 0 ? arrowLen : -arrowLen), arrowY);
        ctx.stroke();
        
        // 箭头头部
        const endX = carX + (v > 0 ? arrowLen : -arrowLen);
        ctx.beginPath();
        ctx.moveTo(endX, arrowY);
        ctx.lineTo(endX - (v > 0 ? 8 : -8), arrowY - 5);
        ctx.lineTo(endX - (v > 0 ? 8 : -8), arrowY + 5);
        ctx.closePath();
        ctx.fill();
        
        ctx.fillText('v = ' + v.toFixed(2) + ' m/s', carX + arrowLen/2, arrowY - 15);
      }
      
      ctx.strokeStyle = '#000000';
      ctx.fillStyle = '#000000';
    }
    
    // 3. 抛体运动
    function drawProjectileMotion() {
      console.log('🎾 drawProjectileMotion() 被调用');
      console.log('   currentTime:', currentTime);
      console.log('   canvas尺寸:', canvas.width, 'x', canvas.height);
      
      const w = canvas.width;
      const h = canvas.height;
      
      // 全屏时使用更大的比例，并让场景居中
      const scale = isFullscreen ? Math.min(w, h) / 25 : 30;
      const groundY = isFullscreen ? h * 0.8 : h - 60;
      const startX = isFullscreen ? w * 0.1 : 100;
      
      console.log('   groundY:', groundY);
      
      drawGround(groundY);
      console.log('   地面绘制完成');
      
      const v0 = sceneParams.speed || 10;
      const angle = (sceneParams.angle || 30) * Math.PI / 180;
      const h0 = sceneParams.height || 5;
      const g = 10;
      const t = currentTime;
      
      console.log('   参数: v0=' + v0 + ', angle=' + (angle*180/Math.PI).toFixed(1) + '°, h0=' + h0);
      
      const vx = v0 * Math.cos(angle);
      const initialVy = v0 * Math.sin(angle);
      
      // 初始化反弹追踪器
      if (sceneParams.projectileBounces === undefined) {
        sceneParams.projectileBounces = [];
      }
      
      let x = vx * t;
      let y, vy;
      
      // 计算当前所处的反弹阶段
      let effectiveT = t;
      let currentVy0 = initialVy;
      let currentH0 = h0;
      
      // 遍历所有已发生的反弹
      for (let i = 0; i < sceneParams.projectileBounces.length; i++) {
        const bounce = sceneParams.projectileBounces[i];
        if (t >= bounce.time) {
          effectiveT = t - bounce.time;
          currentVy0 = bounce.vy0;
          currentH0 = 0;
        }
      }
      
      // 使用当前阶段的运动方程
      y = currentH0 + currentVy0 * effectiveT - 0.5 * g * effectiveT * effectiveT;
      vy = currentVy0 - g * effectiveT;
      
      // 检测是否需要触发新的反弹
      if (y < 0 && vy < 0) {
        const restitution = 0.7;
        const newVy0 = Math.abs(vy) * restitution;
        
        // 如果反弹速度太小或反弹次数太多，停止垂直运动
        if (newVy0 < 0.8 || sceneParams.projectileBounces.length >= 5) {
          y = 0;
          vy = 0;
          // 继续水平移动，只有完全超出画布才停止
          if (x * scale > w - 30) {
            console.log('⏸️ 抛体落地并超出边界，自动暂停');
            pauseAnimation();
          }
        } else {
          // 记录新的反弹
          sceneParams.projectileBounces.push({
            time: t,
            vy0: newVy0
          });
          // 立即使用新的反弹参数
          y = 0;
          vy = newVy0;
        }
      }
      
      const vTotal = Math.sqrt(vx * vx + vy * vy);
      
      console.log('   计算结果: x=' + x.toFixed(2) + 'm, y=' + y.toFixed(2) + 'm, vy=' + vy.toFixed(2) + 'm/s');
      
      document.getElementById('animation-time').textContent = t.toFixed(2) + ' s';
      document.getElementById('animation-velocity').textContent = vTotal.toFixed(2) + ' m/s';
      document.getElementById('animation-position').textContent = '(' + x.toFixed(2) + ', ' + y.toFixed(2) + ') m';
      
      // ！！！修复：增加停止边界，让动画有足够空间
      // 只有当小球完全超出画布右侧时才停止
      const maxX = isFullscreen ? w * 0.9 : w - 50;
      if (x * scale > maxX - startX) {
        console.log('⏸️ 抛体超出画布边界，自动暂停');
        pauseAnimation();
        return;
      }
      
      const ballX = startX + x * scale;
      const ballY = groundY - y * scale;
      
      console.log('   小球像素位置: ballX=' + ballX.toFixed(0) + ', ballY=' + ballY.toFixed(0));
      console.log('   画布范围: 0~' + w + ' x 0~' + h);
      
      if (ballY < -100 || ballY > h + 100) {
        console.warn('⚠️ 小球Y坐标超出画布！ballY=' + ballY.toFixed(0) + ', 画布高度=' + h);
      }
      
      // 抛出平台
      const platformWidth = isFullscreen ? 120 : 100;
      const platformX = isFullscreen ? startX - 60 : 50;
      ctx.fillStyle = '#cccccc';
      ctx.strokeStyle = '#000000';
      ctx.fillRect(platformX, groundY - h0 * scale, platformWidth, 20);
      ctx.strokeRect(platformX, groundY - h0 * scale, platformWidth, 20);

      // 物体（视觉配置）
      const vcfg = getVisualConfig();
      const ballRadius = Math.round((isFullscreen ? 18 : 12) * vcfg.radiusMultiplier);
      ctx.fillStyle = vcfg.ballColor;
      ctx.beginPath();
      ctx.arc(ballX, ballY, ballRadius, 0, 2 * Math.PI);
      ctx.fill();

      // 轨迹（仅在 useTrail 为 true 时绘制）
      if (vcfg.useTrail) {
        ctx.strokeStyle = vcfg.trailColor;
        ctx.setLineDash(vcfg.detail === 'low' ? [4,4] : [3,3]);
        ctx.lineWidth = vcfg.lineWidth;
        ctx.beginPath();
        for (let dt = 0; dt <= t; dt += 0.05) {
          const tx = startX + vx * dt * scale;
          const ty = groundY - (h0 + initialVy * dt - 0.5 * g * dt * dt) * scale;
          if (dt === 0) ctx.moveTo(tx, ty);
          else ctx.lineTo(tx, ty);
        }
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.lineWidth = 1;
      }
      
  // 速度箭头（视觉设置）
  const vAngle = Math.atan2(-vy, vx);
  const arrowLen = Math.min(vTotal * 5, 80) * (vcfg.detail === 'high' ? 1.1 : 1);
  ctx.strokeStyle = vcfg.arrowColor;
  ctx.fillStyle = vcfg.arrowColor;
      
      const endX = ballX + arrowLen * Math.cos(vAngle);
      const endY = ballY - arrowLen * Math.sin(vAngle);
      
      ctx.beginPath();
      ctx.moveTo(ballX, ballY);
      ctx.lineTo(endX, endY);
      ctx.stroke();
      
      // 箭头头部
      ctx.beginPath();
      ctx.moveTo(endX, endY);
      ctx.lineTo(endX - 8 * Math.cos(vAngle - Math.PI/6), endY + 8 * Math.sin(vAngle - Math.PI/6));
      ctx.lineTo(endX - 8 * Math.cos(vAngle + Math.PI/6), endY + 8 * Math.sin(vAngle + Math.PI/6));
      ctx.closePath();
      ctx.fill();

      ctx.fillText('v = ' + vTotal.toFixed(2) + ' m/s', ballX + 20, ballY - 20);

      // 高亮顶点（如果启用）
      if (vcfg.highlightApex) {
        const tApex = initialVy / g;
        if (tApex >= 0 && Math.abs(t - tApex) < 0.5) {
          const apexX = startX + vx * tApex * scale;
          const apexY = groundY - (h0 + initialVy * tApex - 0.5 * g * tApex * tApex) * scale;
          ctx.save();
          ctx.fillStyle = '#ffd166';
          ctx.beginPath();
          ctx.arc(apexX, apexY - 8, 6, 0, 2 * Math.PI);
          ctx.fill();
          ctx.fillStyle = '#333333';
          ctx.fillText('顶点', apexX + 10, apexY - 8);
          ctx.restore();
        }
      }
      
      console.log('✅ drawProjectileMotion() 绘制完成');
      
      ctx.strokeStyle = '#000000';
      ctx.fillStyle = '#000000';
    }
    
    // 4. 圆周运动
    function drawCircularMotion() {
      const w = canvas.width;
      const h = canvas.height;
      const centerX = w / 2;
      const centerY = h / 2;
      
      const R = (sceneParams.radius || 2) * 40;
      const omega = sceneParams.angular || 1;
      const t = currentTime;
      const theta = omega * t;
      
  // 使用视觉配置
  const vcfg = getVisualConfig();
  // 圆形轨道
  ctx.strokeStyle = vcfg.trailColor || '#666666';
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  ctx.arc(centerX, centerY, R, 0, 2 * Math.PI);
  ctx.lineWidth = Math.max(1, vcfg.lineWidth);
  ctx.stroke();
  ctx.setLineDash([]);

  // 中心点
  ctx.fillStyle = '#000000';
  ctx.beginPath();
  ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
  ctx.fill();
  ctx.fillText('O', centerX + 10, centerY - 10);

  const ballX = centerX + R * Math.cos(theta);
  const ballY = centerY + R * Math.sin(theta);

  // 绳子
  ctx.strokeStyle = vcfg.arrowColor || '#000000';
  ctx.lineWidth = Math.max(1, vcfg.lineWidth);
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  ctx.lineTo(ballX, ballY);
  ctx.stroke();

  // 物体
  ctx.fillStyle = vcfg.ballColor;
  ctx.beginPath();
  ctx.arc(ballX, ballY, Math.round(12 * vcfg.radiusMultiplier), 0, 2 * Math.PI);
  ctx.fill();
      
      const v = omega * R / 40;
      document.getElementById('animation-time').textContent = t.toFixed(2) + ' s';
      document.getElementById('animation-velocity').textContent = v.toFixed(2) + ' m/s';
      document.getElementById('animation-position').textContent = 'θ = ' + (theta * 180 / Math.PI % 360).toFixed(1) + '°';
      
      // 速度箭头（切线方向）
      const arrowLen = Math.min(v * 10, 60);
      ctx.strokeStyle = '#0066ff';
      ctx.fillStyle = '#0066ff';
      
      const endX = ballX - arrowLen * Math.sin(theta);
      const endY = ballY + arrowLen * Math.cos(theta);
      
      ctx.beginPath();
      ctx.moveTo(ballX, ballY);
      ctx.lineTo(endX, endY);
      ctx.stroke();
      
      // 箭头头部
      const vAngle = theta + Math.PI / 2;
      ctx.beginPath();
      ctx.moveTo(endX, endY);
      ctx.lineTo(endX - 8 * Math.cos(vAngle - Math.PI/6), endY - 8 * Math.sin(vAngle - Math.PI/6));
      ctx.lineTo(endX - 8 * Math.cos(vAngle + Math.PI/6), endY - 8 * Math.sin(vAngle + Math.PI/6));
      ctx.closePath();
      ctx.fill();
      
      ctx.fillText('v = ' + v.toFixed(2) + ' m/s', ballX + 20, ballY - 20);
      
      ctx.strokeStyle = '#000000';
      ctx.fillStyle = '#000000';
    }
    
    // 5. 碰撞
    function drawCollision() {
      const w = canvas.width;
      const h = canvas.height;
      const groundY = h - 60;
      
      drawGround(groundY);
      
      const m1 = sceneParams.m1 || 1;
      const v1_init = sceneParams.v1 || 2;
      const m2 = sceneParams.m2 || 1;
      const v2_init = sceneParams.v2 || 0;
      const t = currentTime;
      
      // 碰撞时刻（假设在中间相遇）
      const t_collision = 2;
      
      let x1, x2, v1, v2;
      
      if (t < t_collision) {
        // 碰撞前
        x1 = 100 + v1_init * t * 50;
        x2 = 600 - Math.abs(v2_init) * t * 50;
        v1 = v1_init;
        v2 = v2_init;
      } else {
        // 碰撞后（动量守恒和能量守恒）
        // 一维弹性碰撞公式
        const v1_final = ((m1 - m2) * v1_init + 2 * m2 * v2_init) / (m1 + m2);
        const v2_final = ((m2 - m1) * v2_init + 2 * m1 * v1_init) / (m1 + m2);
        
        const dt = t - t_collision;
        x1 = 100 + v1_init * t_collision * 50 + v1_final * dt * 50;
        x2 = 600 - Math.abs(v2_init) * t_collision * 50 + v2_final * dt * 50;
        v1 = v1_final;
        v2 = v2_final;
      }
      
      // 更新显示
      document.getElementById('animation-time').textContent = t.toFixed(2) + ' s';
      document.getElementById('animation-velocity').textContent = `v1=${v1.toFixed(2)}, v2=${v2.toFixed(2)} m/s`;
      document.getElementById('animation-position').textContent = `x1=${(x1/50).toFixed(2)}, x2=${(x2/50).toFixed(2)} m`;
      
      // 停止条件
      if (x1 > w || x2 > w || x1 < 0 || x2 < 0 || t > 6) {
        pauseAnimation();
        return;
      }
      
      const ballY = groundY - 50;
      
      // 绘制物体1
      ctx.fillStyle = '#ff6b00';
      ctx.beginPath();
      ctx.arc(x1, ballY, 10 + m1 * 5, 0, 2 * Math.PI);
      ctx.fill();
      ctx.fillStyle = '#000000';
      ctx.fillText(`m1=${m1}kg`, x1 - 20, ballY - 20);
      
      // 绘制物体2
      ctx.fillStyle = '#0066ff';
      ctx.beginPath();
      ctx.arc(x2, ballY, 10 + m2 * 5, 0, 2 * Math.PI);
      ctx.fill();
      ctx.fillStyle = '#000000';
      ctx.fillText(`m2=${m2}kg`, x2 - 20, ballY - 20);
      
      // 碰撞瞬间的视觉效果
      if (Math.abs(t - t_collision) < 0.1) {
        ctx.strokeStyle = '#ff0000';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc((x1 + x2) / 2, ballY, 30, 0, 2 * Math.PI);
        ctx.stroke();
        ctx.lineWidth = 2;
      }
      
      // 速度箭头
      if (Math.abs(v1) > 0.1) {
        drawVelocityArrow(x1, ballY, v1, '#ff6b00');
      }
      if (Math.abs(v2) > 0.1) {
        drawVelocityArrow(x2, ballY, v2, '#0066ff');
      }
      
      ctx.strokeStyle = '#000000';
      ctx.fillStyle = '#000000';
    }
    
    // 辅助函数：绘制速度箭头
    function drawVelocityArrow(x, y, v, color) {
      const arrowLen = Math.min(Math.abs(v) * 20, 80);
      const direction = v > 0 ? 1 : -1;
      
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      
      const endX = x + arrowLen * direction;
      
      // 箭头线
      ctx.beginPath();
      ctx.moveTo(x, y - 30);
      ctx.lineTo(endX, y - 30);
      ctx.stroke();
      
      // 箭头头部
      ctx.beginPath();
      ctx.moveTo(endX, y - 30);
      ctx.lineTo(endX - 8 * direction, y - 35);
      ctx.lineTo(endX - 8 * direction, y - 25);
      ctx.closePath();
      ctx.fill();
      
      ctx.fillText(`v=${v.toFixed(2)}m/s`, x, y - 45);
    }
    
    // ========== 原有代码继续 ==========
    
    // 移动端菜单切换
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    
    mobileMenuButton.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });
    
    // 导航栏滚动效果
    const navbar = document.getElementById('navbar');
    
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        navbar.classList.add('shadow');
        navbar.classList.remove('shadow-sm');
      } else {
        navbar.classList.remove('shadow');
        navbar.classList.add('shadow-sm');
      }
    });
    
    // ========== 旧的DOM动画代码已移除，使用Canvas系统 ==========

    // 图片背景功能已移除（简化界面）

    // ============================================================================
    // 📝 4. 参数管理模块 - 从表单获取参数
    // ============================================================================
    
    /**
     * 获取当前场景的物理参数
     * 
     * 功能说明：
     * - 从表单输入框读取用户输入的值
     * - 根据不同题型收集对应的参数字段
     * - 返回标准化的参数对象供 Canvas 渲染使用
     * 
     * 返回格式：
     * {
     *   type: "uniform",      // 题型
     *   v0: 0,                // 初速度
     *   a: 2,                 // 加速度
     *   time: 3,              // 时间
     *   // 其他题型特定参数...
     * }
     * 
     * @returns {Object} 参数对象
     */
    function getParams() {
      // collect generic params
      const type = questionTypeSelect.value;
      const params = { type };
      // common
      const v0 = document.getElementById('input-initial-velocity'); if (v0) params.v0 = parseFloat(v0.value || 0);
      const a = document.getElementById('input-acceleration'); if (a) params.a = parseFloat(a.value || 0);
      const t = document.getElementById('input-time'); if (t) params.t = parseFloat(t.value || 0);
      // type-specific
      if (type === 'projectile') {
        params.speed = parseFloat((document.getElementById('input-speed')||{}).value || 0);
        params.angle = parseFloat((document.getElementById('input-angle')||{}).value || 0) * Math.PI/180;
        params.height = parseFloat((document.getElementById('input-height')||{}).value || 0);
      }
      if (type === 'circular') {
        params.radius = parseFloat((document.getElementById('input-radius')||{}).value || 1);
        params.angular = parseFloat((document.getElementById('input-angular')||{}).value || 1);
      }
      if (type === 'collision') {
        params.m1 = parseFloat((document.getElementById('input-m1')||{}).value || 1);
        params.v1 = parseFloat((document.getElementById('input-v1')||{}).value || 0);
        params.m2 = parseFloat((document.getElementById('input-m2')||{}).value || 1);
        params.v2 = parseFloat((document.getElementById('input-v2')||{}).value || 0);
      }
      if (type === 'magnetic') {
        params.q = parseFloat((document.getElementById('input-charge')||{}).value || 0);
        params.v = parseFloat((document.getElementById('input-vel')||{}).value || 0);
        params.B = parseFloat((document.getElementById('input-field')||{}).value || 0);
      }
      if (type === 'astrodynamics') {
        params.M = parseFloat((document.getElementById('input-mass-central')||{}).value || 5.97e24);
        params.r = parseFloat((document.getElementById('input-radius-orbit')||{}).value || 7e6);
      }
      return params;
    }

    // Override previous simple physics functions to consult GRAVITY_OVERRIDE if set
    function effectiveGravity() { return typeof window.GRAVITY_OVERRIDE === 'number' ? window.GRAVITY_OVERRIDE : gravity; }

    // dispatch-based updateAnimation: short-circuit to type-specific routines
    function updateAnimation() {
      const params = getParams();
      const animatedObject = window.animatedObject || document.getElementById('animated-object');
      const animationTime = window.animationTime || document.getElementById('animation-time');
      const animationVelocity = window.animationVelocity || document.getElementById('animation-velocity');
      const animationPosition = window.animationPosition || document.getElementById('animation-position');
      const animationSpeed = window.animationSpeed || document.getElementById('animation-speed');
      const showTrail = window.showTrail || document.getElementById('show-trail');
      
      if (!animatedObject) return;
      
      if (params.type === 'uniform') {
        // collect data for precise charts
        if (!window.chartPosition || !window.chartVelocity) initializeUniformCharts();
        // reuse original free-fall-like logic but with custom acceleration
        const g = effectiveGravity();
        const distance = 0.5 * params.a * Math.pow(currentTime, 2) + (params.v0||0) * currentTime;
        const velocity = (params.v0||0) + (params.a||0) * currentTime;
        pixelsPerMeter = computePixelsPerMeter();
        const position = 20 + distance * pixelsPerMeter;
        animatedObject.style.top = `${position}px`;
        if (animationTime) animationTime.textContent = `时间: ${currentTime.toFixed(1)}s`;
        if (animationVelocity) animationVelocity.textContent = `速度: ${velocity.toFixed(1)}m/s`;
        if (animationPosition) animationPosition.textContent = `位置: ${distance.toFixed(1)}m`;
        // update charts with analytic values
        appendUniformData(currentTime, distance, velocity);
        if (showTrail && showTrail.checked && currentTime % 0.5 < 0.1) addTrailPoint(position);
        currentTime += 0.1 / (animationSpeed ? animationSpeed.value : 1);
  // record frame
  exportData.push({ t: currentTime, x: 0, y: distance, v: velocity, type: 'uniform' });
  animationId = requestAnimationFrame(updateAnimation);
      } else if (params.type === 'projectile') {
        // projectile motion in 2D (x horizontally, y vertically)
        pixelsPerMeter = computePixelsPerMeter();
        const vx = params.speed * Math.cos(params.angle || 0);
        const vy0 = params.speed * Math.sin(params.angle || 0);
        const y = (params.height || 0) + vy0 * currentTime - 0.5 * effectiveGravity() * Math.pow(currentTime, 2);
        const x = vx * currentTime;
        // position mapping: use x to move left-right, y to top-bottom
        const containerW = animationContainer.clientWidth;
        const left = Math.min(containerW - 40, Math.max(0, containerW/2 + x * pixelsPerMeter));
        const top = 20 + Math.max(0, (params.height || 0) + Math.max(0, -y)) * pixelsPerMeter; // simplistic mapping
        animatedObject.style.left = `${left}px`;
        animatedObject.style.top = `${top}px`;
        if (animationTime) animationTime.textContent = `时间: ${currentTime.toFixed(2)}s`;
        if (animationVelocity) animationVelocity.textContent = `速度垂直: ${(vy0 - effectiveGravity()*currentTime).toFixed(2)}m/s`;
        if (animationPosition) animationPosition.textContent = `x: ${x.toFixed(2)}m y: ${y.toFixed(2)}m`;
        if (showTrail && showTrail.checked && currentTime % 0.2 < 0.05) addTrailPoint(top);
        currentTime += 0.05 / (animationSpeed ? animationSpeed.value : 1);
        if (y < -50) { // left the view
          stopAnimation(); return;
        }
  // record projectile frame
  exportData.push({ t: currentTime, x: x, y: y, v: Math.sqrt(vx*vx + (vy0 - effectiveGravity()*currentTime)*(vy0 - effectiveGravity()*currentTime)), type: 'projectile' });
  animationId = requestAnimationFrame(updateAnimation);
      } else if (params.type === 'circular') {
        pixelsPerMeter = computePixelsPerMeter();
        const theta = (params.angular || 1) * currentTime;
        const r = params.radius || 2;
        const cx = animationContainer.clientWidth/2;
        const cy = animationContainer.clientHeight/2;
        const x = cx + r * pixelsPerMeter * Math.cos(theta);
        const y = cy + r * pixelsPerMeter * Math.sin(theta);
        animatedObject.style.left = `${x - 12}px`;
        animatedObject.style.top = `${y - 12}px`;
        if (animationTime) animationTime.textContent = `时间: ${currentTime.toFixed(2)}s`;
        if (animationVelocity) animationVelocity.textContent = `角度: ${theta.toFixed(2)}rad`;
        if (animationPosition) animationPosition.textContent = `半径: ${r}m`;
        currentTime += 0.05 / (animationSpeed ? animationSpeed.value : 1);
  exportData.push({ t: currentTime, x: x - 12, y: y - 12, v: (params.angular||1)*r, type: 'circular' });
  animationId = requestAnimationFrame(updateAnimation);
      } else if (params.type === 'collision') {
        // simple 1D elastic collision visualization: two objects approach center
        pixelsPerMeter = computePixelsPerMeter();
        const L = animationContainer.clientWidth;
        const x1 = L/4 + (params.v1 || 0) * currentTime * pixelsPerMeter;
        const x2 = L*3/4 + (params.v2 || 0) * currentTime * pixelsPerMeter;
        // map two objects: we'll reuse animatedObject for the first and create a second if missing
        animatedObject.style.left = `${x1}px`;
        // second
        let obj2 = document.getElementById('animated-object-2');
        if (!obj2) {
          obj2 = document.createElement('div');
          obj2.id = 'animated-object-2';
          obj2.className = 'absolute w-8 h-8 bg-secondary rounded-full';
          animationContainer.appendChild(obj2);
        }
        obj2.style.top = `${animationContainer.clientHeight/2}px`;
        obj2.style.left = `${x2}px`;
        if (animationTime) animationTime.textContent = `时间: ${currentTime.toFixed(2)}s`;
        currentTime += 0.05 / (animationSpeed ? animationSpeed.value : 1);
        // stop if they cross
        if (x1 + 16 >= x2) { stopAnimation(); return; }
  exportData.push({ t: currentTime, x1: x1, x2: x2, type: 'collision' });
  animationId = requestAnimationFrame(updateAnimation);
      } else if (params.type === 'magnetic') {
        // charged particle circular motion approximation
        pixelsPerMeter = computePixelsPerMeter();
        const q = params.q || 1e-6;
        const v = params.v || 100;
        const B = params.B || 0.1;
        const m = parseFloat((document.getElementById('input-mass')||{}).value || 1);
        const r = Math.abs(m * v / (q * B + 1e-12));
        const omega = v / r;
        const cx = animationContainer.clientWidth/2;
        const cy = animationContainer.clientHeight/2;
        const x = cx + r * pixelsPerMeter * Math.cos(omega * currentTime);
        const y = cy + r * pixelsPerMeter * Math.sin(omega * currentTime);
        animatedObject.style.left = `${x - 12}px`;
        animatedObject.style.top = `${y - 12}px`;
        if (animationTime) animationTime.textContent = `时间: ${currentTime.toFixed(2)}s`;
        if (animationVelocity) animationVelocity.textContent = `速率: ${v.toFixed(1)}m/s`;
        if (animationPosition) animationPosition.textContent = `半径: ${r.toExponential(2)}m`;
        currentTime += 0.05 / (animationSpeed ? animationSpeed.value : 1);
  exportData.push({ t: currentTime, x: x - 12, y: y - 12, v: v, type: 'magnetic' });
  animationId = requestAnimationFrame(updateAnimation);
      } else {
        // default fallback: use original free-fall
        const distance = calculateDistance(currentTime);
        const velocity = calculateVelocity(currentTime);
        pixelsPerMeter = computePixelsPerMeter();
        const position = 20 + distance * pixelsPerMeter;
        animatedObject.style.top = `${position}px`;
        if (animationTime) animationTime.textContent = `时间: ${currentTime.toFixed(1)}s`;
        if (animationVelocity) animationVelocity.textContent = `速度: ${velocity.toFixed(1)}m/s`;
        if (animationPosition) animationPosition.textContent = `位置: ${distance.toFixed(1)}m`;
        if (showTrail && showTrail.checked && currentTime % 0.5 < 0.1) addTrailPoint(position);
        currentTime += 0.1 / (animationSpeed ? animationSpeed.value : 1);
        exportData.push({ t: currentTime, x: 0, y: distance, v: velocity, type: 'default' });
        animationId = requestAnimationFrame(updateAnimation);
      }
    }

    // 添加轨迹点
    function addTrailPoint(yPosition) {
      if (!animationContainer) return;
      const trailPoint = document.createElement('div');
      trailPoint.className = 'absolute w-2 h-2 bg-accent/50 rounded-full';
      trailPoint.style.left = '50%';
      trailPoint.style.top = `${yPosition}px`;
      trailPoint.style.transform = 'translateX(-50%)';
      animationContainer.appendChild(trailPoint);
    }

    // 开始动画
    // 注意：startAnimation()、stopAnimation()、resetAnimation() 函数
    // 已在前面的"动画控制模块"中定义（约1581行），此处不再重复定义

    // --------------- Chart.js for uniform motion ----------------
    function initializeUniformCharts() {
      const ctxS = document.getElementById('chart-position').getContext('2d');
      const ctxV = document.getElementById('chart-velocity').getContext('2d');
      window.chartPosition = new Chart(ctxS, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 's(t) (m)', data: [], borderColor: '#2563EB', backgroundColor: 'rgba(37,99,235,0.08)', tension: 0.2 }] },
        options: { animation: false, responsive: true, scales: { x: { title: { display: true, text: '时间 (s)' } }, y: { title: { display: true, text: '位移 (m)' } } } }
      });

      window.chartVelocity = new Chart(ctxV, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'v(t) (m/s)', data: [], borderColor: '#059669', backgroundColor: 'rgba(5,150,105,0.06)', tension: 0.2 }] },
        options: { animation: false, responsive: true, scales: { x: { title: { display: true, text: '时间 (s)' } }, y: { title: { display: true, text: '速度 (m/s)' } } } }
      });
    }

    function appendUniformData(t, s, v) {
      if (!window.chartPosition || !window.chartVelocity) return;
      const maxPoints = 200; // limit to avoid huge accumulation
      const pos = window.chartPosition;
      const vel = window.chartVelocity;
      pos.data.labels.push(t.toFixed(2));
      pos.data.datasets[0].data.push(s);
      vel.data.labels.push(t.toFixed(2));
      vel.data.datasets[0].data.push(v);
      if (pos.data.labels.length > maxPoints) {
        pos.data.labels.shift(); pos.data.datasets[0].data.shift();
        vel.data.labels.shift(); vel.data.datasets[0].data.shift();
      }
      pos.update('none');
      vel.update('none');
    }

    function clearUniformCharts() {
      if (window.chartPosition) { window.chartPosition.data.labels = []; window.chartPosition.data.datasets[0].data = []; window.chartPosition.update(); }
      if (window.chartVelocity) { window.chartVelocity.data.labels = []; window.chartVelocity.data.datasets[0].data = []; window.chartVelocity.update(); }
    }
    
    // 新增：统一的图表更新函数（适配 Canvas 动画系统）
    function updateCharts() {
      if (!sceneParams) return;
      
      // 初始化图表（如果尚未初始化）
      if (!window.chartPosition || !window.chartVelocity) {
        initializeUniformCharts();
      }
      
      const t = currentTime;
      const type = sceneParams.type;
      
      // 根据运动类型计算位移和速度
      let s = 0; // 位移
      let v = 0; // 速度
      
      if (type === 'uniform') {
        const g = 10;
        const v0 = sceneParams.v0 || 0;
        const h0 = sceneParams.height || 8;
        s = h0 + v0 * t - 0.5 * g * t * t;
        v = v0 - g * t;
      } else if (type === 'projectile') {
        const g = 10;
        const v0 = sceneParams.speed || 10;
        const angle = sceneParams.angle || 0;
        const vx = v0 * Math.cos(angle);
        const vy0 = v0 * Math.sin(angle);
        const h0 = sceneParams.height || 0;
        
        const x = vx * t;
        const y = h0 + vy0 * t - 0.5 * g * t * t;
        s = Math.sqrt(x * x + (y - h0) * (y - h0)); // 合位移
        
        const vy = vy0 - g * t;
        v = Math.sqrt(vx * vx + vy * vy); // 合速度
      } else if (type === 'circular') {
        const r = sceneParams.radius || 2;
        const omega = sceneParams.omega || 1;
        s = omega * r * t; // 弧长
        v = omega * r; // 线速度恒定
      } else if (type === 'collision') {
        // 碰撞后速度可能变化，这里简化处理
        s = 0;
        v = 0;
      }
      
      // 更新图表（每隔几帧更新一次以提高性能）
      if (Math.round(t * 20) % 2 === 0) { // 约每0.1秒更新一次
        appendUniformData(t, s, v);
      }
    }

    // ========== 初始化所有功能 ==========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('📌 DOM加载完成，开始初始化...');
      
      // 获取关键元素引用
      questionTypeSelect = document.getElementById('question-type-select');
      generateButton = document.getElementById('generate-animation');
      playBtn = document.getElementById('play-animation');
      pauseBtn = document.getElementById('pause-animation');
      animationContainer = document.getElementById('animation-container');
      
      // 初始化旧DOM动画相关元素（用于导出功能）
      window.animatedObject = document.getElementById('animated-object');
      window.animationTime = document.getElementById('animation-time');
      window.animationVelocity = document.getElementById('animation-velocity');
      window.animationPosition = document.getElementById('animation-position');
      window.animationSpeed = document.getElementById('animation-speed');
      window.showTrail = document.getElementById('show-trail');
      
      const dynamicParams = document.getElementById('dynamic-params');
      const descriptionEl = document.getElementById('problem-description');
      const parseButton = document.getElementById('parse-description');
      
      console.log('🔍 元素检查:', {
        questionTypeSelect: !!questionTypeSelect,
        generateButton: !!generateButton,
        playBtn: !!playBtn,
        pauseBtn: !!pauseBtn,
        animationContainer: !!animationContainer,
        dynamicParams: !!dynamicParams
      });
      
      if (!dynamicParams) {
        console.error('❌ 找不到 dynamic-params 元素！');
        return;
      }
      
      // ========== AI 智能解析配置 ==========
      // 使用已部署的 Cloudflare Workers 后端 URL
      const BACKEND_PATH = 'https://physics-visual-worker.yywf08125.workers.dev/api/parse-problem';
      
      // ========== 动态参数功能 ==========
      function clearDynamicParams() {
        dynamicParams.innerHTML = '';
      }

      function createParamField(id, label, value, type='number') {
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-2';
        wrapper.innerHTML = `
          <label class="text-xs text-gray-500">${label}</label>
          <input id="${id}" type="${type}" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="${value}">
        `;
        return wrapper;
      }

      function populateParamsForType(type) {
        clearDynamicParams();
        if (type === 'uniform') {
          dynamicParams.appendChild(createParamField('input-initial-velocity', '初始速度 (m/s)', '0'));
          dynamicParams.appendChild(createParamField('input-acceleration', '加速度 (m/s^2)', '10'));
          dynamicParams.appendChild(createParamField('input-time', '时间 (s)', '5'));
        } else if (type === 'projectile') {
          dynamicParams.appendChild(createParamField('input-speed', '初速度 (m/s)', '10'));
          dynamicParams.appendChild(createParamField('input-angle', '角度 (度)', '45'));
          dynamicParams.appendChild(createParamField('input-height', '初始高度 (m)', '0'));
        } else if (type === 'circular') {
          dynamicParams.appendChild(createParamField('input-radius', '半径 (m)', '2'));
          dynamicParams.appendChild(createParamField('input-angular', '角速度 (rad/s)', '1'));
        } else if (type === 'collision') {
          dynamicParams.appendChild(createParamField('input-m1', '质量 m1 (kg)', '1'));
          dynamicParams.appendChild(createParamField('input-v1', '速度 v1 (m/s)', '2'));
          dynamicParams.appendChild(createParamField('input-m2', '质量 m2 (kg)', '1'));
          dynamicParams.appendChild(createParamField('input-v2', '速度 v2 (m/s)', '-1'));
        } else if (type === 'magnetic') {
          dynamicParams.appendChild(createParamField('input-charge', '电荷 q (C)', '1e-6', 'text'));
          dynamicParams.appendChild(createParamField('input-vel', '速度 v (m/s)', '100'));
          dynamicParams.appendChild(createParamField('input-field', '磁场 B (T)', '0.1'));
        } else if (type === 'astrodynamics') {
          dynamicParams.appendChild(createParamField('input-mass-central', '中心天体质量 (kg)', '5.97e24', 'text'));
          dynamicParams.appendChild(createParamField('input-radius-orbit', '轨道半径 (m)', '7e6', 'text'));
        }
      }

      // 初始填充参数
      if (questionTypeSelect && dynamicParams) {
        console.log('📝 开始填充动态参数，当前类型:', questionTypeSelect.value);
        populateParamsForType(questionTypeSelect.value || 'uniform');
        console.log('✅ 参数填充完成');
        
        // 监听题型变化
        questionTypeSelect.addEventListener('change', () => {
          console.log('🔄 题型变化为:', questionTypeSelect.value);
          populateParamsForType(questionTypeSelect.value);
        });
      } else {
        console.error('❌ questionTypeSelect 或 dynamicParams 未找到!', {
          questionTypeSelect: !!questionTypeSelect,
          dynamicParams: !!dynamicParams
        });
      }
      
      // ============================================================================
      // 📚 知识点库和题型分类UI初始化
      // ============================================================================
      
      /**
       * 渲染知识点库分类导航
       */
      function renderKnowledgeCategories() {
        const navContainer = document.getElementById('knowledge-nav');
        if (!navContainer) return;
        
        navContainer.innerHTML = '';
        
        for (const [categoryKey, category] of Object.entries(KNOWLEDGE_BASE)) {
          const topicsCount = Object.keys(category.topics).length;
          const li = document.createElement('li');
          
          // 为所有分类添加可展开的子菜单
          if (categoryKey === 'mechanics' || categoryKey === 'electromagnetism' || categoryKey === 'thermodynamics' || categoryKey === 'optics' || categoryKey === 'atomicPhysics') {
            li.innerHTML = `
              <div>
                <button class="knowledge-category-btn w-full text-left px-4 py-3 rounded-xl hover:bg-gray-50 text-gray-700 text-sm font-medium transition-all duration-200 flex items-center justify-between gap-2 border border-transparent hover:border-gray-200 hover:shadow-sm" 
                        data-category="${categoryKey}">
                  <div class="flex items-center gap-3">
                    <span class="text-xl">${category.icon}</span>
                    <span>${category.name}</span>
                  </div>
                  <i class="fa fa-chevron-down text-xs transition-transform dropdown-icon"></i>
                </button>
                <div class="submenu-container hidden mt-2 ml-4 space-y-1" data-submenu="${categoryKey}">
                  ${Object.entries(category.topics).map(([topicKey, topic]) => `
                    <button class="topic-btn w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 text-gray-600 text-sm transition-colors flex items-center gap-2" 
                            data-category="${categoryKey}" 
                            data-topic="${topicKey}">
                      <i class="fa fa-angle-right text-xs"></i>
                      <span>${topic.name}</span>
                    </button>
                  `).join('')}
                </div>
              </div>
            `;
          } else {
            li.innerHTML = `
              <button class="knowledge-category-btn w-full text-left px-4 py-3 rounded-xl hover:bg-gray-50 text-gray-700 text-sm font-medium transition-all duration-200 flex items-center gap-2 border border-transparent hover:border-gray-200 hover:shadow-sm" 
                      data-category="${categoryKey}">
                <div class="flex items-center gap-3">
                  <span class="text-xl">${category.icon}</span>
                  <span>${category.name}</span>
                </div>
              </button>
            `;
          }
          
          navContainer.appendChild(li);
          
          const categoryBtn = li.querySelector('.knowledge-category-btn');
          
          // 添加分类按钮点击事件
          categoryBtn.addEventListener('click', () => {
            // 如果有子菜单，切换下拉菜单
            if (categoryKey === 'mechanics' || categoryKey === 'electromagnetism' || categoryKey === 'thermodynamics' || categoryKey === 'optics' || categoryKey === 'atomicPhysics') {
              const submenu = li.querySelector('.submenu-container');
              const icon = categoryBtn.querySelector('.dropdown-icon');
              const isCurrentlyHidden = submenu.classList.contains('hidden');
              
              // 切换显示状态
              submenu.classList.toggle('hidden');
              icon.classList.toggle('rotate-180');
              
              // 如果是展开操作，设置按钮为active状态
              if (isCurrentlyHidden) {
                // 清除其他分类按钮的active状态
                document.querySelectorAll('.knowledge-category-btn').forEach(btn => {
                  if (btn !== categoryBtn) {
                    btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('hover:bg-gray-50', 'text-gray-700', 'border-transparent');
                  }
                });
                
                // 关闭其他可能展开的子菜单
                document.querySelectorAll('.submenu-container').forEach(menu => {
                  if (menu !== submenu) {
                    menu.classList.add('hidden');
                  }
                });
                document.querySelectorAll('.dropdown-icon').forEach(ic => {
                  if (ic !== icon) {
                    ic.classList.remove('rotate-180');
                  }
                });
                
                // 设置当前按钮为active
                categoryBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
                categoryBtn.classList.remove('hover:bg-gray-50', 'text-gray-700', 'border-transparent');
              }
            } else {
              // 清除其他按钮的active状态
              document.querySelectorAll('.knowledge-category-btn').forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('hover:bg-gray-50', 'text-gray-700', 'border-transparent');
              });
              
              // 关闭所有子菜单
              document.querySelectorAll('.submenu-container').forEach(menu => {
                menu.classList.add('hidden');
              });
              document.querySelectorAll('.dropdown-icon').forEach(icon => {
                icon.classList.remove('rotate-180');
              });
              
              // 设置当前按钮为active
              categoryBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
              categoryBtn.classList.remove('hover:bg-gray-50', 'text-gray-700', 'border-transparent');
              
              // 渲染该分类的知识点
              renderKnowledgeTopics(categoryKey);
            }
          });
          
          // 为子主题按钮添加点击事件（所有有子菜单的分类）
          if (categoryKey === 'mechanics' || categoryKey === 'electromagnetism' || categoryKey === 'thermodynamics' || categoryKey === 'optics' || categoryKey === 'atomicPhysics') {
            li.querySelectorAll('.topic-btn').forEach(topicBtn => {
              topicBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const topicKey = topicBtn.dataset.topic;
                
                // 清除所有子主题的active状态
                li.querySelectorAll('.topic-btn').forEach(btn => {
                  btn.classList.remove('bg-blue-100', 'text-blue-700', 'font-medium');
                  btn.classList.add('text-gray-600');
                });
                
                // 设置当前子主题为active
                topicBtn.classList.add('bg-blue-100', 'text-blue-700', 'font-medium');
                topicBtn.classList.remove('text-gray-600');
                
                // 渲染单个主题
                renderSingleTopic(categoryKey, topicKey);
              });
            });
          }
        }
        
        // 默认不展开任何分类，显示欢迎信息
        const contentContainer = document.getElementById('knowledge-content');
        if (contentContainer) {
          contentContainer.innerHTML = `
            <div class="bg-gradient-to-br from-purple-50 via-white to-blue-50 rounded-2xl shadow-lg p-16 text-center border border-purple-100 flex flex-col justify-center min-h-[400px]">
              <div class="text-6xl mb-6">📚</div>
              <h3 class="text-2xl font-bold text-gray-800 mb-4">欢迎来到物理知识点库</h3>
              <p class="text-gray-600 text-lg mb-8">请从左侧选择一个分类开始学习</p>
              <div class="flex justify-center gap-8 text-sm text-gray-500">
                <div class="flex flex-col items-center gap-2">
                  <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fa fa-book text-purple-600 text-xl"></i>
                  </div>
                  <span>5个分类</span>
                </div>
                <div class="flex flex-col items-center gap-2">
                  <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fa fa-list text-blue-600 text-xl"></i>
                  </div>
                  <span>多个主题</span>
                </div>
                <div class="flex flex-col items-center gap-2">
                  <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <i class="fa fa-lightbulb-o text-green-600 text-xl"></i>
                  </div>
                  <span>丰富例题</span>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      /**
       * 渲染单个主题内容（用于力学子分类）
       */
      function renderSingleTopic(categoryKey, topicKey) {
        const contentContainer = document.getElementById('knowledge-content');
        if (!contentContainer) return;
        
        const category = KNOWLEDGE_BASE[categoryKey];
        if (!category) return;
        
        const topic = category.topics[topicKey];
        if (!topic) return;
        
        contentContainer.innerHTML = '';
        
        const topicCard = document.createElement('div');
        topicCard.className = 'bg-white rounded-2xl shadow-lg p-8 mb-8 border border-gray-100 hover:shadow-xl transition-all duration-300';
        
        const difficultyColors = {
          1: 'bg-green-100 text-green-700 border-green-200',
          2: 'bg-blue-100 text-blue-700 border-blue-200',
          3: 'bg-yellow-100 text-yellow-700 border-yellow-200',
          4: 'bg-orange-100 text-orange-700 border-orange-200',
          5: 'bg-red-100 text-red-700 border-red-200'
        };
        
        const difficultyText = ['', '基础', '简单', '中等', '困难', '极难'][topic.difficulty] || '中等';
        const difficultyClass = difficultyColors[topic.difficulty] || difficultyColors[3];
        
        topicCard.innerHTML = `
          <div class="flex justify-between items-start mb-6">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <h3 class="text-2xl font-bold text-gray-900">${topic.name}</h3>
                <span class="${difficultyClass} text-xs px-3 py-1.5 rounded-full border font-medium">${difficultyText}</span>
              </div>
              <div class="flex items-center gap-2 text-sm text-gray-500">
                <i class="fa fa-tag"></i>
                <span>${category.name}</span>
              </div>
            </div>
            <button class="text-gray-400 hover:text-yellow-500 transition-colors text-xl">
              <i class="fa fa-star-o"></i>
            </button>
          </div>
          
          <div class="prose max-w-none">
            <p class="text-gray-600 text-base leading-relaxed mb-6 bg-blue-50 p-4 rounded-xl border-l-4 border-blue-400">${topic.description}</p>
            
            <h4 class="text-lg font-bold text-gray-900 mt-6 mb-4 flex items-center gap-2">
              <i class="fa fa-calculator text-blue-500"></i>
              基本公式
            </h4>
            <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl mb-6 border border-gray-200">
              ${topic.formulas.map((formula, idx) => `
                <p class="mb-3 font-mono text-base text-gray-800 flex items-start gap-3">
                  <span class="inline-block w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">${idx + 1}</span>
                  <span class="flex-1">${formula}</span>
                </p>
              `).join('')}
            </div>
            
            <h4 class="text-lg font-bold text-gray-900 mt-6 mb-4 flex items-center gap-2">
              <i class="fa fa-lightbulb-o text-yellow-500"></i>
              典型例题
              <span class="text-xs font-normal text-gray-500 ml-2">(${topic.examples.length}个)</span>
            </h4>
            <div class="space-y-4">
              ${topic.examples.map((example, idx) => `
                <div class="group border-2 border-gray-200 rounded-xl p-5 hover:border-blue-400 hover:shadow-md transition-all duration-200 cursor-pointer example-card bg-gradient-to-r from-white to-gray-50" 
                     data-example='${JSON.stringify(example)}'>
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                      <span class="inline-block w-8 h-8 rounded-lg bg-blue-500 text-white text-sm font-bold flex items-center justify-center">${idx + 1}</span>
                      <h5 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors">${example.title}</h5>
                    </div>
                    <button class="text-sm px-4 py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center gap-1.5 shadow-sm">
                      <i class="fa fa-play-circle"></i>
                      加载
                    </button>
                  </div>
                  <p class="text-sm text-gray-600 leading-relaxed ml-11 line-clamp-2">${example.description}</p>
                  <div class="mt-4 ml-11 flex items-center gap-4 text-xs text-gray-500">
                    <span><i class="fa fa-clock-o mr-1"></i>建议时间: 5分钟</span>
                    <span><i class="fa fa-signal mr-1"></i>难度: ${'★'.repeat(topic.difficulty)}${'☆'.repeat(5-topic.difficulty)}</span>
                    <span class="ml-auto text-blue-600 group-hover:text-blue-700 font-medium">
                      点击查看详解 <i class="fa fa-angle-right ml-1"></i>
                    </span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        contentContainer.appendChild(topicCard);
        
        // 为例题卡片添加点击事件
        topicCard.querySelectorAll('.example-card').forEach(card => {
          card.addEventListener('click', () => {
            const exampleData = JSON.parse(card.getAttribute('data-example'));
            loadExample(exampleData);
          });
        });
      }
      
      /**
       * 渲染知识点内容
       */
      function renderKnowledgeTopics(categoryKey) {
        const contentContainer = document.getElementById('knowledge-content');
        if (!contentContainer) return;
        
        const category = KNOWLEDGE_BASE[categoryKey];
        if (!category) return;
        
        contentContainer.innerHTML = '';
        
        for (const [topicKey, topic] of Object.entries(category.topics)) {
          const topicCard = document.createElement('div');
          topicCard.className = 'bg-white rounded-2xl shadow-lg p-8 mb-8 border border-gray-100 hover:shadow-xl transition-all duration-300';
          
          const difficultyColors = {
            1: 'bg-green-100 text-green-700 border-green-200',
            2: 'bg-blue-100 text-blue-700 border-blue-200',
            3: 'bg-yellow-100 text-yellow-700 border-yellow-200',
            4: 'bg-orange-100 text-orange-700 border-orange-200',
            5: 'bg-red-100 text-red-700 border-red-200'
          };
          
          const difficultyText = ['', '基础', '简单', '中等', '困难', '极难'][topic.difficulty] || '中等';
          const difficultyClass = difficultyColors[topic.difficulty] || difficultyColors[3];
          
          topicCard.innerHTML = `
            <div class="flex justify-between items-start mb-6">
              <div>
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="text-2xl font-bold text-gray-900">${topic.name}</h3>
                  <span class="${difficultyClass} text-xs px-3 py-1.5 rounded-full border font-medium">${difficultyText}</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                  <i class="fa fa-tag"></i>
                  <span>${category.name}</span>
                </div>
              </div>
              <button class="text-gray-400 hover:text-yellow-500 transition-colors text-xl">
                <i class="fa fa-star-o"></i>
              </button>
            </div>
            
            <div class="prose max-w-none">
              <p class="text-gray-600 text-base leading-relaxed mb-6 bg-blue-50 p-4 rounded-xl border-l-4 border-blue-400">${topic.description}</p>
              
              <h4 class="text-lg font-bold text-gray-900 mt-6 mb-4 flex items-center gap-2">
                <i class="fa fa-calculator text-blue-500"></i>
                基本公式
              </h4>
              <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl mb-6 border border-gray-200">
                ${topic.formulas.map((formula, idx) => `
                  <p class="mb-3 font-mono text-base text-gray-800 flex items-start gap-3">
                    <span class="inline-block w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center flex-shrink-0 mt-0.5">${idx + 1}</span>
                    <span class="flex-1">${formula}</span>
                  </p>
                `).join('')}
              </div>
              
              <h4 class="text-lg font-bold text-gray-900 mt-6 mb-4 flex items-center gap-2">
                <i class="fa fa-lightbulb-o text-yellow-500"></i>
                典型例题
                <span class="text-xs font-normal text-gray-500 ml-2">(${topic.examples.length}个)</span>
              </h4>
              <div class="space-y-4">
                ${topic.examples.map((example, idx) => `
                  <div class="group border-2 border-gray-200 rounded-xl p-5 hover:border-blue-400 hover:shadow-md transition-all duration-200 cursor-pointer example-card bg-gradient-to-r from-white to-gray-50" 
                       data-example='${JSON.stringify(example)}'>
                    <div class="flex justify-between items-start mb-3">
                      <div class="flex items-center gap-3">
                        <span class="inline-block w-8 h-8 rounded-lg bg-blue-500 text-white text-sm font-bold flex items-center justify-center">${idx + 1}</span>
                        <h5 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors">${example.title}</h5>
                      </div>
                      <button class="text-sm px-4 py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center gap-1.5 shadow-sm">
                        <i class="fa fa-play-circle"></i>
                        加载
                      </button>
                    </div>
                    <p class="text-sm text-gray-600 leading-relaxed ml-11 line-clamp-2">${example.description}</p>
                    <div class="mt-4 ml-11 flex items-center gap-4 text-xs text-gray-500">
                      <span><i class="fa fa-clock-o mr-1"></i>建议时间: 5分钟</span>
                      <span><i class="fa fa-signal mr-1"></i>难度: ★★☆☆☆</span>
                      <span class="ml-auto text-blue-600 group-hover:text-blue-700 font-medium">
                        点击查看详解 <i class="fa fa-angle-right ml-1"></i>
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          
          contentContainer.appendChild(topicCard);
          
          // 为例题卡片添加点击事件
          topicCard.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
              const exampleData = JSON.parse(card.getAttribute('data-example'));
              loadExample(exampleData);
            });
          });
        }
      }
      
      /**
       * 加载例题到可视化区域
       */
      function loadExample(example) {
        console.log('📖 加载例题:', example);
        
        // 创建例题详情弹窗
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
        
        const content = document.createElement('div');
        content.className = 'bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto';
        
        // 获取题型信息
        const questionType = QUESTION_TAXONOMY.find(q => q.id === example.type);
        const typeIcon = questionType ? questionType.icon : '📝';
        const typeName = questionType ? questionType.name : example.type;
        
        content.innerHTML = `
          <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
              <span class="text-2xl">${typeIcon}</span>
              ${example.title}
            </h2>
            <button onclick="this.closest('.fixed').remove()" 
                    class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
              ×
            </button>
          </div>
          
          <div class="p-6 space-y-6">
            <!-- 题型标签 -->
            <div class="flex gap-2 flex-wrap">
              <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                ${typeName}
              </span>
              <span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">
                难度 ${example.difficulty || '未知'}
              </span>
              ${example.tags ? example.tags.map(tag => `
                <span class="bg-gray-100 text-gray-700 text-sm px-3 py-1 rounded-full">${tag}</span>
              `).join('') : ''}
            </div>
            
            <!-- 题目描述 -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
                📋 题目描述
              </h3>
              <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed">
                ${example.description}
              </div>
            </div>
            
            <!-- 已知参数 -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
                📊 已知参数
              </h3>
              <div class="bg-blue-50 rounded-lg p-4">
                <ul class="grid grid-cols-2 gap-2 text-sm">
                  ${Object.entries(example.params).map(([key, val]) => {
                    const labels = {
                      v0: '初速度', a: '加速度', time: '时间', speed: '速度',
                      angle: '角度', height: '高度', radius: '半径', angular: '角速度',
                      m1: '质量1', v1: '速度1', m2: '质量2', v2: '速度2'
                    };
                    return `<li class="text-gray-700">• <strong>${labels[key] || key}:</strong> ${val}</li>`;
                  }).join('')}
                </ul>
              </div>
            </div>
            
            <!-- 解答思路 (如果有) -->
            ${example.solution ? `
              <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
                  💡 解答思路
                </h3>
                <div class="bg-yellow-50 rounded-lg p-4 text-gray-700 leading-relaxed">
                  ${example.solution}
                </div>
              </div>
            ` : ''}
            
            <!-- 操作按钮 -->
            <div class="flex gap-3 pt-4 border-t">
              <button id="view-visualization-btn" 
                      class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-600 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <span>🎬</span> 查看可视化动画
              </button>
              <button onclick="this.closest('.fixed').remove()" 
                      class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                取消
              </button>
            </div>
          </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // 绑定"查看可视化"按钮事件
        document.getElementById('view-visualization-btn').addEventListener('click', () => {
          modal.remove();
          
          // 1. 设置题型
          if (questionTypeSelect) {
            questionTypeSelect.value = example.type;
            questionTypeSelect.dispatchEvent(new Event('change'));
          }
          
          // 2. 填充题目描述
          const descriptionEl = document.getElementById('problem-description');
          if (descriptionEl) {
            descriptionEl.value = example.description;
          }
          
          // 3. 等待参数字段生成后填充参数
          setTimeout(() => {
            for (const [key, value] of Object.entries(example.params)) {
              let inputId = '';
              
              // 映射参数名到输入框ID
              if (key === 'v0') inputId = 'input-initial-velocity';
              else if (key === 'a') inputId = 'input-acceleration';
              else if (key === 'time') inputId = 'input-time';
              else if (key === 'speed') inputId = 'input-speed';
              else if (key === 'angle') inputId = 'input-angle';
              else if (key === 'height') inputId = 'input-height';
              else if (key === 'radius') inputId = 'input-radius';
              else if (key === 'angular') inputId = 'input-angular';
              else if (key === 'm1') inputId = 'input-m1';
              else if (key === 'v1') inputId = 'input-v1';
              else if (key === 'm2') inputId = 'input-m2';
              else if (key === 'v2') inputId = 'input-v2';
              
              const input = document.getElementById(inputId);
              if (input) {
                input.value = value;
              }
            }
            
            // 3.5 设置视觉参数（如果例题有visual字段）
            if (example.visual) {
              window.sceneVisualSettings = example.visual;
              console.log('🎨 加载例题的视觉参数:', example.visual);
            }
            
            // 4. 自动生成可视化
            if (generateButton) {
              generateButton.click();
            }
            
            // 5. 滚动到可视化区域
            setTimeout(() => {
              const vizSection = document.getElementById('visualization');
              if (vizSection) {
                vizSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 200);
          }, 100);
        });
      }
      
      /**
       * 渲染题型分类卡片
       */
      /**
       * 渲染题型分类(左右布局)
       */
      function renderQuestionTypes() {
        const navContainer = document.getElementById('question-types-nav');
        const contentContainer = document.getElementById('question-types-content');
        
        if (!navContainer || !contentContainer) return;
        
        // 渲染左侧导航 - 下拉式菜单
        navContainer.innerHTML = '';
        
        for (const [categoryKey, category] of Object.entries(QUESTION_TAXONOMY)) {
          const diffCount = Object.keys(category.difficulties).length;
          const li = document.createElement('li');
          
          // 为所有分类添加可展开的子菜单
          li.innerHTML = `
            <div>
              <button class="question-type-category-btn w-full text-left px-4 py-3 rounded-xl hover:bg-gray-50 text-gray-700 text-sm font-medium transition-all duration-200 flex items-center justify-between gap-2 border border-transparent hover:border-gray-200 hover:shadow-sm" 
                      data-category="${categoryKey}">
                <div class="flex items-center gap-3">
                  <span class="text-xl">${category.icon}</span>
                  <span>${category.name}</span>
                </div>
                <i class="fa fa-chevron-down text-xs transition-transform dropdown-icon"></i>
              </button>
              <div class="submenu-container hidden mt-2 ml-4 space-y-1" data-submenu="${categoryKey}">
                ${Object.entries(category.difficulties).map(([diffKey, diff]) => `
                  <button class="difficulty-btn w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-gray-600 text-sm transition-colors flex items-center gap-2" 
                          data-category="${categoryKey}" 
                          data-difficulty="${diffKey}">
                    <i class="fa fa-angle-right text-xs"></i>
                    <span>${diff.name}</span>
                  </button>
                `).join('')}
              </div>
            </div>
          `;
          
          navContainer.appendChild(li);
          
          const categoryBtn = li.querySelector('.question-type-category-btn');
          
          // 添加分类按钮点击事件 - 切换下拉菜单
          categoryBtn.addEventListener('click', () => {
            const submenu = li.querySelector('.submenu-container');
            const icon = categoryBtn.querySelector('.dropdown-icon');
            const isCurrentlyHidden = submenu.classList.contains('hidden');
            
            // 切换显示状态
            submenu.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
            
            // 如果是展开操作，设置按钮为active状态
            if (isCurrentlyHidden) {
              // 清除其他分类按钮的active状态
              document.querySelectorAll('.question-type-category-btn').forEach(btn => {
                if (btn !== categoryBtn) {
                  btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
                  btn.classList.add('hover:bg-gray-50', 'text-gray-700', 'border-transparent');
                }
              });
              
              // 关闭其他可能展开的子菜单
              document.querySelectorAll('.submenu-container').forEach(menu => {
                if (menu !== submenu) {
                  menu.classList.add('hidden');
                }
              });
              document.querySelectorAll('.dropdown-icon').forEach(ic => {
                if (ic !== icon) {
                  ic.classList.remove('rotate-180');
                }
              });
              
              // 设置当前按钮为active
              categoryBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
              categoryBtn.classList.remove('hover:bg-gray-50', 'text-gray-700', 'border-transparent');
            }
          });
        }
        
        // 渲染右侧内容(默认显示欢迎界面)
        renderQuestionTypeWelcome();
        
        // 绑定难度按钮点击事件
        navContainer.querySelectorAll('.difficulty-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const categoryKey = btn.dataset.category;
            const difficultyKey = btn.dataset.difficulty;
            
            // 更新难度按钮激活状态
            navContainer.querySelectorAll('.difficulty-btn').forEach(b => {
              b.classList.remove('bg-pink-100', 'text-pink-700', 'font-semibold');
              b.classList.add('hover:bg-pink-50', 'text-gray-600');
            });
            
            // 激活当前难度按钮
            btn.classList.remove('hover:bg-pink-50', 'text-gray-600');
            btn.classList.add('bg-pink-100', 'text-pink-700', 'font-semibold');
            
            // 渲染对应难度的内容
            renderQuestionDifficultyContent(categoryKey, difficultyKey);
          });
        });
      }
      
      /**
       * 渲染题型欢迎界面 - 简约版
       */
      function renderQuestionTypeWelcome() {
        const contentContainer = document.getElementById('question-types-content');
        if (!contentContainer) return;
        
        contentContainer.innerHTML = `
          <div class="bg-gradient-to-br from-pink-50 via-white to-purple-50 rounded-2xl shadow-lg p-16 text-center border border-pink-100 flex flex-col justify-center min-h-[400px]">
            <div class="text-6xl mb-6 text-gray-300">
              <i class="fas fa-list-alt"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">选择题型分类</h3>
            <p class="text-gray-600 text-lg">点击左侧分类查看该学科不同难度的题型</p>
          </div>
        `;
      }
      
      /**
       * 渲染单个难度的详细内容
       */
      function renderQuestionDifficultyContent(categoryKey, difficultyKey) {
        const contentContainer = document.getElementById('question-types-content');
        if (!contentContainer) return;
        
        const category = QUESTION_TAXONOMY[categoryKey];
        const difficulty = category.difficulties[difficultyKey];
        if (!category || !difficulty) return;
        
        const levelColors = {
          1: { 
            border: 'border-green-200', 
            text: 'text-green-700', 
            bg: 'bg-green-50',
            badge: 'bg-green-100 text-green-700',
            gradient: 'from-green-500 to-green-600'
          },
          2: { 
            border: 'border-yellow-200', 
            text: 'text-yellow-700', 
            bg: 'bg-yellow-50',
            badge: 'bg-yellow-100 text-yellow-700',
            gradient: 'from-yellow-500 to-yellow-600'
          },
          3: { 
            border: 'border-red-200', 
            text: 'text-red-700', 
            bg: 'bg-red-50',
            badge: 'bg-red-100 text-red-700',
            gradient: 'from-red-500 to-red-600'
          }
        };
        const colors = levelColors[difficulty.level] || levelColors[2];
        
        contentContainer.innerHTML = `
          <div class="bg-white rounded-2xl shadow-sm p-8 border border-gray-100">
            <!-- 面包屑导航 -->
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
              <span>${category.icon} ${category.name}</span>
              <i class="fa fa-chevron-right text-xs"></i>
              <span class="${colors.text} font-semibold">${difficulty.name}</span>
            </div>
            
            <!-- 难度标题 -->
            <div class="flex items-center gap-4 mb-8 pb-6 border-b">
              <div class="w-16 h-16 ${colors.bg} rounded-2xl flex items-center justify-center">
                <span class="text-3xl">${category.icon}</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="text-3xl font-bold text-gray-800">${difficulty.name}</h3>
                  <span class="text-sm ${colors.badge} px-3 py-1 rounded-full font-medium">
                    ${'★'.repeat(difficulty.level)}${'☆'.repeat(3 - difficulty.level)} 难度 ${difficulty.level}
                  </span>
                </div>
                <p class="text-gray-600">${difficulty.description}</p>
              </div>
            </div>
            
            <!-- 详细信息 -->
            <div class="space-y-6">
              <!-- 示例题目 -->
              <div class="p-6 ${colors.bg} rounded-xl border ${colors.border}">
                <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fa fa-list-ul ${colors.text}"></i>
                  示例题目
                </h4>
                <div class="grid md:grid-cols-2 gap-3">
                  ${difficulty.examples.map((ex, index) => `
                    <div class="bg-white p-4 rounded-lg border ${colors.border} hover:shadow-md transition-all">
                      <div class="flex items-start gap-3">
                        <span class="${colors.badge} w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">${index + 1}</span>
                        <span class="text-gray-700 text-sm flex-1">${ex}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- 关键词 -->
              <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
                <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fa fa-tags text-gray-600"></i>
                  关键词
                </h4>
                <div class="flex flex-wrap gap-2">
                  ${difficulty.keywords.map(keyword => `
                    <span class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:border-gray-400 transition-colors">
                      ${keyword}
                    </span>
                  `).join('')}
                </div>
              </div>
              
              <!-- 操作按钮 -->
              <div class="flex gap-4">
                <button class="flex-1 bg-gradient-to-r ${colors.gradient} text-white py-4 rounded-xl font-bold hover:shadow-xl transition-all duration-200 text-lg difficulty-use-main-btn"
                        data-category="${categoryKey}" data-difficulty="${difficultyKey}">
                  <i class="fa fa-rocket mr-2"></i>使用此题型生成可视化
                </button>
                <button class="px-6 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-semibold transition-all"
                        onclick="renderQuestionTypeWelcome()">
                  <i class="fa fa-arrow-left mr-2"></i>返回
                </button>
              </div>
            </div>
          </div>
        `;
        
        // 绑定使用按钮事件
        contentContainer.querySelectorAll('.difficulty-use-main-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const categoryKey = btn.dataset.category;
            const difficultyKey = btn.dataset.difficulty;
            
            const category = QUESTION_TAXONOMY[categoryKey];
            const difficulty = category.difficulties[difficultyKey];
            const descriptionField = document.getElementById('problem-description');
            
            if (descriptionField) {
              const exampleText = `【${category.name} - ${difficulty.name}】\n示例题目:\n${difficulty.examples[0]}\n\n关键词: ${difficulty.keywords.join('、')}`;
              descriptionField.value = exampleText;
              
              // 滚动到可视化区域
              const vizSection = document.getElementById('visualization');
              if (vizSection) {
                vizSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          });
        });
      }
      
      /**
       * 渲染单个分类的题型内容 - 简约版
       */
      function renderQuestionTypeContent(categoryKey) {
        const contentContainer = document.getElementById('question-types-content');
        if (!contentContainer) return;
        
        const category = QUESTION_TAXONOMY[categoryKey];
        if (!category) return;
        
        contentContainer.innerHTML = `
          <div class="bg-white rounded-2xl shadow-sm p-8 border border-gray-100">
            <!-- 分类标题 - 简约版 -->
            <div class="flex items-center gap-4 mb-8 pb-6 border-b">
              <span class="text-4xl">${category.icon}</span>
              <div>
                <h3 class="text-2xl font-bold text-gray-800">${category.name}</h3>
                <p class="text-gray-500 text-sm mt-1">${Object.keys(category.difficulties).length} 个难度等级</p>
              </div>
            </div>
            
            <!-- 难度列表 - 简约版 -->
            <div class="space-y-4">
              ${Object.entries(category.difficulties).map(([diffKey, diff]) => {
                const levelColors = {
                  1: { 
                    border: 'border-green-200', 
                    text: 'text-green-700', 
                    bg: 'bg-green-50',
                    badge: 'bg-green-100 text-green-700'
                  },
                  2: { 
                    border: 'border-yellow-200', 
                    text: 'text-yellow-700', 
                    bg: 'bg-yellow-50',
                    badge: 'bg-yellow-100 text-yellow-700'
                  },
                  3: { 
                    border: 'border-red-200', 
                    text: 'text-red-700', 
                    bg: 'bg-red-50',
                    badge: 'bg-red-100 text-red-700'
                  }
                };
                const colors = levelColors[diff.level] || levelColors[2];
                
                return `
                  <div class="p-6 rounded-xl border ${colors.border} hover:shadow-md transition-all duration-200 group">
                    <div class="flex items-center justify-between mb-4">
                      <h4 class="text-lg font-bold text-gray-800">${diff.name}</h4>
                      <span class="text-xs ${colors.badge} px-3 py-1 rounded-full font-medium">
                        ${'★'.repeat(diff.level)}${'☆'.repeat(3 - diff.level)}
                      </span>
                    </div>
                    
                    <p class="text-gray-600 mb-4 text-sm">${diff.description}</p>
                    
                    <div class="mb-4">
                      <div class="text-xs font-semibold text-gray-500 mb-2">示例题目</div>
                      <div class="flex flex-wrap gap-2">
                        ${diff.examples.slice(0, 3).map(ex => `
                          <span class="text-xs ${colors.bg} ${colors.text} px-3 py-1.5 rounded-lg border ${colors.border}">${ex}</span>
                        `).join('')}
                      </div>
                    </div>
                    
                    <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2.5 rounded-lg font-medium hover:shadow-lg transition-all duration-200 text-sm difficulty-use-btn"
                            data-category="${categoryKey}" data-difficulty="${diffKey}">
                      <i class="fas fa-arrow-right mr-2"></i>使用此题型
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
        
        // 绑定使用按钮事件
        contentContainer.querySelectorAll('.difficulty-use-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const categoryKey = btn.dataset.category;
            const difficultyKey = btn.dataset.difficulty;
            
            const category = QUESTION_TAXONOMY[categoryKey];
            const difficulty = category.difficulties[difficultyKey];
            const descriptionField = document.getElementById('problem-description');
            
            if (descriptionField) {
              const exampleText = `【${category.name} - ${difficulty.name}】\n示例题目:\n${difficulty.examples[0]}\n\n关键词: ${difficulty.keywords.join('、')}`;
              descriptionField.value = exampleText;
              
              // 滚动到可视化区域
              const vizSection = document.getElementById('visualization');
              if (vizSection) {
                vizSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          });
        });
      }
      
      /**
       * 初始化题型筛选按钮(已废弃,改用左右布局)
       */
      function initQuestionTypeFilters() {
        // 不再需要,题型已改为左右布局
      }
      
      /**
       * 在界面上显示识别到的知识点标签
       */
      function displayKnowledgeTags(knowledgeIds) {
        // 查找或创建知识点标签容器
        let tagsContainer = document.getElementById('knowledge-tags-container');
        
        if (!tagsContainer) {
          // 在参数设置区域下方创建标签容器
          const dynamicParams = document.getElementById('dynamic-params');
          if (dynamicParams && dynamicParams.parentElement) {
            tagsContainer = document.createElement('div');
            tagsContainer.id = 'knowledge-tags-container';
            tagsContainer.className = 'mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200';
            dynamicParams.parentElement.insertBefore(tagsContainer, dynamicParams.nextSibling);
          } else {
            return; // 找不到插入位置
          }
        }
        
        // 清空旧标签
        tagsContainer.innerHTML = '';
        
        if (knowledgeIds.length === 0) {
          tagsContainer.classList.add('hidden');
          return;
        }
        
        tagsContainer.classList.remove('hidden');
        
        // 添加标题
        const title = document.createElement('div');
        title.className = 'text-xs font-medium text-blue-700 mb-2 flex items-center gap-1';
        title.innerHTML = '<i class="fa fa-bookmark"></i> 涉及知识点';
        tagsContainer.appendChild(title);
        
        // 添加标签
        const tagsWrapper = document.createElement('div');
        tagsWrapper.className = 'flex flex-wrap gap-2';
        
        for (const id of knowledgeIds) {
          const kp = getKnowledgePoint(id);
          if (kp) {
            const tag = document.createElement('span');
            tag.className = 'inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium cursor-pointer transition-colors';
            tag.style.backgroundColor = kp.categoryColor + '20';
            tag.style.color = kp.categoryColor;
            tag.innerHTML = `${kp.categoryIcon} ${kp.name}`;
            tag.title = `点击查看${kp.name}详情`;
            
            // 点击标签跳转到知识点详情
            tag.addEventListener('click', () => {
              const knowledgeSection = document.getElementById('knowledge');
              if (knowledgeSection) {
                knowledgeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // 可以进一步高亮对应的知识点卡片
              }
            });
            
            tagsWrapper.appendChild(tag);
          }
        }
        
        tagsContainer.appendChild(tagsWrapper);
      }
      
      // 初始化知识点库和题型分类
      console.log('📚 初始化知识点库和题型分类...');
      renderKnowledgeCategories();
      initQuestionTypeFilters();
      renderQuestionTypes();
      console.log('✅ 知识点库和题型分类初始化完成');
      
      // ========== AI 智能解析功能 ==========
      
      /**
       * 本地简单解析（不依赖后端）
       * @param {string} text - 题目描述文本
       * @returns {Object} 解析结果
       */
      function parseLocalFallback(text) {
        const t = text.toLowerCase();
        
        // 检测抛体运动
        if (t.includes('抛') || t.includes('角度') || t.includes('°') || t.includes('度')) {
          return {
            success: true,
            type: 'projectile',
            params: { speed: 10, angle: 45, height: 0 },
            reasoning: '检测到抛体运动关键词（本地解析模式）'
          };
        }
        
        // 检测圆周运动
        if (t.includes('圆周') || t.includes('角速度') || t.includes('转动')) {
          return {
            success: true,
            type: 'circular',
            params: { radius: 2, angular: 1 },
            reasoning: '检测到圆周运动关键词（本地解析模式）'
          };
        }
        
        // 检测碰撞
        if (t.includes('碰撞') || t.includes('相撞')) {
          return {
            success: true,
            type: 'collision',
            params: { m1: 1, v1: 2, m2: 1, v2: -1 },
            reasoning: '检测到碰撞关键词（本地解析模式）'
          };
        }
        
        // 默认：自由落体/匀变速
        return {
          success: true,
          type: 'uniform',
          params: { v0: 0, a: 10, time: 5 },
          reasoning: '默认为自由落体运动（本地解析模式）'
        };
      }
      
      // ============================================================================
      // 🧠 7. AI题目解析模块 - 调用后端DeepSeek API
      // ============================================================================
      
      /**
       * 使用AI解析自然语言物理题目
       * 
       * 工作流程：
       * 1. 将题目文本发送到 Cloudflare Worker 后端
       * 2. 后端调用 DeepSeek API 进行语义理解
       * 3. 返回结构化的物理参数 {type, params, reasoning, sceneDescription}
       * 4. 如果AI失败，自动降级到本地正则表达式解析
       * 
       * 后端地址：
       * - 生产环境: https://physics-visual-worker.yywf08125.workers.dev/api/parse-problem
       * - 本地测试: http://localhost:8787/api/parse-problem
       * 
       * 返回格式示例：
       * {
       *   success: true,
       *   type: "uniform",           // 题型：uniform/projectile/circular/collision
       *   params: {                  // 物理参数
       *     v0: 0,                   // 初速度
       *     a: 2,                    // 加速度
       *     time: 3                  // 时间
       *   },
       *   reasoning: "匀加速直线运动，由静止开始(v0=0)，加速度2m/s²，时间3s",
       *   sceneDescription: {        // AI生成的场景描述（可选）
       *     objects: ["汽车"],
       *     initialConditions: "静止并开始运动",
       *     environment: "笔直公路"
       *   }
       * }
       * 
       * @param {string} text - 题目文本（自然语言）
       * @returns {Promise<Object>} 解析结果对象
       */
      async function parseDescriptionWithAI(text) {
        try {
          // 创建一个带超时的 fetch (30秒超时)
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000);
          
          const response = await fetch(BACKEND_PATH, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ description: text }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`后端返回错误: ${response.status}`);
          }
          
          const result = await response.json();
          return result;
        } catch (error) {
          console.error('AI 解析失败，尝试本地解析:', error);
          
          // 网络失败时自动使用本地解析
          console.log('使用本地 fallback 解析模式');
          return parseLocalFallback(text);
        }
      }
      
      // ============================================================================
      // 📝 参数填充模块 - 将AI解析结果填入表单
      // ============================================================================
      
      /**
       * 将AI解析的参数填充到表单输入框
       * 
       * 功能说明：
       * 1. 自动切换题型下拉框（如果AI识别的题型与当前不同）
       * 2. 调用 populateParamsForType() 重新生成对应题型的输入框
       * 3. 将AI返回的参数值填入各个输入框
       * 4. 处理参数名称的多种变体（如 v0/initialVelocity/speed 都映射到初速度）
       * 
       * 参数映射规则：
       * - 匀变速运动: v0(初速度), a(加速度), time(时间), direction(方向)
       * - 抛体运动: speed(初速度), angle(角度), height(高度)
       * - 圆周运动: radius(半径), angular(角速度)
       * - 碰撞运动: m1/v1/m2/v2(质量和速度)
       * - 磁场运动: q(电荷), v(速度), B(磁场强度)
       * 
       * @param {string} type - 题型类型（uniform/projectile/circular/collision/magnetic/astrodynamics）
       * @param {Object} params - AI返回的参数对象
       */
      function fillFormFromAI(type, params) {
        // 1. 切换题型下拉框
        if (questionTypeSelect.value !== type) {
          questionTypeSelect.value = type;
          populateParamsForType(type);  // 重新生成动态参数字段
        }
        
        // 2. 填充通用参数
        const setInput = (id, value) => {
          const el = document.getElementById(id);
          if (el && value !== undefined && value !== null) {
            el.value = value;
          }
        };
        
        // 匀变速相关
        setInput('input-initial-velocity', params.v0);
        setInput('input-acceleration', params.a);
        setInput('input-time', params.time);
        setInput('input-mass', params.mass);
        
        // 抛体运动
        setInput('input-speed', params.speed);
        setInput('input-angle', params.angle);
        setInput('input-height', params.height);
        
        // 圆周运动
        setInput('input-radius', params.radius);
        setInput('input-angular', params.angular || params.omega);
        
        // 碰撞
        setInput('input-m1', params.m1);
        setInput('input-v1', params.v1);
        setInput('input-m2', params.m2);
        setInput('input-v2', params.v2);
        
        // 磁场
        setInput('input-charge', params.q || params.charge);
        setInput('input-vel', params.v || params.velocity);
        setInput('input-field', params.B || params.field);
        
        // 天体运动
        setInput('input-mass-central', params.M || params.centralMass);
        setInput('input-radius-orbit', params.r || params.orbitRadius);
        
        // 重力加速度特殊处理
        if (params.g !== undefined) {
          window.GRAVITY_OVERRIDE = params.g;
        }
      }
      
      // 辅助函数：显示通知（用于智能解析）
      function showNotice(message, type = 'info', duration = 2000) {
        const colors = {
          success: 'bg-green-500',
          error: 'bg-red-500',
          warning: 'bg-yellow-500',
          info: 'bg-blue-500'
        };
        
        const notice = document.createElement('div');
        notice.className = `fixed top-20 right-4 ${colors[type]} text-white px-4 py-3 rounded-md shadow-lg z-50 max-w-sm`;
        notice.style.whiteSpace = 'pre-line';  // 支持换行
        notice.textContent = message;
        document.body.appendChild(notice);
        
        if (duration > 0) {
          setTimeout(() => notice.remove(), duration);
        }
        
        return notice;  // 返回元素以便手动移除
      }
      
      // 辅助函数：题型中文名映射
      function getTypeNameZh(type) {
        const names = {
          'uniform': '匀变速直线运动',
          'projectile': '平抛/抛体运动',
          'circular': '圆周运动',
          'collision': '碰撞与动量守恒',
          'magnetic': '带电粒子在磁场中的运动',
          'astrodynamics': '天体运动'
        };
        return names[type] || type;
      }
      
      // 可视化提示/智能解析按钮事件监听（优先使用左侧可视化提示词模块）
      function applyVisualPrompt() {
        const vp = document.getElementById('visual-prompt');
        const theme = document.getElementById('visual-theme')?.value || 'cartoon';
        const detail = document.getElementById('visual-detail')?.value || 'medium';
        const highlightApex = !!document.getElementById('visual-highlight-apex')?.checked;
        const showVelocity = !!document.getElementById('visual-show-velocity')?.checked;
        const useTrail = !!document.getElementById('visual-use-trail')?.checked;

        const text = (vp && vp.value) ? vp.value.trim() : '';
        if (!text) return null;

        // 简单启发式：根据提示词决定题型并填充默认参数（最小可用实现）
        const t = text.toLowerCase();
        let guessed = { success: true, type: 'uniform', params: {} };
        if (t.includes('抛') || t.includes('角度') || t.includes('°') || t.includes('度')) {
          guessed.type = 'projectile';
          guessed.params = { speed: 10, angle: 45, height: 0 };
        } else if (t.includes('圆周') || t.includes('角速度') || t.includes('转动')) {
          guessed.type = 'circular';
          guessed.params = { radius: 2, angular: 1 };
        } else if (t.includes('碰撞') || t.includes('相撞')) {
          guessed.type = 'collision';
          guessed.params = { m1: 1, v1: 2, m2: 1, v2: -1 };
        } else if (t.includes('磁') || t.includes('洛伦兹')) {
          guessed.type = 'magnetic';
          guessed.params = { q: 1e-6, v: 100, B: 0.1 };
        } else {
          guessed.type = 'uniform';
          guessed.params = { v0: 0, a: 10, time: 5 };
        }

        // 将猜测填入表单
        fillFormFromAI(guessed.type, guessed.params);

        // 应用可视化设置到 sceneParams（生成场景时会合并这些设置）
        sceneVisualSettings = { theme, detail, highlightApex, showVelocity, useTrail, prompt: text };

        return { type: guessed.type, params: guessed.params, visual: sceneVisualSettings };
      }

      parseButton?.addEventListener('click', async () => {
        // 优先读取左侧可视化提示词
        const vpEl = document.getElementById('visual-prompt');
        const vpText = vpEl ? vpEl.value.trim() : '';

        if (vpText) {
          // 使用本地启发式解析并应用视觉设置
          const applied = applyVisualPrompt();
          showNotice(`✓ 已根据提示词应用可视化设置（风格: ${applied.visual.theme}, 细节: ${applied.visual.detail}）`, 'success', 2500);
          return;
        }

        // 否则回退到原先的AI解析（对 problem-description 字段）
        const text = descriptionEl.value || '';
        if (!text.trim()) {
          showNotice('请先输入题目描述或在左侧填写可视化提示词', 'warning');
          return;
        }

        // 显示加载提示
        parseButton.disabled = true;
        parseButton.textContent = '正在解析...';
        let loadingNotice = showNotice('AI 正在理解题目，请稍候...', 'info', 0);

        try {
          const result = await parseDescriptionWithAI(text);
          if (result.success) {
            fillFormFromAI(result.type, result.params);
            
            // 🆕 保存视觉参数到全局变量（供生成按钮使用）
            if (result.visual) {
              window.sceneVisualSettings = result.visual;
              console.log('🎨 AI返回的视觉参数:', result.visual);
            }
            
            // 🆕 识别相关知识点
            const knowledgePoints = detectKnowledgePoints(text);
            console.log('📚 检测到的知识点:', knowledgePoints);
            
            // 显示知识点标签
            displayKnowledgeTags(knowledgePoints);
            
            if (loadingNotice && loadingNotice.remove) loadingNotice.remove();
            
            // 组合消息：题型 + 知识点 + 视觉风格
            let message = `✓ 已识别为【${getTypeNameZh(result.type)}】`;
            if (result.visual && result.visual.theme) {
              message += ` - ${result.visual.theme}风格`;
            }
            if (knowledgePoints.length > 0) {
              const knowledgeNames = knowledgePoints.map(id => {
                const kp = getKnowledgePoint(id);
                return kp ? kp.name : id;
              }).join('、');
              message += `\n📚 涉及知识点：${knowledgeNames}`;
            }
            if (result.reasoning) {
              message += `\n${result.reasoning}`;
            }
            
            showNotice(message, 'success', 4000);
          } else {
            throw new Error(result.error || '解析失败');
          }
        } catch (error) {
          if (loadingNotice && loadingNotice.remove) loadingNotice.remove();
          console.error('解析错误:', error);
          const isLocal = (typeof BACKEND_PATH === 'string') && /localhost|127\.0\.0\.1/.test(BACKEND_PATH);
          let errorMsg;
          if (isLocal && error.message && error.message.toLowerCase().includes('fetch')) {
            errorMsg = '⚠️ 无法连接到本地后端。\n请在项目目录启动本地服务器：\ncd backend ; python server.py\n或在界面中手动填写参数（若您没有本地后端）。';
          } else if (!isLocal && error.message && error.message.toLowerCase().includes('fetch')) {
            errorMsg = `⚠️ 无法连接到解析后端（网络或浏览器扩展可能阻止请求）。\n请检查网络、浏览器扩展（尝试无痕/禁用扩展）或确保后端可达：\n${BACKEND_PATH}`;
          } else {
            errorMsg = `解析失败: ${error.message}`;
          }
          showNotice(errorMsg, 'error', 7000);
        } finally {
          parseButton.disabled = false;
          parseButton.textContent = '应用提示';
          if (loadingNotice && loadingNotice.remove) {
            try { loadingNotice.remove(); } catch(e) {}
          }
        }
      });
      
      // ========== 导入菜单功能 ==========
      const importMenuBtn = document.getElementById('import-menu-btn');
      const importMenu = document.getElementById('import-menu');
      const uploadImageBtn = document.getElementById('upload-image-btn');
      const uploadDocxBtn = document.getElementById('upload-docx-btn');
      const uploadImageInput = document.getElementById('upload-image');
      const uploadDocxInput = document.getElementById('upload-docx');
      const imageUploadArea = document.getElementById('image-upload-area');
      const ocrResult = document.getElementById('ocr-result');
      const removeImageBtn = document.getElementById('remove-image');
      const applyOcrBtn = document.getElementById('apply-ocr');
      
      let currentOcrText = '';
      
      // 切换导入菜单
      importMenuBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        importMenu.classList.toggle('hidden');
      });
      
      // 点击其他地方关闭菜单
      document.addEventListener('click', () => {
        importMenu?.classList.add('hidden');
      });
      
      importMenu?.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      // 触发图片上传
      uploadImageBtn?.addEventListener('click', () => {
        uploadImageInput?.click();
        importMenu?.classList.add('hidden');
      });
      
      // 触发Word上传
      uploadDocxBtn?.addEventListener('click', () => {
        uploadDocxInput?.click();
        importMenu?.classList.add('hidden');
      });
      
      // 处理图片上传（使用Tesseract.js OCR）
      uploadImageInput?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // 显示上传区域
        imageUploadArea.classList.remove('hidden');
        ocrResult.innerHTML = '<div class="text-blue-600"><i class="fa fa-spinner fa-spin mr-2"></i>正在识别图片中的文字...</div><div class="text-sm text-gray-500 mt-2">⏱️ 图片识别用时约2分钟，请耐心等待</div>';
        
        // 显示提示通知
        showNotification('📸 开始识别图片，预计需要2分钟...', 'info', 3000);
        
        // 检查是否已加载Tesseract
        if (typeof Tesseract === 'undefined') {
          // 动态加载Tesseract.js
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
          script.onload = () => performOCR(file);
          script.onerror = () => {
            ocrResult.innerHTML = '<div class="text-red-600">OCR库加载失败，请检查网络连接</div>';
          };
          document.head.appendChild(script);
        } else {
          performOCR(file);
        }
      });
      
      // 执行OCR识别
      async function performOCR(file) {
        try {
          const reader = new FileReader();
          reader.onload = async (event) => {
            const imageData = event.target.result;
            
            ocrResult.innerHTML = '<div class="text-blue-600"><i class="fa fa-spinner fa-spin mr-2"></i>正在识别... (0%)</div><div class="text-sm text-gray-500 mt-2">⏱️ 预计还需约2分钟</div>';
            
            const worker = await Tesseract.createWorker('chi_sim+eng', 1, {
              logger: (m) => {
                if (m.status === 'recognizing text') {
                  const progress = Math.round(m.progress * 100);
                  const remainingTime = progress < 50 ? '约1-2分钟' : '不到1分钟';
                  ocrResult.innerHTML = `<div class="text-blue-600"><i class="fa fa-spinner fa-spin mr-2"></i>正在识别... (${progress}%)</div><div class="text-sm text-gray-500 mt-2">⏱️ 预计还需${remainingTime}</div>`;
                }
              }
            });
            
            const { data: { text } } = await worker.recognize(imageData);
            await worker.terminate();
            
            currentOcrText = text;
            ocrResult.innerHTML = `<div class="text-gray-800">${text || '未识别到文字内容'}</div>`;
            
            showNotification('✓ 图片识别完成', 'success', 2000);
          };
          reader.readAsDataURL(file);
        } catch (error) {
          console.error('OCR识别失败:', error);
          ocrResult.innerHTML = `<div class="text-red-600">OCR识别失败: ${error.message}</div>`;
          showNotification('图片识别失败', 'error', 2000);
        }
      }
      
      // 删除图片
      removeImageBtn?.addEventListener('click', () => {
        imageUploadArea.classList.add('hidden');
        uploadImageInput.value = '';
        currentOcrText = '';
        ocrResult.textContent = '';
      });
      
      // 应用OCR结果
      applyOcrBtn?.addEventListener('click', () => {
        if (currentOcrText) {
          const descriptionEl = document.getElementById('problem-description');
          if (descriptionEl) {
            descriptionEl.value = currentOcrText;
            showNotification('✓ 已填充识别内容', 'success', 2000);
          }
        }
      });
      
      // ========== Word 文档上传功能 ==========
      // 使用 Mammoth.js 提取 .docx 文档中的纯文本
      uploadDocxInput?.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        try {
          showNotification('📄 正在读取 Word 文档...', 'info', 2000);
          
          // 检查是否已加载 Mammoth.js
          if (typeof mammoth === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js';
            script.onload = async () => {
              await processDocxFile(file);
            };
            script.onerror = () => {
              showNotification('Word 文档解析库加载失败', 'error', 2000);
            };
            document.head.appendChild(script);
          } else {
            await processDocxFile(file);
          }
        } catch (error) {
          console.error('Word 文档处理失败:', error);
          showNotification('Word 文档处理失败', 'error', 2000);
        }
      });
      
      // 处理 Word 文档
      async function processDocxFile(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
          const text = result.value || '';
          
          const descriptionEl = document.getElementById('problem-description');
          if (descriptionEl) {
            descriptionEl.value = text.trim();
            showNotification('✓ 已从 Word 文档提取文本', 'success', 2000);
          }
        } catch (error) {
          console.error('Word 文档解析失败:', error);
          showNotification('解析 Word 文档失败（仅支持 .docx）', 'error', 2000);
        }
      }
      
        // 重置左侧可视化提示词按钮
        const resetVisualBtn = document.getElementById('reset-visual-prompt');
        resetVisualBtn?.addEventListener('click', () => {
          const vp = document.getElementById('visual-prompt'); if (vp) vp.value = '';
          const theme = document.getElementById('visual-theme'); if (theme) theme.value = 'cartoon';
          const detail = document.getElementById('visual-detail'); if (detail) detail.value = 'medium';
          const ha = document.getElementById('visual-highlight-apex'); if (ha) ha.checked = false;
          const sv = document.getElementById('visual-show-velocity'); if (sv) sv.checked = true;
          const ut = document.getElementById('visual-use-trail'); if (ut) ut.checked = true;
          sceneVisualSettings = {};
          showNotification('✓ 已清除可视化提示词设置', 'success', 1600);
        });

        // 功能卡片点击：平滑滚动到对应板块（并避开顶部 sticky header），同时高亮目标区域
        const featureCards = document.querySelectorAll('.feature-card');
        featureCards.forEach(card => {
          const target = card.dataset.target;
          if (!target) return;
          card.addEventListener('click', () => {
            const dest = document.querySelector(target);
            if (!dest) return;

            // 计算顶部偏移（考虑 sticky header）
            const headerEl = document.getElementById('navbar');
            const headerHeight = headerEl ? headerEl.getBoundingClientRect().height : 0;
            const rect = dest.getBoundingClientRect();
            const top = rect.top + window.scrollY - headerHeight - 12; // 12px 额外间隔

            window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });

            // 可访问性：设焦点以便使用键盘的用户获取上下文
            try { dest.setAttribute('tabindex', '-1'); dest.focus(); } catch(e){}

            // 高亮目标区域一段时间以增强视觉反馈
            dest.classList.add('feature-target-highlight');
            setTimeout(() => {
              dest.classList.remove('feature-target-highlight');
            }, 1600);
          });

          // 支持回车/空格触发
          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
          });
        });

        // ========== 生成按钮事件 ==========
      if (generateButton) {
        generateButton.addEventListener('click', () => {
          // Get form parameters
          const params = getParams();
          console.log('🎬 生成Canvas场景:', params);
          
          // Set global scene parameters for rendering
          sceneParams = params;
          // 合并可视化提示词设置（如果存在）
          sceneParams.visual = Object.assign({}, sceneVisualSettings || {});
          
          // 清除之前的反弹状态
          delete sceneParams.bounceCount;
          delete sceneParams.lastBounceTime;
          delete sceneParams.bounceVy;
          delete sceneParams.bounceTime;
          delete sceneParams.bounces;
          delete sceneParams.projectileBounces;
          delete sceneParams.currentBounceIndex;
          
          // Initialize canvas if needed
          if (!canvas) initCanvas();
          
          // Reset time and redraw scene
          currentTime = 0;
          isPlaying = false;
          drawScene();
          
          // Update UI
          playBtn?.classList.remove('hidden');
          pauseBtn?.classList.add('hidden');
          
          // Show notification
          const notification = document.createElement('div');
          notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
          notification.textContent = '✓ 场景已生成,点击"播放"开始演示';
          document.body.appendChild(notification);
          setTimeout(() => { notification.remove(); }, 2000);
          
          // Highlight play button briefly
          playBtn?.classList.add('animate-pulse');
          setTimeout(() => playBtn?.classList.remove('animate-pulse'), 2000);
        });
      }
      
      // 延迟100ms确保所有元素都已渲染
      setTimeout(() => {
        initCanvas();
        initControlButtons();
        initFullscreenButton();
        initExportButtons();
        console.log('✅ 所有功能初始化完成');
      }, 100);
    });
  </script>

  <!-- AI助手 -->
  <script src="ai-assistant.js"></script>
  <script>
    // 初始化AI助手
    const DEEPSEEK_API_KEY = 'sk-0100cbe054c9466e94776583ea2967d7'; // 👈 您的 DeepSeek API Key
    
    if (DEEPSEEK_API_KEY && DEEPSEEK_API_KEY !== 'YOUR_API_KEY_HERE') {
      const { assistant, ui } = initAIAssistant(DEEPSEEK_API_KEY, {
        systemPrompt: `你是一个专业的物理学习助手，名叫"物理小助手"。

【核心能力】
- 解答高中物理问题(力学、电磁学、光学、热学、原子物理等)
- 讲解物理概念和定律
- 分析物理题目,给出详细解题步骤
- 用可视化方式帮助理解

【回答要求】
1. 简洁明了,通俗易懂
2. 对于计算题,必须给出详细步骤
3. 使用LaTeX公式: 行内公式用 $...$, 块级公式用 $$...$$
4. 使用Markdown格式: 标题用##, 列表用-, 代码用\`\`\`
5. 适当使用emoji让回答生动有趣

【公式示例】
- 牛顿第二定律: $F = ma$
- 动能公式: $$E_k = \\frac{1}{2}mv^2$$
- 位移公式: $s = v_0t + \\frac{1}{2}at^2$`,
        avatarImage: '🧪',
        assistantName: '物理小助手',
        placeholder: '问我物理问题，比如：解释一下牛顿第二定律'
      });
      console.log('✅ AI助手已启动 (支持Markdown & LaTeX)');
    } else {
      console.warn('⚠️ 请在代码中配置 DeepSeek API Key 以启用AI助手');
    }
  </script>
  
  <!-- 学习行为追踪与报告系统 v2.0 -->
  <script src="learning-analytics-v2.js"></script>
  <script src="learning-report-v2.js"></script>
  <script>
    // ==================== 初始化演示数据 ====================
    // 如果是首次访问且没有数据，生成丰富的演示数据
    if (window.learningAnalytics && !localStorage.getItem('learningAnalyticsV2')) {
      console.log('🎯 首次访问，生成专业演示数据...');
      
      // 模拟浏览多个知识点（带分类和难度）
      const knowledgePoints = [
        { id: 'uniform-1', name: '匀变速直线运动', category: '力学', difficulty: 'easy' },
        { id: 'projectile-1', name: '抛体运动', category: '力学', difficulty: 'medium' },
        { id: 'circular-1', name: '圆周运动', category: '力学', difficulty: 'hard' },
        { id: 'electric-1', name: '电场强度', category: '电磁学', difficulty: 'medium' },
        { id: 'magnetic-1', name: '磁场与安培力', category: '电磁学', difficulty: 'hard' },
        { id: 'optics-1', name: '光的折射', category: '光学', difficulty: 'easy' },
        { id: 'wave-1', name: '波的干涉', category: '光学', difficulty: 'medium' }
      ];
      
      knowledgePoints.forEach((kp, index) => {
        setTimeout(() => {
          window.learningAnalytics.startActivity('knowledge', kp);
          setTimeout(() => {
            window.learningAnalytics.endActivity();
          }, 2000 + Math.random() * 3000); // 随机学习时长 2-5秒
        }, index * 1500);
      });
      
      // 模拟生成多个可视化（带参数）
      const visualizations = [
        { type: 'uniform', params: { speed: 5, gravity: 10 }, played: true },
        { type: 'projectile', params: { angle: 45, speed: 20 }, played: true },
        { type: 'circular', params: { radius: 50, period: 3 }, played: false },
        { type: 'collision', params: { mass1: 2, mass2: 3 }, played: true }
      ];
      
      setTimeout(() => {
        visualizations.forEach((viz, index) => {
          setTimeout(() => {
            window.learningAnalytics.startActivity('visualization', viz);
            setTimeout(() => {
              window.learningAnalytics.endActivity();
            }, 1500 + Math.random() * 2000);
          }, index * 2000);
        });
        
        setTimeout(() => {
          console.log('✅ 专业演示数据生成完成！已包含 7 个知识点和 4 个可视化。');
        }, visualizations.length * 2000 + 3000);
      }, knowledgePoints.length * 1500 + 2000);
    }
    
    // ==================== 绑定报告下拉菜单 ====================
    const dropdownBtn = document.getElementById('report-dropdown-btn');
    const dropdownMenu = document.getElementById('report-dropdown-menu');
    const dropdownContainer = document.querySelector('.report-dropdown-container');
    
    // 切换下拉菜单
    dropdownBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle('hidden');
      dropdownContainer.classList.toggle('active');
    });
    
    // 点击外部关闭下拉菜单
    document.addEventListener('click', (e) => {
      if (!dropdownContainer?.contains(e.target)) {
        dropdownMenu?.classList.add('hidden');
        dropdownContainer?.classList.remove('active');
      }
    });
    
    // 学生报告按钮
    document.getElementById('show-student-report')?.addEventListener('click', () => {
      if (window.reportUI && window.learningAnalytics) {
        window.reportUI.showStudentReport(window.learningAnalytics);
        console.log('📊 学生学习报告已打开');
        dropdownMenu.classList.add('hidden');
        dropdownContainer.classList.remove('active');
      } else {
        console.error('❌ 报告系统未初始化');
      }
    });
    
    // 教师报告按钮
    document.getElementById('show-teacher-report')?.addEventListener('click', () => {
      if (window.reportUI && window.learningAnalytics) {
        window.reportUI.showTeacherReport(window.learningAnalytics);
        console.log('📊 教师精准备课指导已打开');
        dropdownMenu.classList.add('hidden');
        dropdownContainer.classList.remove('active');
      } else {
        console.error('❌ 报告系统未初始化');
      }
    });
    
    // ==================== 集成追踪到现有功能 ====================
    // 监听知识点点击
    document.addEventListener('click', (e) => {
      const knowledgeCard = e.target.closest('[data-knowledge-id]');
      if (knowledgeCard && window.learningAnalytics) {
        const knowledgeId = knowledgeCard.dataset.knowledgeId;
        const knowledgeName = knowledgeCard.dataset.knowledgeName;
        const category = knowledgeCard.dataset.category || '物理';
        const difficulty = knowledgeCard.dataset.difficulty || 'medium';
        
        window.learningAnalytics.startActivity('knowledge', {
          id: knowledgeId,
          name: knowledgeName,
          category: category,
          difficulty: difficulty
        });
      }
    });
    
    // 监听可视化生成
    const originalGenerateBtn = document.getElementById('generate-animation');
    if (originalGenerateBtn) {
      originalGenerateBtn.addEventListener('click', () => {
        const questionType = document.getElementById('question-type-select')?.value || 'uniform';
        if (window.learningAnalytics) {
          window.learningAnalytics.startActivity('visualization', {
            type: questionType,
            params: window.currentParams || {},
            played: false
          });
        }
      });
    }
    
    // 监听动画播放
    const playButton = document.getElementById('play-animation');
    if (playButton) {
      playButton.addEventListener('click', () => {
        if (window.learningAnalytics && window.learningAnalytics.currentActivity) {
          // 标记可视化已播放
          console.log('▶️ 动画开始播放');
        }
      });
    }
    
    console.log('✅ 学习报告系统 v2.0 已启动 (增强分析引擎 + 专业图表)');
  </script>
</body>
</html>
