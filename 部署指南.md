# Physics Visual 部署指南

## 📋 概述

本指南将帮助你将本地调整好的代码推送到 GitHub 并部署到 Cloudflare。

---

## ✅ 本地已完成的调整

### 1. 修复了前后端数据格式不匹配问题
- **问题**：Worker 返回 `{ok: true, raw: ..., parsed: {...}}`，但前端期望 `{success: true, type: ..., params: ..., reasoning: ...}`
- **解决**：修改了 `backend/worker/index.js`，现在返回前端期望的格式

### 2. 改进了错误提示
- **功能**：当解析失败时，根据后端配置（本地 vs 云端）显示不同的错误提示
- **位置**：`index1.0.3.html` 和 `dist/index.html`

### 3. 准备好了部署文件
- `dist/index.html` - 已更新为最新版本，包含所有修复
- `backend/worker/index.js` - 已修复数据格式问题
- `backend/worker/wrangler.toml` - Worker 配置文件

---

## 🚀 部署步骤

### 步骤 1: 提交到 Git 并推送到 GitHub

```powershell
# 1. 检查当前状态
git status

# 2. 添加所有修改的文件
git add .

# 3. 提交更改（使用有意义的提交信息）
git commit -m "修复前后端数据格式不匹配问题，改进错误提示"

# 4. 推送到 GitHub
git push origin master
```

---

### 步骤 2: 部署 Cloudflare Worker（后端）

```powershell
# 1. 进入 Worker 目录
cd backend\worker

# 2. 部署 Worker
wrangler deploy

# 3. 验证部署（应该看到新的 Version ID）
# 预期输出类似：
# ✔ Deployed physics-visual-worker triggers (1.23 sec)
#   https://physics-visual-worker.yywf08125.workers.dev
```

**重要提示**：
- 确保你的 OpenAI API Key 已经设置（如果之前没设置或需要更新）：
  ```powershell
  wrangler secret put OPENAI_API_KEY
  # 然后输入你的 API key
  ```
- 如果想保留 mock 模式用于测试：
  ```powershell
  wrangler secret put MOCK_RESPONSE
  # 输入 "true"
  ```

---

### 步骤 3: 部署到 Cloudflare Pages（前端）

```powershell
# 1. 回到项目根目录
cd ..\..

# 2. 部署到 Pages
wrangler pages deploy .\dist --project-name=physics-visual

# 3. 等待部署完成
# 预期输出：
# ✔ Success! Uploaded 1 files
# ✔ Deployment complete!
#   Preview URL: https://xxxxxxxx.physics-visual.pages.dev
#   Production URL: https://physics-visual.pages.dev
```

---

### 步骤 4: 验证部署

#### 4.1 测试 Worker
```powershell
# 使用 PowerShell 测试 Worker API
Invoke-RestMethod -Uri "https://physics-visual-worker.yywf08125.workers.dev/api/parse-problem" -Method POST -Headers @{"Content-Type"="application/json"} -Body '{"description":"一个物体从静止开始自由下落5秒"}' | ConvertTo-Json -Depth 10
```

**预期输出**：
```json
{
    "success": true,
    "type": "uniform",
    "params": {
        "v0": 0,
        "a": 10,
        "time": 5
    },
    "reasoning": "默认为自由落体（匀变速直线运动）。"
}
```

#### 4.2 测试前端页面
1. 打开浏览器访问：`https://physics-visual.pages.dev`
2. 在"题目描述"框中输入：`一个物体从静止开始自由下落5秒`
3. 点击"从文字解析参数"按钮
4. 应该看到：
   - 题型自动切换到"匀变速直线运动"
   - 参数自动填充：初始速度=0, 加速度=10, 时间=5
   - 成功提示：`✓ 已识别为【匀变速直线运动】默认为自由落体（匀变速直线运动）。`

---

## 🔧 常见问题排查

### 问题 1: Worker 部署后仍返回旧格式
**解决方案**：
```powershell
cd backend\worker
wrangler deploy --force
```

### 问题 2: Pages 显示旧版本
**解决方案**：
1. 等待 1-2 分钟让 CDN 缓存更新
2. 强制刷新浏览器（Ctrl + Shift + R）
3. 或者在 Cloudflare Dashboard 清除缓存

### 问题 3: 仍然显示"解析失败"
**检查清单**：
1. 确认 Worker 已成功部署（使用上面的 PowerShell 测试命令）
2. 打开浏览器开发者工具（F12）→ Network 标签
3. 点击"从文字解析参数"并查看网络请求：
   - 请求 URL 应该是 `https://physics-visual-worker.yywf08125.workers.dev/api/parse-problem`
   - 状态码应该是 200
   - 响应应该包含 `"success": true`
4. 检查 Console 标签是否有错误信息

### 问题 4: CORS 错误
**原因**：Worker 的 CORS 头已配置，但如果出现问题：
1. 确认 `backend/worker/index.js` 中的 `corsHeaders()` 函数存在
2. 重新部署 Worker

---

## 📝 文件变更摘要

### 修改的文件：
1. **backend/worker/index.js**
   - 修改返回格式从 `{ok, raw, parsed}` 到 `{success, type, params, reasoning}`
   - 更新 mock 函数参数名称（`g` → `a`，添加 `v0`）
   - 改进中文提示信息

2. **index1.0.3.html**
   - 改进错误处理逻辑（区分本地/云端）
   - 已复制到 `dist/index.html`

### 配置文件：
- `backend/worker/wrangler.toml` - 无需修改
- `.gitignore` - 建议添加以下内容（如果还没有）：
  ```
  node_modules/
  .wrangler/
  .dev.vars
  dist/.DS_Store
  ```

---

## 🎯 下一步建议

1. **设置自动部署**：
   - 在 Cloudflare Pages 中连接 GitHub 仓库
   - 每次 push 到 master 分支时自动部署

2. **监控和日志**：
   - 在 Cloudflare Dashboard 查看 Worker 日志
   - 监控 API 调用次数和错误率

3. **优化**：
   - 考虑添加请求缓存
   - 添加更多的错误类型判断
   - 改进 AI 提示词以提高解析准确率

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. Git 是否正确推送（`git log` 查看最新提交）
2. Cloudflare 账户权限
3. Worker 和 Pages 的部署日志

**快速诊断命令**：
```powershell
# 检查 Git 状态
git status
git log -1

# 检查 Worker 状态
cd backend\worker
wrangler whoami
wrangler deployments list

# 检查 Pages 部署
cd ..\..
wrangler pages deployments list --project-name=physics-visual
```

---

**最后更新**: 2025年10月20日
